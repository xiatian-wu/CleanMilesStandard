---
title: " CMS Project-- Analysis of 2019 CA Ridehailing Data from 4 MPOs"
author: "Summer Wu"
date: "Aug 24th, 2020"
output: html_document
---

# Package

```{r, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
# library(dplyr)
library(ggplot2)
library(tidyverse)
options(scipen = 999)

```

# Loading Dataset
```{r}

#### view objects in current workspace 
# ls()
#### clear workspace
# rm(list=ls())

#### Working Directary
# setwd(paste0(here(),"/03_lca_model/02_with covariates"))
# getwd()
# path_model <- paste0(here(),"/03_lca_model/02_with covariates")
# path_prj <- here()

#### read file ####

mpos4_day = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_day.csv",colClasses = c('hh_id'='character','person_id'='character'),header=TRUE))
mpos4_hh = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_hh.csv",colClasses = c('hh_id'='character'),header=TRUE))
mpos4_per = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_per.csv",colClasses = c('hh_id'='character','person_id'='character'),header=TRUE))
# mpos4_veh = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_veh.csv",colClasses = c('hh_id'='character'),header=TRUE))
mpos4_trip = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_trip.csv",colClasses = c('hh_id'='character','person_id'='character', 'trip_id'='character'),header=TRUE))

```


```{r}
# mpos4_trip = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_trip.csv",colClasses = c('hh_id'='character','person_id'='character', 'trip_id'='character'),header=TRUE))
# 
# ca_trip<-read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/CA_NHTS_addon/nhts17_caltrans_tsdc_download/survey_data/survey_trips.csv")
```

# Apply Weights
```{r, using complete 7-day weights for 4 MPOs}
mpos4_hh$WEIGHT_HH<-ifelse(mpos4_hh$region %in% c("MTC/SFCTA","SANDAG","SCAG"),mpos4_hh$wt_alladult_7day,mpos4_hh$wt_hh_final)
mpos4_per$WEIGHT_PER<-ifelse(mpos4_per$region %in% c("MTC/SFCTA","SANDAG","SCAG"),mpos4_per$wt_alladult_7day,mpos4_per$wt_person_final)
mpos4_per$WEIGHT_HH<-ifelse(mpos4_per$region %in% c("MTC/SFCTA","SANDAG","SCAG"),mpos4_per$wt_alladult_7day,mpos4_per$wt_person_final)
mpos4_day$WEIGHT_DAY<- ifelse(mpos4_day$region %in% c("MTC/SFCTA","SANDAG","SCAG"),mpos4_day$daywt_alladult_7day,mpos4_day$hh_weight_day)
mpos4_trip$WEIGHT_TRIP<- ifelse(mpos4_trip$region %in% c("MTC/SFCTA","SANDAG","SCAG"),mpos4_trip$daywt_alladult_7day,mpos4_trip$trip_weight_7day)

```







# Filter out sample

## How many survey days
```{r, message=F}
survey_day<-mpos4_trip %>% 
  group_by(person_id,day_num) %>% 
  summarise(num_trip=n()) %>%
  distinct(person_id,day_num) %>% 
  group_by(person_id) %>% 
  summarise(n=n()) %>%
  distinct(person_id,n) %>%
  merge(mpos4_per[,c("person_id","region")],by="person_id",all.x=T) %>%
  group_by(n,region) %>% 
  summarise(num_person=n())

day<- survey_day %>%
  pivot_wider(names_from = region, values_from = c(num_person))
  
  
```

## Sub-sample
### Seven-day sample
```{r,message=F}
pop<-mpos4_trip %>% 
  group_by(person_id,day_num) %>% 
  summarise(num_trip=n()) %>%
  distinct(person_id,day_num) %>% 
  group_by(person_id) %>% 
  summarise(n=n()) %>%
  distinct(person_id,n) %>%
  subset(n>=7) %>% 
  merge(mpos4_per,by="person_id")
```
### Commuters ( employee)
```{r}
# table(mpos4_per$student)
# summary(mpos4_per$student)
# table(mpos4_per$num_jobs)
# summary(mpos4_per$num_jobs)

##  'for-hire' drivers removed (n=126)

# table(pop$share_work_drive_tnc)
# table(pop$share_work_deliver_packages)
# table(pop$share_work_deliver_food)
# table(pop$share_work_redistribute_bicycles)
# table(pop$share_work_redistribute_scooters)
# table(pop$num_jobs)
# table(pop$job_type)

pop_remove_share_work<-pop %>%
  filter((share_work_drive_tnc==1 |
          share_work_deliver_packages == 1 |
          share_work_deliver_food ==1 |
          share_work_redistribute_bicycles == 1 |
          share_work_redistribute_scooters ==1)) %>%
  pull(person_id)


pop_remove_non_stud_emp<-pop %>%
  # filter(student==0) %>% 
  filter(num_jobs<=0 | num_jobs>100) %>%
  pull(person_id)

# among those student/employee

pop_remove_non_commute<-pop %>%
  # filter(student==0) %>%
  filter((job_type==3)) %>%
  pull(person_id)

pop_remove_driver<-pop %>%
  # filter(student==0) %>%
  filter((job_type==4)) %>%
  pull(person_id)

  
'%notin%'<-Negate('%in%')
pop_7days<-pop %>% 
  filter(person_id %notin% c(pop_remove_non_stud_emp,pop_remove_non_commute,pop_remove_share_work,pop_remove_driver))

# table(pop_7days$num_jobs)
# table(pop_7days$job_type)

# remove testing days
trip_7days<-mpos4_trip %>% 
  filter(person_id %in% pop_7days$person_id) %>% 
  filter(day_num>0)

```


# Create Indicators
## Recode mode 
```{r, message=F}
library(plyr)
# table(trip_7days$mode_recode)
# table(trip_7days$mode_type)
# table(trip_7days$mode_type_imputed)
# table(trip_7days$driver)

# 1- walk 2-bike 3-car 5-transit 7-other 9-tnc

trip_7days$mode_type_imputed_less<-
ifelse(trip_7days$mode_type_imputed==11 | trip_7days$mode_type_imputed==12,2,
       ifelse(trip_7days$mode_type_imputed==6,7,
              ifelse(trip_7days$mode_type_imputed==4 | trip_7days$mode_type_imputed==10 | trip_7days$mode_type_imputed==8,3,
                     ifelse(trip_7days$mode_type_imputed==13 & trip_7days$mode_1==31,7,
                            ifelse((trip_7days$mode_type_imputed==13 & trip_7days$mode_1==25) | (trip_7days$mode_type_imputed==13 & trip_7days$mode_1==41),5,
                                   ifelse(trip_7days$mode_type_imputed==13,7,
                            trip_7days$mode_type_imputed))))))
trip_7days$mode_type_imputed_less<-revalue(as.character(trip_7days$mode_type_imputed_less), c("1"="w","2"="b","3"="car","5"="pt","7"="tnc","9"="o"))

# table(trip_7days$mode_type)

trip_7days$mode_type<-revalue(as.character(trip_7days$mode_1), c("1"="w","2"="b","3"="b","4"="b","5"="o","6"="car","7"="car","8"="car","9"="car","10"="car","11"="car","12"="car","16"="car","17"="car","18"="car","21"="car","22"="car","23"="car","24"="o","25"="pt","26"="o","27"="pt","28"="pt","30"="pt","31"="o","32"="pt","33"="car","34"="car","36"="car","37"="tnc","38"="o","39"="pt","41"="pt","42"="pt","43"="b","44"="o","45"="o","46"="pt","47"="car","49"="tnc","55"="pt","59"="car","60"="car","61"="pt","62"="o","63"="o","64"="tnc","65"="tnc","66"="tnc","67"="pt","68"="pt","69"="b","70"="b","71"="b","73"="b","74"="b","75"="b","76"="car","77"="b","997"="o"))
detach(package:plyr)

trip_7days$mode_type<-ifelse(is.na(trip_7days$mode_type),"-9998",trip_7days$mode_type)

trip_7days$mode_type<-ifelse(trip_7days$mode_type=="-9998" & (trip_7days$mode_type_imputed_less!="-9998"& !is.na(trip_7days$mode_type_imputed_less)) , trip_7days$mode_type_imputed_less, trip_7days$mode_type)

# table(trip_7days$mode_type)
# unique(trip_7days$mode_type)
# summary(trip_7days$num_travelers)

# 1- walk 2-bike 3-SOV (including SOV taxi) 4-carpool/carshare/vanpool(including HOV taxi) 5-transit 6-tnc 7-other

trip_7days$mode_final<-ifelse((trip_7days$mode_type=="car" & trip_7days$num_travelers==1) | (trip_7days$mode_type=="car" &trip_7days$num_travelers==0),"sov",
                              ifelse(trip_7days$mode_type=="car" & trip_7days$num_travelers>1,"hov",
                                     ifelse(trip_7days$mode_type=="car" & trip_7days$num_travelers<0,"-9998",trip_7days$mode_type)))

# table(trip_7days$mode_final)
# table(trip_7days$mode_type)
# summary(trip_7days$mode_final)
```

## Recode d_purpose
```{r}
# table(trip_7days$d_purpose_category_imputed)

trip_7days$d_purpcat_final<-ifelse(trip_7days$d_purpose_category_imputed==2| trip_7days$d_purpose_category_imputed==3 | trip_7days$d_purpose_category_imputed==4,1,
                                   ifelse(trip_7days$d_purpose_category_imputed<0,-1,0))

# table(trip_7days$d_purpcat_final)
# unique(trip_7days$d_purpcat_final)
```

## Count weekly trip by mode by d_purpose by person
```{r, message=F}
wktrip_mode_purp<-trip_7days %>% 
  merge(mpos4_per, by="person_id") %>% 
  group_by(person_id,mode_final,d_purpcat_final) %>%
  summarise(num_weektrip=as.numeric(n())) %>% 
  filter(mode_final !="-9998" & d_purpcat_final !=-1)

## identify and remove outliers for each mode-purpose combination (with 99th percentile) (n=228)

num_weektrip_quan<-wktrip_mode_purp %>% 
  group_by(mode_final,d_purpcat_final) %>% 
  summarise(num_weektrip_quan= quantile(num_weektrip,c(0.90, 0.95, 0.99)), quan=c(0.90, 0.95, 0.99)) %>% 
  filter(quan==0.99)


pop_remove<-wktrip_mode_purp %>%
  merge(num_weektrip_quan, by=c("mode_final","d_purpcat_final"), all.x = T) %>% 
  filter(num_weektrip>num_weektrip_quan) %>%
  pull(unique(person_id))

'%notin%' <- Negate('%in%')
wktrip_mode_purp<-wktrip_mode_purp %>%
  filter(person_id %notin% pop_remove)
pop_7days<-pop_7days %>% 
  filter(person_id %notin% pop_remove)

wktrip_mode_purp$mode_final = factor(wktrip_mode_purp$mode_final, levels=c('sov','hov','pt','tnc','b','w','o'))
levels(wktrip_mode_purp$mode_final)<-list('SOV'='sov','Carpool'='hov','Transit'='pt','TNC'='tnc','Biking'='b','Walking'='w','Other'='o')

wktrip_mode_purp$d_purpcat_final = factor(wktrip_mode_purp$d_purpcat_final, levels=c('1','0'))
levels(wktrip_mode_purp$d_purpcat_final)<-list('Commuting'='1','Non-commuting'='0')
```

### Mode-purpose histgorm
#### Non-zero
```{r}
wktrip_mode_purp_plot<-ggplot(wktrip_mode_purp, aes(x=num_weektrip)) +
  geom_histogram(bins = 81)+
  facet_grid(rows=vars(wktrip_mode_purp$d_purpcat_final),cols=vars(wktrip_mode_purp$mode_final))+
   scale_x_continuous(breaks = seq(0,40,10))+
  # geom_vline(data=mu, aes(xintercept=grp.mean),
             # linetype="dashed")+
  labs(x="Number of Weekly Trips by Mode", y="Number of Observations") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 9), 
    axis.text.y=element_text(colour="black", size = 9),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    panel.grid.major = element_line(colour = "#d3d3d3"),
    panel.grid.minor = (element_blank()), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("wktrip_mode_purp_plot.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Image_Output",
  scale = 1,
  width = 8,
  height = 5,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)
```
#### Zero
```{r}
## Adding zero
person_id<-wktrip_mode_purp %>% 
  pull(person_id) %>% 
  unique() %>% 
  as.data.frame()
person_id_complete<-person_id[rep(seq_len(nrow(person_id)), each = 14), ] %>% 
  as.data.frame() %>%
  rename("person_id"=".")

mode_final_complete<-data.frame(rep(c('SOV','Carpool','Transit','TNC','Biking','Walking','Other'),each=2,times=length(unique(person_id_complete$person_id))))

d_purpcat_final_complete<-as.data.frame(rep(c("Commuting","Non-commuting"),each=1,times=7*length(unique(person_id_complete$person_id))))

wktrip_mode_purp_complete<-cbind(person_id_complete,mode_final_complete,d_purpcat_final_complete) %>% 
  `colnames<-`(c("person_id","mode_final","d_purpcat_final")) %>% 
  merge(wktrip_mode_purp, by=c("person_id","mode_final","d_purpcat_final"),all.x=T) 
  
wktrip_mode_purp_complete$num_weektrip[is.na(wktrip_mode_purp_complete$num_weektrip)]<-0


levels(wktrip_mode_purp_complete$mode_final)<-list('SOV','Carpool','Transit','TNC','Biking','Walking','Other')

wktrip_mode_purp_plot_withzero<-ggplot(wktrip_mode_purp_complete, aes(x=num_weektrip)) +
  geom_histogram(bins = 81)+
  facet_grid(rows=vars(wktrip_mode_purp_complete$d_purpcat_final),cols=vars(wktrip_mode_purp_complete$mode_final))+
   scale_x_continuous(breaks = seq(0,40,10))+
  # geom_vline(data=mu, aes(xintercept=grp.mean),
             # linetype="dashed")+
  labs(x="Number of Weekly Trips by Mode", y="Number of Observations") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 9), 
    axis.text.y=element_text(colour="black", size = 9),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    panel.grid.major = element_line(colour = "#d3d3d3"),
    panel.grid.minor = (element_blank()), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("wktrip_mode_purp_plot_withzero.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Image_Output",
  scale = 1,
  width = 8,
  height = 5,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)
```


### Commute vs. non-commute
```{r}
## Adding zero
person_id<-wktrip_mode_purp %>% 
  pull(person_id) %>% 
  unique() %>% 
  as.data.frame()
person_id_complete<-person_id[rep(seq_len(nrow(person_id)), each = 14), ] %>% 
  as.data.frame() %>%
  rename("person_id"=".")

mode_final_complete<-data.frame(rep(c('SOV','Carpool','Transit','TNC','Biking','Walking','Other'),each=2,times=length(unique(person_id_complete$person_id))))

d_purpcat_final_complete<-as.data.frame(rep(c("Commuting","Non-commuting"),each=1,times=7*length(unique(person_id_complete$person_id))))

wktrip_mode_purp_complete<-cbind(person_id_complete,mode_final_complete,d_purpcat_final_complete) %>% 
  `colnames<-`(c("person_id","mode_final","d_purpcat_final")) %>% 
  merge(wktrip_mode_purp, by=c("person_id","mode_final","d_purpcat_final"),all.x=T) 
  
wktrip_mode_purp_complete$num_weektrip[is.na(wktrip_mode_purp_complete$num_weektrip)]<-0

pivot_wide<-wktrip_mode_purp_complete %>% 
  pivot_wider(id_cols=c(person_id,mode_final),names_from =d_purpcat_final,values_from=num_weektrip, values_fill=0)

pivot_wide$mode_final = factor(pivot_wide$mode_final, levels=c('SOV','Carpool','Transit','TNC','Biking','Walking','Other'))
# levels(pivot_wide$mode_final)<-list('SOV','Carpool','Transit','TNC','Biking','Walking','Other')

wktrip_mode_purp_person<-ggplot(pivot_wide,aes(x=Commuting,y=`Non-commuting`)) +
  # geom_point(size=0.01)
  geom_jitter(size=0.05)+
  facet_grid(cols=vars(pivot_wide$mode_final))+
  scale_x_continuous(breaks = seq(0,40,10))+
  scale_y_continuous(breaks = seq(0,40,10))+
  # geom_vline(data=mu, aes(xintercept=grp.mean),
             # linetype="dashed")+
  labs(x="Weekly Commuting Trips", y="Weekly Non-commuting Trips") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 9), 
    axis.text.y=element_text(colour="black", size = 9),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    panel.grid.major = element_line(colour = "#d3d3d3"),
    panel.grid.minor = (element_blank()), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("wktrip_mode_purp_person.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Image_Output",
  scale = 1,
  width = 8,
  height = 2.7,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)
```





# Merge(wktrip) with (pop_7days)
```{r, message=F}

wktrip_mode_purp_wide<-wktrip_mode_purp %>% 
  pivot_wider(id_cols = person_id,
              names_from = c(mode_final,d_purpcat_final),
        values_from = num_weektrip,
        names_glue = "wktrip_{mode_final}_{d_purpcat_final}") %>% 
  mutate_all(funs(ifelse(is.na(.), 0, .)))


pop_7days<-pop_7days %>% 
  merge(wktrip_mode_purp_wide,by="person_id",all.x = T)

pop_7days1<-pop_7days

```

# Socio-Demographics

## TNC user groups
```{r}
## Based on self-reported monthly frequency
# table(pop_7days$tnc_freq)
# summary(pop_7days$tnc_freq)

pop_7days$tnc_user<-ifelse(pop_7days$tnc_freq==0 |pop_7days$tnc_freq>=8,0,
                           ifelse(pop_7days$tnc_freq==6 | pop_7days$tnc_freq==7,1,2))

# table(pop_7days$tnc_user)
```

## Population
```{r, message=F}
num<-pop_7days %>%
  mutate(variable=1) %>%
  group_by(tnc_user,variable) %>%
  summarise(Count=n())%>%
  group_by(variable) %>% 
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop")

num_pop<-pop_7days %>%
  mutate(variable=1) %>%
  group_by(variable) %>%
  summarise(Count=n())%>%
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop",tnc_user=3)
num_total<-rbind(num, num_pop)
```

## Race/Ethenicity 
Since ethnicity was collected via a “select-all-that-apply” style question, following is the priority to the categorization

1-White 
2-Black or African American
3-Asian, Native Hawaiian or other Pacific Islander
4-Hispanic, Latino, or Spanish origin
5-Other (Middle Eastern,American Indian or Alaska Native1 Middle Eastern, Other race, ethnicity, or origin)
```{r,message=F}
# Race
pop_7days$ethnicity_recode<- ifelse(pop_7days$ethnicity_hisp==1,1, ifelse(pop_7days$ethnicity_af_am==1,2, ifelse(pop_7days$ethnicity_asian==1 | pop_7days$ethnicity_hapi==1,3, ifelse(pop_7days$ethnicity_white==1,4,
ifelse (pop_7days$ethnicity_other==1 | pop_7days$ethnicity_multi==1 | pop_7days$ethnicity_aiak==1,5,-1)))))
# table(pop_7days$ethnicity_recode)
pop_7days$raceeth_imputed<-dplyr::recode(pop_7days$raceeth_imputed, `1` = 4L, `4` = 1L)

pop_7days$raceeth_new_imputed<-ifelse(is.na(pop_7days$raceeth_new_imputed) & !is.na(pop_7days$raceeth_imputed), pop_7days$raceeth_imputed,pop_7days$raceeth_new_imputed)

pop_7days$ethnicity_recode<-ifelse(pop_7days$ethnicity_recode==-1 & !is.na(pop_7days$raceeth_new_imputed),pop_7days$raceeth_new_imputed,
                                   ifelse(pop_7days$ethnicity_recode==5 & pop_7days$raceeth_new_imputed %between% c(1,4),pop_7days$raceeth_new_imputed,pop_7days$ethnicity_recode))


pop_7days$ethnicity_recode[pop_7days$ethnicity_recode==0| is.na(pop_7days$ethnicity_recode)]<--1

# a<-pop_7days %>%
#   select(ethnicity_recode,raceeth_imputed, raceeth_new, raceeth_new_imputed)

# table(pop_7days$raceeth_new_imputed)
# table(pop_7days$raceeth_imputed)
# summary(pop_7days$raceeth_imputed)
# table(pop_7days$ethnicity_recode)
# summary(pop_7days$ethnicity_recode)

```

## Age
1- 18-34
2- 35-54
3- 55-64
4- 65 or over
```{r}
pop_7days$age_final<-ifelse(pop_7days$age>=4 & pop_7days$age<=5,1, # 18-34
                         ifelse(pop_7days$age>=6 &pop_7days$age<=7,2, # 35-54
                        ifelse(pop_7days$age>=8 & pop_7days$age<9,3, # 55-64
                        ifelse(pop_7days$age>=9,4, -1)))) # 65

# table(pop_7days$age_final)
# summary(pop_7days$age_final)

```

## Gender
1-Female & other
2-Male
```{r}
# table(pop_7days$gender_final)
# summary(pop_7days$gender_final)
pop_7days$gender_final[pop_7days$gender_final==3]<-1

```

## Education
1- Some College or lower
2- Bachalor
3- Higher than Bachalor 
```{r}
# table(pop_7days$education)
pop_7days$education_recode<-ifelse(pop_7days$education %in% c(1,2,3,4,5),1,
                      ifelse(pop_7days$education %in% c(6),2,
               ifelse( pop_7days$education %in% c(7),3,-1)))
# table(pop_7days$education_recode)
```
## Student/Employment Status
1-student only
2-employed only
3-both

```{r}
# # table(pop_7days$student)
# # table(pop_7days$num_jobs)
# # table(pop_7days$student,pop_7days$num_jobs)
# 
# pop_7days$studemp<-ifelse(pop_7days$student==0,2,ifelse(pop_7days$num_jobs<=0 | pop_7days$num_jobs==995,1,3))
# table(pop_7days$studemp)
               
```

## Employment Type
1	Employed full-time (paid)
2	Employed part-time (paid)
3	Other (Primarily self-employed,Unpaid volunteer or intern)

```{r}
# table(pop_7days$employment,pop_7days$region)
# summary(pop_7days$employment)
pop_7days$employment<-dplyr::recode(pop_7days$employment, `7` = 3L, `8` = 3L,`9`=3L)

```


## Home Ownership
1- rent or other 
2- own
```{r}
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","rent_own")],by="hh_id")
# table(pop_7days$rent_own)
# summary(pop_7days$rent_own)
pop_7days$houseown<-ifelse(pop_7days$rent_own==1,2,
                                 ifelse(pop_7days$rent_own==2 |pop_7days$rent_own==3 |pop_7days$rent_own==997,1,-1))
# table(pop_7days$houseown)

```

## Housing Type
1- other (appartment) 
2- single family house/ town house
```{r}
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","res_type")],by="hh_id")
# table(pop_7days$res_type)
# summary(pop_7days$res_type)
pop_7days$housetype<-ifelse(pop_7days$res_type==1 | pop_7days$res_type==2,2,
                                 ifelse(pop_7days$res_type %between% c(3,7),1,-1))
# table(pop_7days$housetype)


```

## HH Income

1 2560.00	32200.00
2 32200.00	59700.00
3 59700.00	85300.00
4 85300.00	169000.00
```{r}
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","income_adjusted_category")],by="hh_id")

# table(pop_7days$income_adjusted_category)
```


## Presence of children
1- no
2- yes
```{r}
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","num_hh_members_age_18_to_34","num_hh_members_age_35_to_64",
"num_hh_members_age_65_to_74","num_hh_members_age_75_plus","num_people","numkids")],by="hh_id")

# table(pop_7days$numkids)
# summary(pop_7days$numkids)
# summary(pop_7days$num_people)
pop_7days$numkids<-ifelse(pop_7days$region %in% c("MTC/SFCTA","SANDAG","SCAG"), pop_7days$num_people-pop_7days$num_hh_members_age_18_to_34-pop_7days$num_hh_members_age_35_to_64-pop_7days$num_hh_members_age_65_to_74-pop_7days$num_hh_members_age_75_plus, pop_7days$numkids)

pop_7days$hhkid<-ifelse(pop_7days$numkids==0,1,2)

```

# Mobility-related Condition
## Driver License
```{r}
# table(pop_7days$license)
# summary(pop_7days$license)
```


## HH Vehicle/ num-worker (change 0 to 1)
```{r}
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","num_vehicles","num_workers","num_students")],by="hh_id")

# table(pop_7days$num_vehicles)
# summary(pop_7days$num_vehicles)
# table(pop_7days$num_workers)
# summary(pop_7days$num_workers)

pop_7days$num_workers[pop_7days$num_workers==0]<-1
pop_7days$hhveh_worker<-ifelse(pop_7days$num_vehicles==995,-1,pop_7days$num_vehicles/pop_7days$num_workers)


# ggplot_veh<-ggplot(fre_perc_large, aes(x = reorder(mode, -perc), y=perc))+ 
#    geom_bar(stat="identity",colour="black", size=.2, alpha=1
#              ,width=0.6, position = position_dodge(width=0.7)) +
#   ylim(0, 80)+
#   scale_fill_brewer(palette="Greys")+
#   scale_x_discrete(limits=c(c("3","13","1","5","36","2","35","23","15","135","4")),
#     labels=c("Car\nOnly","Car+\nWalk","Walk\nOnly","Transit\nOnly","Car+\nOther","Bike\nOnly","Car+\nTransit","Car+\nBike","Transit+\nWalk","Car+\nTransit+\nWalk","TNC\nRelated"))+
#   geom_text(aes(label=Frequency), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
#   geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-1.5,family = "Times") +
#   labs(x="Panel 1: Modes in All Daily Trip Chain", y="Mode Share (%)") +
#   # ggtitle("Composition of Exports to China ($)") + 
#   # scale_fill_manual(values=fill) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 14), 
#     axis.text.y=element_text(colour="black", size = 14),
#     axis.title=element_text(colour="black", size = 14),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="right", legend.direction="vertical", 
#     legend.title = element_blank(),
#     legend.text = element_text(colour="black", size = 14),
#     # panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     text=element_text(family="Times")) +
#   guides(fill = guide_legend(reverse=T))
# 

```

## Commute_subsidy (should only apply to commute trips)
### TNC
0- no
1- yes
```{r}
pop_7days$commute_subsidy_offers_tnc [pop_7days$commute_subsidy_offers_tnc==995]<-0

# summary(pop_7days$commute_subsidy_offers_tnc)
```

### Transit
0- no
1- yes
```{r}
pop_7days$commute_subsidy_offers_transit [pop_7days$commute_subsidy_offers_transit==995]<-0

# table(pop_7days$commute_subsidy_offers_transit)
# summary(pop_7days$commute_subsidy_offers_transit)

```

### Carpool/Vanpool/walking/ biking
0- no
1- yes
```{r}
pop_7days$commute_subsidy_offers_vanpool [pop_7days$commute_subsidy_offers_vanpool==995]<-0

pop_7days$commute_subsidy_offers_shuttle [pop_7days$commute_subsidy_offers_shuttle==995]<-0

pop_7days$commute_subsidy_offers_bike_maint [pop_7days$commute_subsidy_offers_bike_maint==995]<-0

pop_7days$commute_subsidy_offers_bikeshare [pop_7days$commute_subsidy_offers_bikeshare==995]<-0

pop_7days$commute_subsidy_offers_carshare [pop_7days$commute_subsidy_offers_carshare==995]<-0
# summary(pop_7days$commute_subsidy_offers_carshare)

pop_7days$commute_subsidy_offers_other<-ifelse(pop_7days$region %in% c("MTC/SFCTA","SANDAG","SCAG") & (pop_7days$commute_subsidy_offers_vanpool==1 | pop_7days$commute_subsidy_offers_shuttle==1 | pop_7days$commute_subsidy_offers_bike_maint==1| pop_7days$commute_subsidy_offers_bikeshare==1| pop_7days$commute_subsidy_offers_carshare==1),1,ifelse(pop_7days$region %in% c("MTC/SFCTA","SANDAG","SCAG") & (pop_7days$commute_subsidy_offers_vanpool==0 & pop_7days$commute_subsidy_offers_shuttle==0 & pop_7days$commute_subsidy_offers_bike_maint==0 & pop_7days$commute_subsidy_offers_bikeshare==0 & pop_7days$commute_subsidy_offers_carshare==0),0,ifelse(pop_7days$region=="SACOG",pop_7days$commute_subsidy_incentives_offers,-1)))

# table(pop_7days$commute_subsidy_offers_other)
```

## Transit Pass
1- no
2- yes
```{r}
# # table(pop_7days$commute_subsidy_uses_transit)
# # summary(pop_7days$commute_subsidy_uses_transit)
# pop_7days$commute_subsidy_uses_transit[pop_7days$commute_subsidy_uses_transit==995]<-0
# 
# pop_7days$commute_subsidy_uses_transit<-dplyr::recode(pop_7days$commute_subsidy_uses_transit,  `0` = 1L,`1` = 2L)
```

# Travel Pattern & Mobility Choice
## Telecommute per week (self-reported)
```{r}
# table(pop_7days$telework_freq,pop_7days$region)
# summary(pop_7days$telework_freq)
pop_7days$telework_freq[pop_7days$region=="SACOG" & pop_7days$telework_freq>=6]<-pop_7days$telework_freq[pop_7days$region=="SACOG" & pop_7days$telework_freq>=6]-1

pop_7days$telework_freq<-case_when(
  pop_7days$telework_freq == 1 ~ 6.5,
  pop_7days$telework_freq == 2 ~ 5,
  pop_7days$telework_freq == 3 ~ 4,
  pop_7days$telework_freq == 4 ~ 2.5,
  pop_7days$telework_freq == 5 ~ 1,
  pop_7days$telework_freq == 6 ~ 0.5,
  pop_7days$telework_freq == 7 ~ 0.25,
  pop_7days$telework_freq == 8 ~ 0,
)
```


# Built Environment
```{r,message=F}

be = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/BE_Variables/CA_bg_census.csv",colClasses = c('GEOID'='numeric'),header=TRUE))

library("readxl")
sacog_bg_taz1<-setDT(read_excel("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/CMS_SAOOG_bg_taz.xlsx")) %>% select(GEOID,TAZ07)

sacog_bg_taz1$GEOID<-as.numeric(sacog_bg_taz1$GEOID)
sacog_taz1<-sacog_bg_taz1 %>% 
  merge(be, by="GEOID",all.x = T) %>%
  group_by(TAZ07) %>%
  summarise(totalpop=sum(totalpop),totaljob=sum(totaljob),area_sqmi=sum(area_sqmi)) %>%
  mutate(taz_popdensity=totalpop/area_sqmi,taz_jobdensity=totaljob/area_sqmi)

sacog_bg_taz2<-setDT(read_excel("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/taz_bg_Intersect.xlsx")%>% select(GEOID,TAZ07)%>% filter(!TAZ07 %in% sacog_taz1$TAZ07))

sacog_bg_taz2$GEOID<-as.numeric(sacog_bg_taz2$GEOID)
sacog_taz2<-sacog_bg_taz2  %>% 
  merge(be,by ="GEOID") %>%
  group_by(TAZ07) %>%
  summarise(totalpop=sum(totalpop),totaljob=sum(totaljob),area_sqmi=sum(area_sqmi)) %>%
  mutate(taz_popdensity=totalpop/area_sqmi,taz_jobdensity=totaljob/area_sqmi)

sacog_taz<-rbind(sacog_taz1[,c("TAZ07","taz_popdensity","taz_jobdensity")],sacog_taz2[,c("TAZ07","taz_popdensity","taz_jobdensity")])



```


## Pop/Job Density
### Home &Work Location (SACOG only in TAZ)
```{r}
pop_7days<-pop_7days %>% 
  merge(mpos4_hh[,c("hh_id","home_bg_geoid")],by="hh_id") %>%
  merge(be[,c("GEOID","popdensity","jobdensity")],by.x="home_bg_geoid",by.y ="GEOID",all.x = T) %>%
  rename(home_popdensity = popdensity,home_jobdensity=jobdensity) 

## work location

pop_7days$work_bg_geo_id<-as.numeric(pop_7days$work_bg_geo_id)
pop_7days<-pop_7days %>%
  merge(be[,c("GEOID","popdensity","jobdensity")],by.x="work_bg_geo_id",by.y ="GEOID",all.x = T) %>%
  merge(sacog_taz[,c("TAZ07","taz_popdensity","taz_jobdensity")], by.x = "work_taz",by.y="TAZ07",all.x = T) %>%
  rename(work_popdensity = popdensity,work_jobdensity=jobdensity)

# summary(pop_7days$taz_popdensity[pop_7days$region=="SACOG"])

pop_7days$work_popdensity[pop_7days$region=="SACOG"]<-pop_7days$taz_popdensity[pop_7days$region=="SACOG"]
pop_7days$work_jobdensity[pop_7days$region=="SACOG"]<-pop_7days$taz_jobdensity[pop_7days$region=="SACOG"]

# Check distribution (correlation around 0.5)

# var(pop_7days$home_popdensity)
# hist(pop_7days$home_popdensity)
# var(log10(pop_7days$home_popdensity))
# hist(log10(pop_7days$home_popdensity))
# summary(log10(pop_7days$home_popdensity))
# 
# cor(log10(pop_7days$home_popdensity),log10(pop_7days$home_jobdensity))
# cor(log10(pop_7days$work_popdensity[pop_7days$work_popdensity>0]),log10(pop_7days$work_jobdensity[pop_7days$work_jobdensity>0]))
# a<-log10(pop_7days$work_popdensity[!is.na(pop_7days$work_popdensity) & !is.na(pop_7days$work_jobdensity) & pop_7days$work_popdensity>0 & pop_7days$work_jobdensity>0])
# b<-log10(pop_7days$work_jobdensity[!is.na(pop_7days$work_popdensity) & !is.na(pop_7days$work_jobdensity)& pop_7days$work_popdensity>0 & pop_7days$work_jobdensity>0])
# cor(a,b)
# 
# a<-pop_7days$work_popdensity[!is.na(pop_7days$work_popdensity) & !is.na(pop_7days$work_jobdensity) & pop_7days$work_popdensity>0 & pop_7days$work_jobdensity>0]
# b<-pop_7days$work_jobdensity[!is.na(pop_7days$work_popdensity) & !is.na(pop_7days$work_jobdensity)& pop_7days$work_popdensity>0 & pop_7days$work_jobdensity>0]
# cor(a,b)
# 
# summary(a)
# summary(b)
# 
# var(pop_7days$work_popdensity, na.rm=T)
# hist(pop_7days$work_popdensity)
# var(log10(pop_7days$work_popdensity[!is.na(pop_7days$work_popdensity)]))
# length(pop_7days$work_popdensity[pop_7days$work_popdensity==0])
# hist(log10(pop_7days$work_popdensity[pop_7days$work_popdensity>0]))
# summary(log10(pop_7days$work_popdensity))
# 
# 
# cor(log10(pop_7days$home_popdensity),log10(pop_7days$home_jobdensity))

# group by quartile
pop_7days$home_popdensity<-ifelse(pop_7days$home_popdensity<quantile(be$popdensity,0.25,na.rm = T),1,
                                  ifelse(pop_7days$home_popdensity>=quantile(be$popdensity,0.25,na.rm = T) & pop_7days$home_popdensity<quantile(be$popdensity,0.5,na.rm = T),2,
                                         ifelse(pop_7days$home_popdensity>=quantile(be$popdensity,0.5,na.rm = T) & pop_7days$home_popdensity<quantile(be$popdensity,0.75,na.rm = T),3,4)))

pop_7days$home_jobdensity<-ifelse(pop_7days$home_jobdensity<quantile(be$jobdensity,0.25,na.rm = T),1,
                                  ifelse(pop_7days$home_jobdensity>=quantile(be$jobdensity,0.25,na.rm = T) & pop_7days$home_jobdensity<quantile(be$jobdensity,0.5,na.rm = T),2,
                                         ifelse(pop_7days$home_jobdensity>=quantile(be$jobdensity,0.5,na.rm = T) & pop_7days$home_jobdensity<quantile(be$jobdensity,0.75,na.rm = T),3,4)))


pop_7days$work_popdensity<-ifelse(pop_7days$work_popdensity<quantile(be$popdensity,0.25,na.rm = T),1,
                                  ifelse(pop_7days$work_popdensity>=quantile(be$popdensity,0.25,na.rm = T) & pop_7days$work_popdensity<quantile(be$popdensity,0.5,na.rm = T),2,
                                         ifelse(pop_7days$work_popdensity>=quantile(be$popdensity,0.5,na.rm = T) & pop_7days$work_popdensity<quantile(be$popdensity,0.75,na.rm = T),3,4)))


pop_7days$work_jobdensity<-ifelse(pop_7days$work_jobdensity<quantile(be$jobdensity,0.25,na.rm = T),1,
                                  ifelse(pop_7days$work_jobdensity>=quantile(be$jobdensity,0.25,na.rm = T) & pop_7days$work_jobdensity<quantile(be$jobdensity,0.5,na.rm = T),2,
                                         ifelse(pop_7days$work_jobdensity>=quantile(be$jobdensity,0.5,na.rm = T) & pop_7days$work_jobdensity<quantile(be$jobdensity,0.75,na.rm = T),3,4)))

# summary(pop_7days$home_popdensity)
# summary(pop_7days$home_jobdensity)
# summary(pop_7days$work_popdensity)
# summary(pop_7days$work_jobdensity)

```



# Discriptive Table
```{r}
# dt <- setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/mplus_withcolname.csv",colClasses = c('person_id'='character'),header=TRUE))
# 
# dt<-dt %>% 
#   merge (mpos4_per[,c("person_id","hh_id","region","tnc_user")], by="person_id")
# 
# write.table(dt,"mplus_withcolname.csv",sep=",",na = "",col.names = T, row.names = F)
```

```{r}
# Pop
num<-pop_7days %>%
  mutate(variable=1) %>%
  group_by(tnc_user,variable) %>%
  summarise(Count=n())%>%
  group_by(variable) %>% 
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop")

num_pop<-pop_7days %>%
  mutate(variable=1) %>%
  group_by(variable) %>%
  summarise(Count=n())%>%
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop",tnc_user=3)
num_total<-rbind(num, num_pop)

# Race/ Ethenicity
ethnicity<-pop_7days %>%
  subset(ethnicity_recode>0)%>%
  group_by(tnc_user,ethnicity_recode) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="ethnicity")
ethnicity_pop<-pop_7days %>%
  subset(ethnicity_recode>0)%>%
  group_by(ethnicity_recode) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="ethnicity",tnc_user=3)
ethnicity_total<-rbind(ethnicity,ethnicity_pop)

# Age
age<-pop_7days %>%
  group_by(tnc_user,age_final) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100,variable="age")
age_pop<-pop_7days %>%
  group_by(age_final) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100,variable="age",tnc_user=3)
age_total<-rbind(age,age_pop)

# Gender
gender<-pop_7days %>%
  subset(gender_final>0) %>%
  group_by(tnc_user,gender_final) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="gender")
gender_pop<-pop_7days %>%
  subset(gender_final>0) %>%
  group_by(gender_final) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="gender",tnc_user=3)
gender_total<-rbind(gender, gender_pop)

# Education
education<-pop_7days %>%
  subset(education_recode>0) %>%
  group_by(tnc_user,education_recode) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="education")

education_pop<-pop_7days %>%
  subset(education_recode>0) %>%
  group_by(education_recode) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="education",tnc_user=3)
education_total<-rbind(education, education_pop)

# Stu/Emp
studemp<-pop_7days %>%
  subset(studemp>0) %>%
  group_by(tnc_user,studemp) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="studemp")

studemp_pop<-pop_7days %>%
  subset(studemp>0) %>%
  group_by(studemp) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="studemp",tnc_user=3)
studemp_total<-rbind(studemp, studemp_pop)

# HH ownership
houseown<-pop_7days %>%
  subset(houseown>0) %>%
  group_by(tnc_user,houseown) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="houseown")

houseown_pop<-pop_7days %>%
  subset(houseown>0) %>%
  group_by(houseown) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="houseown",tnc_user=3)
houseown_total<-rbind(houseown, houseown_pop)

# HH Type
housetype<-pop_7days %>%
  subset(housetype>0) %>%
  group_by(tnc_user,housetype) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="housetype")

housetype_pop<-pop_7days %>%
  subset(housetype>0) %>%
  group_by(housetype) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="housetype",tnc_user=3)
housetype_total<-rbind(housetype, housetype_pop)

# HH Income
income<-pop_7days %>%
  subset(income_adjusted_category>0) %>%
  group_by(tnc_user,income_adjusted_category) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="income")

income_pop<-pop_7days %>%
  subset(income_adjusted_category>0) %>%
  group_by(income_adjusted_category) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="income",tnc_user=3)
income_total<-rbind(income, income_pop)

# Child
hhkid<-pop_7days %>%
  group_by(tnc_user,hhkid) %>%
  summarise(Count=n()) %>%
  group_by(tnc_user) %>%
  mutate(Percent = Count / sum(Count)*100, variable="hhkid")

hhkid_pop<-pop_7days %>%
  group_by(hhkid) %>%
  summarise(Count=n()) %>%
  mutate(Percent = Count / sum(Count)*100, variable="hhkid",tnc_user=3)
hhkid_total<-rbind(hhkid, hhkid_pop)

# Veh/Worker
hhveh_worker<-pop_7days %>%
  group_by(tnc_user) %>%
  summarise(n=n(),Percent =mean(hhveh_worker)) %>%
  mutate(variable="vehicle")

hhveh_worker_pop<-pop_7days %>%
  summarise(n=n(),Percent =mean(hhveh_worker)) %>%
  mutate(variable="vehicle",tnc_user=3)
hhveh_worker_total<-rbind(hhveh_worker, hhveh_worker_pop)

# Commute_subsidy

# Transit Pass
# Pop den
# Job den

### Overall Summary Table####
colnames(gender_total)[2]<-'category'
colnames(age_total)[2]<-'category'
colnames(ethnicity_total)[2]<-'category'
colnames(education_total)[2]<-'category'
colnames(income_total)[2]<-'category'
colnames(vehicle_total)[2]<-'category'
# colnames(modeshare1)[2]<-'category'
# colnames(geo)[1]<-'variable'
# modeshare1$category<-as.numeric(modeshare1$category)
# geo$variable<-as.numeric(as.factor(geo$variable))
summary_long<-rbind(num_total,gender_total,age_total,ethnicity_total,education_total,income_total,vehicle_total)
# summary_wide<-dcast(summary_long, variable+Percent~variable,sum)

library(XLConnect)
writeWorksheetToFile("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Results/R_results_4MPOs.xlsx", 
                 data = summary_long, 
                 sheet = "SDE", 
                 header = TRUE,
                 clearSheets = TRUE)


## chi-square of significance
chisq.test(table(mpos4_per$gender_final,mpos4_per$tnc_user_new),correct=FALSE)


```





# Inactive Covariates
## Other New Mobility Services
```{r}
# table(pop_7days$uses_carshare)
# summary(pop_7days$uses_carshare)
# table(pop_7days$uses_peer_rent)
# table(pop_7days$uses_bikeshare)
# table(pop_7days$uses_scootershare)
# summary(pop_7days$uses_mopedshare)
# summary(pop_7days$uses_tnc)

pop_7days$uses_carshare[is.na(pop_7days$uses_carshare)]<--9998
pop_7days$uses_peer_rent[is.na(pop_7days$uses_peer_rent)]<--9998
pop_7days$uses_bikeshare[is.na(pop_7days$uses_bikeshare)]<--9998
pop_7days$uses_scootershare[is.na(pop_7days$uses_scootershare)]<--9998
pop_7days$uses_mopedshare[is.na(pop_7days$uses_mopedshare)]<--9998
pop_7days$uses_tnc[is.na(pop_7days$uses_tnc)]<--9998

```

## AV (only 3MPOs)
```{r}
# table(pop_7days$av_use)
# table(pop_7days$av_own)
# table(pop_7days$av_future, pop_7days$region)
# 
# summary(pop_7days$av_use)
# summary(pop_7days$av_own)
# summary(pop_7days$av_future) 

pop_7days$av_use[is.na(pop_7days$av_use)| pop_7days$av_use>900]<--9998
pop_7days$av_own[is.na(pop_7days$av_own)| pop_7days$av_own>900]<--9998
pop_7days$av_future[is.na(pop_7days$av_future) | pop_7days$av_future>900]<--9998
```

## TNC AV (only 3MPOs)
Likelihood of choosing TNC AVs vs. traditional at varying years from now/discounted rate
```{r}
# summary(pop_7days$tnc_future)
# table(pop_7days$tnc_future_percent)
# table(pop_7days$tnc_future_years)
pop_7days$tnc_future[is.na(pop_7days$tnc_future)|pop_7days$tnc_future==995]<--9998
pop_7days$tnc_future_years[is.na(pop_7days$tnc_future_years)|pop_7days$tnc_future_years==995]<--9998
pop_7days$tnc_future_percent[is.na(pop_7days$tnc_future_percent)|pop_7days$tnc_future_percent==995]<--9998


```


# Dataset to Mplus
## Variable Subset
```{r}

# mplus<-pop_7days[,c(which( colnames(pop_7days)=="person_id"),which( colnames(pop_7days)=="wktrip_Carpool_Non-commuting"):ncol(pop_7days) )]
# summary(pop_7days[,c(250:ncol(pop_7days))])
mplus<-pop_7days %>% 
  select(person_id,
         region,
         wktrip_SOV_Commuting,`wktrip_SOV_Non-commuting`,
         wktrip_Carpool_Commuting,`wktrip_Carpool_Non-commuting`,
         wktrip_TNC_Commuting,`wktrip_TNC_Non-commuting`,
         wktrip_Transit_Commuting, `wktrip_Transit_Non-commuting`,
         wktrip_Biking_Commuting,`wktrip_Biking_Non-commuting`,
         wktrip_Walking_Commuting,`wktrip_Walking_Non-commuting`,
         wktrip_Other_Commuting,`wktrip_Other_Non-commuting`,
         
         race_ethnicity=ethnicity_recode,
         age=age_final,
         gender=gender_final,
         education=education_recode,
         employment,
         houseown,
         housetype,
         hhincome=income_adjusted_category,
         hhkid,
         hhveh_worker,
         license,
         telework_freq,

         subsidy_transit=commute_subsidy_offers_transit,
         subsidy_tnc=commute_subsidy_offers_tnc,
         subsidy_other=commute_subsidy_offers_other,
         
         home_popdensity,
         home_jobdensity,
         work_popdensity,
         work_jobdensity,
         
         tnc_user,
         uses_carshare,
         uses_peer_rent,
         uses_bikeshare,
         uses_scootershare,
         uses_mopedshare,
         uses_tnc,
         
         av_use,
         av_own,
         av_future,
         
         tnc_future,
         tnc_future_years,
         tnc_future_percent
         )
# summary(mplus)
mplus[mplus<0]<-NA

```
## Dummy Coding
```{r}
library(dummies)

library(fastDummies)

mplus[,c("race_ethnicity",
         "age",
         "gender",
         "education",
         "employment",
         "houseown",
         "housetype",
         "hhincome",
         "hhkid",
         "license",
         "subsidy_transit",
         "subsidy_tnc",
         "subsidy_other",
         "home_popdensity",
         "home_jobdensity",
         "work_popdensity",
         "work_jobdensity",
         "tnc_user")] <- lapply(mplus[,c("race_ethnicity",
         "age",
         "gender",
         "education",
         "employment",
         "houseown",
         "housetype",
         "hhincome",
         "hhkid",
         "license",
         "subsidy_transit",
         "subsidy_tnc",
         "subsidy_other",
         "home_popdensity",
         "home_jobdensity",
         "work_popdensity",
         "work_jobdensity",
         "tnc_user")] , factor)


mplus_dummy <- dummy_cols(mplus[,c(-1)],
                          remove_first_dummy = TRUE,
                          ignore_na= TRUE,
                          remove_selected_columns=TRUE)
mplus_dummy<-cbind(mplus[,1],mplus_dummy)
colnames(mplus_dummy)[1]<-"person_id"
mplus_dummy[is.na(mplus_dummy)]<-999

mplus_dummy_colname<-data.frame(colnames(mplus_dummy))

write.table(mplus,"mplus_withcolname.csv",sep=",",na = "",col.names = T, row.names = F)
write.table(mplus_dummy,"mplus_dummy.csv",sep=",",na = "",col.names = F, row.names = F)
write.table(mplus_dummy,"mplus_dummy_withcolname.csv",sep=",",na = "",col.names = T, row.names = F)
write.table(mplus_dummy_colname,"mplus_dummy_colname.csv",sep=",",na = "",col.names = F, row.names = F)

# summary(mplus_dummy)

```

## Effect Coding
```{r}
varfactor<-c("race_ethnicity",
         "age",
         "gender",
         "education",
         "employment",
         "houseown",
         "housetype",
         "hhincome",
         "hhkid",
         "license",
         "subsidy_transit",
         "subsidy_tnc",
         "subsidy_other",
         "home_popdensity",
         "home_jobdensity",
         "work_popdensity",
         "work_jobdensity",
         "tnc_user")
mplus[,varfactor] <- lapply(mplus[,varfactor] , factor)

library(wec)
list_effect<-lapply(varfactor,get)

for (var in varfactor){
  contrasts(mplus[[var]])<-contr.sum(nlevels(mplus[[var]]))
  assign(paste("effect",var,sep="_"), as.data.frame(contrasts(mplus_effect[[var]])))
  # setNames(ifelse(nlevels(mplus_effect[[var]])==2,c(paste0(var,"1")),
  #                 ifelse(nlevels(mplus_effect[[var]])==3,c(paste0(var,"1"),paste0(var,"2")),
  #                        ifelse(nlevels(mplus_effect[[var]])==4,c(paste0(var,"1"),paste0(var,"2"),paste0(var,"3")),
  #                               ifelse(nlevels(mplus_effect[[var]])==5,c(paste0(var,"1"),paste0(var,"2"),paste0(var,"3"),paste0(var,"4")))))))
  # print (head(contrasts(mplus_effect[[var]])))
}


mplus_effect<-mplus %>% 
  left_join(effect)
  


contr.Treatment(n, base = 1, contrasts = TRUE)
contrasts(mplus$race_ethnicity) <- contr.sum(5)
contrasts(mplus$race_ethnicity)
 
mplus_dummy <- dummy_cols(mplus[,c(-1)],
                          remove_first_dummy = TRUE,
                          ignore_na= TRUE,
                          remove_selected_columns=TRUE)
mplus_dummy<-cbind(mplus[,1],mplus_dummy)
colnames(mplus_dummy)[1]<-"person_id"
mplus_dummy[is.na(mplus_dummy)]<-999

mplus_dummy_colname<-data.frame(colnames(mplus_dummy))


write.table(mplus_effect,"mplus_effect.csv",sep=",",na = "",col.names = F, row.names = F)
write.table(mplus_effect,"mplus_effect_withcolname.csv",sep=",",na = "",col.names = T, row.names = F)
write.table(mplus_effect_colname,"mplus_effect_colname.csv",sep=",",na = "",col.names = F, row.names = F)

# summary(mplus_dummy)

```




# ________LCA MPLUS________

# 5 class
## Output
```{r}
mplus <- setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/mplus_withcolname.csv",colClasses = c('person_id'='character'),header=TRUE))
```

```{r}
# mean indicator
measure_nbi_c3_out <-read.table("measure_nbi_c3_covariates.txt", header = FALSE, sep = "")

mean_indicator<-measure_nbi_c3_out %>% 
  group_by(V49) %>% 
  summarise_at(vars(V1,V2,V3,V4,V5,V6,V7,V8,V9,V10), funs(mean(., na.rm=TRUE)))
mean_indicator<-as.data.frame(t(as.matrix(mean_indicator)))[-1,]

# proportion

measure_nbi_c3_out[,ncol(measure_nbi_c3_out)]<-as.character(measure_nbi_c3_out[,ncol(measure_nbi_c3_out)])
m3_data<-merge(mplus,measure_nbi_c3_out,by.x = "person_id",by.y = "V50",all.y = T)

prop_m3<-m3_data%>% 
  select((ncol(m3_data)-4):(ncol(m3_data)-1)) %>% 
  summarise_all(sum)

m5_data$wktrip_TNC<-m5_data$wktrip_TNC_Commuting+ m5_data$wktrip_TNC_Non.commuting
m5_data$wktrip_TNC_dummy<- ifelse(m5_data$wktrip_TNC>0,1,0)


prop_self_report<-m5_data %>% 
  group_by(tnc_user) %>% 
  summarise(total=n(),V46=sum(V46),V47=sum(V47),V48=sum(V48),V49=sum(V49),V50=sum(V50))%>%
  mutate(V46=V46/total,V47=V47/total,V48=V48/total,V49=V49/total,V50=V50/total) %>% 
  setNames(.,c("TNC user group","Sample size","Car heavier user","Car lighter user","Transit+Walk","Bicyclist"))

prop_observe<-m4_data %>% 
  group_by(wktrip_TNC_dummy) %>% 
  summarise(total=n(),V46=sum(V46),V47=sum(V47),V48=sum(V48),V49=sum(V49))%>%
  mutate(V46=V46/total,V47=V47/total,V48=V48/total,V49=V49/total) %>% 
  setNames(.,c("TNC user group","Sample size","Car heavier user","Car lighter user","Transit+Walk","Bicyclist"))

# prop_self_report<-m4_data %>% 
#   group_by(V50,tnc_user) %>% 
#   summarise(n=n()) %>% 
#   mutate(perc=n/sum(n),2) %>% 
#   select(V50, tnc_user,perc) %>% 
#   pivot_wider(names_from = tnc_user,values_from= perc) %>% 
#   setNames(.,c("Class","Non-users","Occasional Users","Frequent Users"))

# prop_observe<-m4_data %>% 
#   group_by(V50,wktrip_TNC_dummy) %>% 
#   summarise(n=n()) %>% 
#   mutate(perc=n/sum(n),2) %>% 
#   select(V50, wktrip_TNC_dummy,perc) %>% 
#   pivot_wider(names_from = wktrip_TNC_dummy,values_from= perc) %>% 
#   setNames(.,c("Class","Non-users","Users"))


prop_both<-rbind(prop_self_report, prop_observe)


```


# 4 class
## Output
```{r}
mplus <- setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/mplus_withcolname.csv",colClasses = c('person_id'='character'),header=TRUE))
```

```{r}
# mean indicator
measure_nbi_c4_out <-read.table("measure_nbi_c4_covariates.txt", header = FALSE, sep = "")

mean_indicator<-measure_nbi_c4_out %>% 
  group_by(V50) %>% 
  summarise_at(vars(V1,V2,V3,V4,V5,V6,V7,V8,V9,V10), funs(mean(., na.rm=TRUE)))
mean_indicator<-as.data.frame(t(as.matrix(mean_indicator)))[-1,]

# proportion

measure_nbi_c4_out[,ncol(measure_nbi_c4_out)]<-as.character(measure_nbi_c4_out[,ncol(measure_nbi_c4_out)])

colnames(measure_nbi_c4_out)[46:51]<-c("class1","class2","class3","class4","class","person_id")
m4_data<-merge(mplus,measure_nbi_c4_out,by = "person_id",all.y = T)


prop_m4<-m4_data%>% 
  select((ncol(m4_data)-4):(ncol(m4_data)-1)) %>% 
  summarise_all(sum)

m4_data$wktrip_TNC<-m4_data$wktrip_TNC_Commuting+ m4_data$wktrip_TNC_Non.commuting
m4_data$wktrip_TNC_dummy<- ifelse(m4_data$wktrip_TNC>0,1,0)


# prop_self_report<-m4_data %>% 
#   group_by(tnc_user) %>% 
#   summarise(total=n(),V46=sum(V46),V47=sum(V47),V48=sum(V48),V49=sum(V49))%>%
#   mutate(V46=V46/total,V47=V47/total,V48=V48/total,V49=V49/total) %>% 
#   setNames(.,c("TNC user group","Sample size","Car heavier user","Car lighter user","Transit+Walk","Bicyclist"))
# 
# prop_observe<-m4_data %>% 
#   group_by(wktrip_TNC_dummy) %>% 
#   summarise(total=n(),V46=sum(V46),V47=sum(V47),V48=sum(V48),V49=sum(V49))%>%
#   mutate(V46=V46/total,V47=V47/total,V48=V48/total,V49=V49/total) %>% 
#   setNames(.,c("TNC user group","Sample size","Car heavier user","Car lighter user","Transit+Walk","Bicyclist"))

prop_self_report<-m4_data %>%
  group_by(V50,tnc_user) %>%
  summarise(n=n()) %>%
  mutate(perc=n/sum(n),2) %>%
  select(V50, tnc_user,perc) %>%
  pivot_wider(names_from = tnc_user,values_from= perc) %>%
  setNames(.,c("Class","Non-users","Occasional Users","Frequent Users"))


prop_observe<-m4_data %>%
  group_by(V50,wktrip_TNC_dummy) %>%
  summarise(n=n()) %>%
  mutate(perc=n/sum(n),2) %>%
  select(V50, wktrip_TNC_dummy,perc) %>%
  pivot_wider(names_from = wktrip_TNC_dummy,values_from= perc) %>%
  setNames(.,c("Class","Non-users","Frequent Users"))


prop_both<-left_join(prop_self_report, prop_observe, by="Class")
prop_both$Class<- c("Car heavier user","Car lighter user","Transit+Walk","Bicyclist")

prop_self_report1<-m4_data %>%
  group_by(tnc_user,V50) %>%
  summarise(n=n()) %>%
  mutate(perc=n/sum(n),2) %>%
  select(V50, tnc_user,perc) %>%
  pivot_wider(names_from = tnc_user,values_from= perc) %>%
  setNames(.,c("Class","Non-users","Occasional Users","Frequent Users"))


prop_observe1<-m4_data %>%
  group_by(wktrip_TNC_dummy,V50) %>%
  summarise(n=n()) %>%
  mutate(perc=n/sum(n),2) %>%
  select(V50, wktrip_TNC_dummy,perc) %>%
  pivot_wider(names_from = wktrip_TNC_dummy,values_from= perc) %>%
  setNames(.,c("Class","Non-users","Frequent Users"))


prop_both1<-left_join(prop_self_report1, prop_observe1, by="Class")
prop_both1$Class<- c("Car heavier user","Car lighter user","Transit+Walk","Bicyclist")

```


## Discriptive Table
```{r}

# Pop
pop<-m4_data %>%
  mutate(variable="n") %>%
  group_by(variable) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))

pop_perc<-m4_data %>%
  mutate(variable="%") %>%
  group_by(variable) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  mutate(V11=V11/sum(total),V12=V12/sum(total),V13=V13/sum(total),V14=V14/sum(total))

# Race/ Ethenicity
library(expss)

m4_data$race_ethnicity <- ordered(m4_data$race_ethnicity,
levels = c(1,2,3,4,5),
labels = c("Hispanic, Latino, or Spanish origin",
"Black or African American",
"Asian",
"White",
"Other"))

ethnicity<-m4_data %>%
  group_by(race_ethnicity) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(race_ethnicity)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# Age
m4_data$age <- ordered(m4_data$age,
levels = c(1,2,3,4),
labels = c("18-34",
"35-54",
"55-64",
"65 or over"))

age<-m4_data %>%
  group_by(age) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(age)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))


# Gender
m4_data$gender <- ordered(m4_data$gender,
levels = c(1,2),
labels = c("Female","Male"))

gender<-m4_data %>%
  group_by(gender) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(gender)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# Education
m4_data$education <- ordered(m4_data$education,
levels = c(1,2,3),
labels = c("Some College or lower",
"Bachalor",
"Higher than Bachalor"))

education<-m4_data %>%
  group_by(education) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(education)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# Stu/Emp
m4_data$stud_emp <- ordered(m4_data$stud_emp,
levels = c(2,3),
labels = c("Employee only","Employee and student"))

studemp<-m4_data %>%
  group_by(stud_emp) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(stud_emp)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# HH ownership
m4_data$houseown <- ordered(m4_data$houseown,
levels = c(1,2),
labels = c("Rent or other","Own"))

houseown<-m4_data %>%
  group_by(houseown) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(houseown)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# HH Type
m4_data$housetype <- ordered(m4_data$housetype,
levels = c(1,2),
labels = c("Apartment or other","SF house or town house"))

housetype<-m4_data %>%
  group_by(housetype) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(housetype)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# HH Income
m4_data$hhincome <- ordered(m4_data$hhincome,
levels = c(1,2,3,4,5),
labels = c("Under $25,000",
"$25,000-$49,999",
"$50,000-$99,999",
"$100,000-$149,999",
"$150,000 or more"))

income<-m4_data %>%
  group_by(hhincome) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(hhincome)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# Child
m4_data$hhkid<- ordered(m4_data$hhkid,
levels = c(1,2),
labels = c("No","Yes"))

hhkid<-m4_data %>%
  group_by(hhkid) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(hhkid)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# Veh/Worker
hhveh_worker<-m4_data %>%
  filter(!is.na(hhveh_worker)) %>%
  group_by(V15) %>% 
  summarise(total=mean(hhveh_worker))%>% 
  mutate(variable='hhveh_worker')

hhveh_worker_pop<-m4_data %>%
  filter(!is.na(hhveh_worker)) %>%
  summarise(total=mean(hhveh_worker))%>% 
  mutate(variable='hhveh_worker')

library(plyr)
hhveh_worker_final<-rbind.fill(hhveh_worker_pop,hhveh_worker) %>% 
  pivot_wider(id_cols=variable, names_from = V15, values_from=total) %>% 
  setNames(c("variable","total","V11","V12","V13","V14"))
detach(package:plyr)

# DL
m4_data$license<- ordered(m4_data$license,
levels = c(0,1),
labels = c("No","Yes"))

license<-m4_data %>%
  group_by(license) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(license)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))


# Commute_subsidy
m4_data$subsidy_transit<- ordered(m4_data$subsidy_transit,
levels = c(0,1),
labels = c("No","Yes"))
m4_data$subsidy_tnc<- ordered(m4_data$subsidy_tnc,
levels = c(0,1),
labels = c("No","Yes"))
m4_data$subsidy_other<- ordered(m4_data$subsidy_other,
levels = c(0,1),
labels = c("No","Yes"))

subsidy_transit<-m4_data %>%
  group_by(subsidy_transit) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(subsidy_transit)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

subsidy_tnc<-m4_data %>%
  group_by(subsidy_tnc) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(subsidy_tnc)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

subsidy_other<-m4_data %>%
  group_by(subsidy_other) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(subsidy_other)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

# Transit Pass

#telework_freq
telework_freq<-m4_data %>%
  filter(!is.na(telework_freq)) %>%
  group_by(V15) %>% 
  summarise(total=mean(telework_freq))%>% 
  mutate(variable='Weekly telework frequency')

telework_freq_pop<-m4_data %>%
  filter(!is.na(telework_freq)) %>%
  summarise(total=mean(telework_freq))%>% 
  mutate(variable='Weekly telework frequency')

library(plyr)
telework_freq_final<-rbind.fill(telework_freq_pop,telework_freq) %>% 
  pivot_wider(id_cols=variable, names_from = V15, values_from=total) %>% 
  setNames(c("variable","total","V11","V12","V13","V14"))
detach(package:plyr)

# Home- Pop den
home_popdensity<-m4_data %>%
  filter(!is.na(home_popdensity)) %>%
  group_by(V15) %>% 
  summarise(total=mean(home_popdensity))%>% 
  mutate(variable='Population density (home location)')

home_popdensity_pop<-m4_data %>%
  filter(!is.na(home_popdensity)) %>%
  summarise(total=mean(home_popdensity))%>% 
  mutate(variable='Population density (home location)')

library(plyr)
home_popdensity_final<-rbind.fill(home_popdensity_pop,home_popdensity) %>% 
  pivot_wider(id_cols=variable, names_from = V15, values_from=total) %>% 
  setNames(c("variable","total","V11","V12","V13","V14"))
detach(package:plyr)

# Home- Job den
home_jobdensity<-m4_data %>%
  filter(!is.na(home_jobdensity)) %>%
  group_by(V15) %>% 
  summarise(total=mean(home_jobdensity))%>% 
  mutate(variable='Job density (home location)')

home_jobdensity_pop<-m4_data %>%
  filter(!is.na(home_jobdensity)) %>%
  summarise(total=mean(home_jobdensity))%>% 
  mutate(variable='Job density (home location)')

library(plyr)
home_jobdensity_final<-rbind.fill(home_jobdensity_pop,home_jobdensity) %>% 
  pivot_wider(id_cols=variable, names_from = V15, values_from=total) %>% 
  setNames(c("variable","total","V11","V12","V13","V14"))
detach(package:plyr)


#AV
m4_data$av_use<- ordered(m4_data$av_use,
levels = c(1,2,3,4,5),
labels = c("Very interested",
"Somewhat interested",
"Neutral",
"Somewhat uninterested",
"Not at all interested"))

m4_data$av_own<- ordered(m4_data$av_own,
levels = c(1,2,3,4,5),
labels = c("Very interested",
"Somewhat interested",
"Neutral",
"Somewhat uninterested",
"Not at all interested"))

m4_data$av_future<- ordered(m4_data$av_future,
levels = c(1,2,3),
labels = c("Travel more",
"Travel the same amount",
"Travel less "))


av_use<-m4_data %>%
  group_by(av_use) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(av_use)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

av_own<-m4_data %>%
  group_by(av_own) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(av_own)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

av_future<-m4_data %>%
  group_by(av_future) %>%
  summarise(total=n(),V11=sum(V11),V12=sum(V12),V13=sum(V13),V14=sum(V14))%>%
  filter(!is.na(av_future)) %>% 
  mutate(total=total/sum(total),V11=V11/sum(V11),V12=V12/sum(V12),V13=V13/sum(V13),V14=V14/sum(V14))

### Overall Summary Table####
colnames(pop)[1]<-'variable'
colnames(pop_perc)[1]<-'variable'
colnames(age)[1]<-'variable'
colnames(gender)[1]<-'variable'
colnames(ethnicity)[1]<-'variable'
colnames(education)[1]<-'variable'
colnames(income)[1]<-'variable'
colnames(studemp)[1]<-'variable'
colnames(houseown)[1]<-'variable'
colnames(housetype)[1]<-'variable'
colnames(hhkid)[1]<-'variable'
colnames(license)[1]<-'variable'
colnames(subsidy_transit)[1]<-'variable'
colnames(subsidy_tnc)[1]<-'variable'
colnames(subsidy_other)[1]<-'variable'
colnames(av_use)[1]<-'variable'
colnames(av_own)[1]<-'variable'
colnames(av_future)[1]<-'variable'



summary_long<-bind_rows(pop,pop_perc,ethnicity,age,gender,education,studemp,houseown,housetype,income,hhkid,license,hhveh_worker_final,subsidy_transit,subsidy_tnc,subsidy_other,telework_freq_final,home_popdensity_final,home_jobdensity_final,av_use,av_own,av_future)

summary_long
# summary_wide<-dcast(summary_long, variable+Percent~variable,sum)

# library(XLConnect)
# writeWorksheetToFile("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Results/R_results_4MPOs.xlsx",
#                  data = summary_long,
#                  sheet = "SDE",
#                  header = TRUE,
#                  clearSheets = TRUE)
# 
# 
# ## chi-square of significance
# chisq.test(table(mpos4_per$gender_final,mpos4_per$tnc_user_new),correct=FALSE)


```

## TNC Trip Characteristics

### Mode Share
```{r}
# mpos4_trip$person_id<-as.numeric(mpos4_trip$person_id)
# mpos4_trip<-merge(mpos4_trip,pop_7days[,c("hh_id","person_id","tnc_user")],by=c("hh_id","person_id"))

mpos4_trip<-mpos4_trip[tnc_user>=0]

,pos

modeshare<-mpos4_trip %>%
  group_by(tnc_user,mode_recode) %>%
  summarise(n=n(),Frequency = sum(WEIGHT_TRIP)) %>%
  mutate(Percent = round(Frequency / sum(Frequency)*100,2))

modeshare<-modeshare %>%
    mutate (w=0,
            b=0,
            car=0,
            pt=0,
            # tnc_s=0,
            tnc=0,
            o=0)

for (i in (1:nrow(modeshare))){
  modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
  modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
  modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
  modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
  # modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
  modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
  modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
}

# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s

modeshare1<- melt(modeshare[,c(1,6:11)], id.vars=c("tnc_user")) %>%
  group_by(tnc_user,variable) %>%
  summarise(n=n(),Count=sum(value)) %>%
  mutate(Percent = round(Count / sum(Count)*100,2))
colnames(modeshare1)[2]<-"category"
modeshare1$variable<-"modeshare"

# # Total Trips
# 
# modeshare<-mpos4_trip %>%
#   group_by(mode_recode,tnc_user) %>%
#   mutate(count=1) %>%
#   summarise(Frequency=sum(count))
#   
#   
# 
# modeshare<-modeshare %>%
#     mutate (w=0,
#             b=0,
#             car=0,
#             pt=0,
#             tnc_s=0,
#             tnc=0,
#             o=0)
# 
# for (i in (1:nrow(modeshare))){
#   modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
#   modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
#   modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
#   modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
#   modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
#   modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
#   modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
# }
# 
# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s
# 
# modeshare1<- melt(modeshare[,c(2,4:10)], id.vars=c("tnc_user")) %>%
#   group_by(variable,tnc_user) %>%
#   summarise(Count=sum(value)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,2))
# 
# sum(modeshare[c(4:10)])
```

### Num trips observed
```{r}
tnc_trip<-m4_trip %>%
  filter(mode_final=="tnc") 

numtrip_class<-tnc_trip %>% 
  group_by(class) %>% 
  summarise(n=n()) %>%
  mutate(category=1) %>% 
  pivot_wider(names_from = class, values_from=n) %>% 
  setNames(.,c("category","class1","class2","class3","class4")) %>%
  mutate(category="Number of TNC trips observed")
```

### Frequency
```{r}
m4_trip<-trip_7days %>% 
  inner_join(select(m4_data, person_id,class1,class2,class3,class4,class),by="person_id") 

## among total population
distinct_pop_4mpos<-m4_trip %>% 
  group_by(class) %>%
  summarise(pop=n_distinct(person_id))

tnc_freq<-m4_trip %>%
  group_by(class,mode_final) %>%
  summarise(total=n()) %>% 
  merge(distinct_pop,by="class")%>%
  mutate(mode_freq=total/pop) %>%
  filter(mode_final=="tnc") %>% 
  select(class, mode_final, mode_freq) %>% 
  pivot_wider(names_from = class, values_from=mode_freq) %>% 
  setNames(.,c("category","class1","class2","class3","class4")) %>%
  mutate(category="Average weekly TNC frequency among population")

# table(tnc_trip$region)
# table(tnc_trip$mode_final)


tnc_freq_sacog<-tnc_trip %>%
  filter(region=="SACOG") %>%
  group_by(class) %>%
  summarise(total=n(),pop=n_distinct(person_id)) %>%
  mutate(tnc_freq=total/pop) %>%
  select(class, tnc_freq) %>% 
  pivot_longer(cols= !class,names_to="category",values_to="value") %>% 
  pivot_wider(names_from = class, values_from=value) %>% 
  setNames(.,c("category","class1","class2","class3","class4")) %>%
  mutate(category="Average weekly TNC frequency")



# tnc_freq_sacog_pool<-tnc_trip %>%
#   filter(region=="SACOG") %>%
#   group_by(class,sacog_pool) %>%
#   summarise(total=n(),pop=n_distinct(person_id)) %>%
#   mutate(tnc_freq=total/pop) %>%
#   select(class,sacog_pool, tnc_freq) %>% 
#   pivot_longer(cols= !class,names_to="category",values_to="value") %>% 
#   pivot_wider(names_from = class, values_from=value) %>% 
#   setNames(.,c("category","class1","class2","class3","class4")) %>%
#   mutate(category=c("Pooled (e.g., uberPOOL, LyftLine)","Regular or economy (e.g., uberX, Lyft)"))
# 
# tnc_trip$sacog_pool<-ifelse(str_detect(tnc_trip$mode_recode, "tnc_s"),1,0) 
# table(tnc_trip$mode_recode)

distinct_pop_3mpos<-tnc_trip %>%
  filter(region!="SACOG") %>%
  distinct(person_id,class) %>% 
  group_by(class) %>%
  summarise(pop=n())

tnc_freq_3mpos<-tnc_trip %>%
  filter(region!="SACOG") %>%
  group_by(class) %>%
  summarise(trip=n()) %>%
  merge(distinct_pop_3mpos, by="class") %>% 
  mutate(tnc_freq=trip/pop) %>%
  select(class, tnc_freq) %>% 
  pivot_longer(cols= !class,names_to="category",values_to="value") %>% 
  pivot_wider(names_from = class, values_from=value) %>% 
  setNames(.,c("category","class1","class2","class3","class4")) %>%
  mutate(category="Average weekly TNC frequency")

tnc_type_3mpos<-tnc_trip%>%
  filter(region !="SACOG") %>% 
  mutate(tnc_type=ifelse(mode_uber==1 |mode_lyft==1,1, ifelse(mode_uber==2 |mode_lyft==2,2,ifelse(mode_uber==3 |mode_lyft==3,3,998))))%>%
  # filter(!is.na(tnc_type)) %>% 
  group_by(class,tnc_type) %>%
  summarise(trip=n()) %>%
  merge(distinct_pop_3mpos, by="class") %>% 
  # mutate(total_trip=sum(trip),total_pop=sum(pop)) %>% 
  mutate(value=trip/pop) %>%
  group_by(class) %>% 
  summarise(perc=value/sum(value)) 

tnc_type_3mpos$category<-c(1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4)

tnc_type_3mpos<-tnc_type_3mpos %>% 
  pivot_wider(names_from = class, values_from=perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4")) %>%
  mutate(category=c("Pooled (e.g., uberPOOL, LyftLine)","Regular or economy (e.g., uberX, Lyft)","Premium (e.g., UberSELECT, Lyft Premier)","Don't know"))


# m4_tnc_freq<-m4_trip %>% 
#   filter(mode_type=="tnc") %>% 
#   group_by(person_id,class1,class2,class3,class4) %>%
#   summarise(total=n()) %>%
#   mutate(class1_freq=class1*total,class2_freq=class2*total,class3_freq=class3*total,class4_freq=class4*total) %>% 
#   summarise_if(is.numeric,mean, na.rm = TRUE)
#   summarise_all(sum)
#   
#   summarise(pop_total=count(unique(person_id)))
# 
#   summarise(tnc_total=n()) %>%
#   mutate(tnc_freq)
#   
# pop<-m4_data %>%
#   mutate(variable="n") %>%
#   group_by(variable) %>%
#   summarise(total=n(),V46=sum(V46),V47=sum(V47),V48=sum(V),V14=sum(V14))
# 
# m4_pop<-m4_data %>% 
#   group_by(V50) %>% 
#   summarise(pop_total=n()))


  
```
### Travel Size
```{r}
#### Distinguish TNC pool/non-pool trips ####

tnc_pool<-tnc_trip%>%
  mutate (pool=ifelse(str_detect(mode_recode, "tnc_s")| mode_uber== 1 | mode_lyft==1,1,0)) %>%
  filter(!is.na(pool)) %>% 
  group_by(class,pool)%>%
  summarize(count=n()) %>% 
  mutate(perc=count/sum(count)) %>% 
  select(class,pool,perc) %>% 
  pivot_wider(id_cols=pool,names_from = class, values_from=perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4")) %>% mutate(category=c("Not Ridesplitting","Ridesplitting"))

# a<-tnc_trip[,.(tnc_pooled,num_hh_travelers,num_non_hh_travelers,pool)]

#### traveler size ####
tnc_travelsize<-tnc_trip %>%
  filter(num_travelers>=0 & num_non_hh_travelers >=0 & num_hh_travelers>=0 & !is.na(day_time)) %>%
  group_by(class) %>%
  summarize(total_party_size=sum(num_travelers), total_trip=n(), hh=sum(num_hh_travelers),nonhh= sum(num_non_hh_travelers)) %>%
  mutate(party_size_avg=total_party_size/total_trip, hh_avg=hh/total_trip, nonhh_avg=nonhh/total_trip) %>% 
  select(class,party_size_avg,hh_avg,nonhh_avg) %>% 
  pivot_longer(cols= !class,names_to="category",values_to="value") %>% 
  pivot_wider(names_from = class, values_from=value) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Total party size","Household member","Non-household member"))

# prop.table(table(tnc_trip$num_travelers,tnc_trip$class),margin = 2)
# table(tnc_trip$num_hh_travelers)
# table(tnc_trip$num_non_hh_travelers)
```



### Day-of-Week & Time-of-day
Morning:5-10
Midday: 10-15
Afternoon: 15-19
Evening: 19-23
Night: 23-5
```{r}
day_of_week<-tnc_trip %>%
  mutate(weekdayend=ifelse(travel_date_dow<=5,"weekday",ifelse(travel_date_dow>5,"weekend",-1))) %>% 
  group_by(class,weekdayend) %>% 
  summarise(count = n()) %>% 
  mutate(perc=count/sum(count)) %>% 
  select(class,weekdayend,perc) %>% 
  pivot_wider(id_cols=weekdayend,names_from = class, values_from=perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Weekday","Weekend"))

tnc_trip$timeperoid<-ifelse(tnc_trip$depart_time_decimal>=5 & tnc_trip$depart_time_decimal<10,"Morning",
                        ifelse(tnc_trip$depart_time_decimal>=10 & tnc_trip$depart_time_decimal<15,"Midday",
                               ifelse(tnc_trip$depart_time_decimal>=15 & tnc_trip$depart_time_decimal<19,"Afternoon",
                                      ifelse(tnc_trip$depart_time_decimal>=19 & tnc_trip$depart_time_decimal<23,"Evening",ifelse(tnc_trip$depart_time_decimal>=23 | tnc_trip$depart_time_decimal<5,"Night","NA")))))

time_of_day<-tnc_trip %>%
  group_by(class,timeperoid) %>% 
  summarise(count = n()) %>% 
  mutate(perc=count/sum(count)) %>% 
  select(class,timeperoid,perc)%>% 
  pivot_wider(id_cols=timeperoid,names_from = class, values_from=perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Morning","Midday","Afternoon","Evening","Night"))


```

### OD_Purpose
```{r}
# table(tnc_trip$o_purpcat_recode)
# table(tnc_trip$d_purpcat_recode)
tnc_trip$o_purpcat_recode<-dplyr::recode(tnc_trip$o_purpcat_recode,`3` = 2L,`5` = 4L,`8` = 4L)
tnc_trip$d_purpcat_recode<-dplyr::recode(tnc_trip$d_purpcat_recode,`3` = 2L,`5` = 4L,`8` = 4L)

tnc_trip$o_purpcat_recode[tnc_trip$o_purpcat_recode<0]<-NA
tnc_trip$d_purpcat_recode[tnc_trip$d_purpcat_recode<0]<-NA

o_purpose<-tnc_trip %>%
  filter(!is.na(o_purpcat_recode)) %>% 
  group_by(class,o_purpcat_recode) %>% 
  summarise(purpose = n()) %>% 
  mutate(o_purpose_perc=purpose/sum(purpose)) %>% 
  select(class,o_purpcat_recode,o_purpose_perc)%>% 
  pivot_wider(id_cols=o_purpcat_recode,names_from = class, values_from=o_purpose_perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Home","Mandatory","Maintenance/Escort/Errand/Other","Recreation","Change Mode"))

d_purpose<-tnc_trip %>%
  filter(!is.na(d_purpcat_recode)) %>% 
  group_by(class,d_purpcat_recode) %>% 
  summarise(purpose = n()) %>% 
  mutate(d_purpose_perc=purpose/sum(purpose)) %>% 
  select(class,d_purpcat_recode,d_purpose_perc)%>% 
  pivot_wider(id_cols=d_purpcat_recode,names_from = class, values_from=d_purpose_perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Home","Mandatory","Maintenance/Escort/Errand/Other","Recreation","Change Mode"))
```

### Duration/ Length/ Fare
```{r}
dur_dist_fare<-tnc_trip %>%
  group_by(class) %>%
  summarise(duration=mean(duration_imputed, na.rm = T),distance=mean(distance, na.rm = T),fare=mean(taxi_cost, na.rm = T)) %>%
  pivot_longer(cols= !class,names_to="category",values_to="value") %>% 
  pivot_wider(names_from = class, values_from=value) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Trip duration","Trip distance","Trip Fare"))
```

### tnc_schedule/ wait
```{r}
tnc_schedule<-tnc_trip %>%
  filter(!is.na(tnc_schedule) & tnc_schedule>=0) %>% 
  group_by(class,tnc_schedule) %>% 
  summarise(count = n()) %>% 
  mutate(perc=count/sum(count)) %>% 
  select(class,tnc_schedule,perc)%>% 
  pivot_wider(id_cols=tnc_schedule,names_from = class, values_from=perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("No","Yes"))


wait_time<-tnc_trip %>%
  filter(tnc_wait_time<900) %>% 
  group_by(class) %>%
  summarise(duration=mean(tnc_wait_time, na.rm = T)) %>%
  pivot_longer(cols= !class,names_to="category",values_to="value") %>% 
  pivot_wider(names_from = class, values_from=value) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Wait time"))

summary(tnc_trip$tnc_wait_time)
```

### OD BE
```{r,message=F}

be = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/BE_Variables/CA_bg_census.csv",colClasses = c('GEOID'='numeric'),header=TRUE))

library("readxl")
sacog_bg_taz1<-setDT(read_excel("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/CMS_SAOOG_bg_taz.xlsx")) %>% select(GEOID,TAZ07)

sacog_bg_taz1$GEOID<-as.numeric(sacog_bg_taz1$GEOID)
sacog_taz1<-sacog_bg_taz1 %>% 
  merge(be, by="GEOID",all.x = T) %>%
  group_by(TAZ07) %>%
  summarise(totalpop=sum(totalpop),totaljob=sum(totaljob),area_sqmi=sum(area_sqmi)) %>%
  mutate(taz_popdensity=totalpop/area_sqmi,taz_jobdensity=totaljob/area_sqmi)

sacog_bg_taz2<-setDT(read_excel("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/taz_bg_Intersect.xlsx")%>% select(GEOID,TAZ07)%>% filter(!TAZ07 %in% sacog_taz1$TAZ07))

sacog_bg_taz2$GEOID<-as.numeric(sacog_bg_taz2$GEOID)
sacog_taz2<-sacog_bg_taz2  %>% 
  merge(be,by ="GEOID") %>%
  group_by(TAZ07) %>%
  summarise(totalpop=sum(totalpop),totaljob=sum(totaljob),area_sqmi=sum(area_sqmi)) %>%
  mutate(taz_popdensity=totalpop/area_sqmi,taz_jobdensity=totaljob/area_sqmi)

sacog_taz<-rbind(sacog_taz1[,c("TAZ07","taz_popdensity","taz_jobdensity")],sacog_taz2[,c("TAZ07","taz_popdensity","taz_jobdensity")])

tnc_trip$o_bg_geo_id<-as.numeric(tnc_trip$o_bg_geo_id)
tnc_trip$d_bg_geo_id<-as.numeric(tnc_trip$d_bg_geo_id)

# summary(tnc_trip$o_bg_geo_id)
# summary(tnc_trip$d_bg_geo_id)


#### Trip O ####

tnc_trip<-tnc_trip %>%
  merge(be[,c("GEOID","popdensity","jobdensity")],by.x="o_bg_geo_id",by.y ="GEOID",all.x = T) %>%
  merge(sacog_taz[,c("TAZ07","taz_popdensity","taz_jobdensity")], by.x = "o_taz",by.y="TAZ07",all.x = T) %>%
  rename(o_popdensity = popdensity,o_jobdensity=jobdensity)

# summary(pop_7days$taz_popdensity[pop_7days$region=="SACOG"])

tnc_trip$o_popdensity[tnc_trip$region=="SACOG"]<-tnc_trip$taz_popdensity[tnc_trip$region=="SACOG"]
tnc_trip$o_jobdensity[tnc_trip$region=="SACOG"]<-tnc_trip$taz_jobdensity[tnc_trip$region=="SACOG"]

# group by quartile
tnc_trip$o_popdensity<-ifelse(tnc_trip$o_popdensity<quantile(be$popdensity,0.25,na.rm = T),1,
                                  ifelse(tnc_trip$o_popdensity>=quantile(be$popdensity,0.25,na.rm = T) & tnc_trip$o_popdensity<quantile(be$popdensity,0.5,na.rm = T),2,
                                         ifelse(tnc_trip$o_popdensity>=quantile(be$popdensity,0.5,na.rm = T) & tnc_trip$o_popdensity<quantile(be$popdensity,0.75,na.rm = T),3,4)))

tnc_trip$o_jobdensity<-ifelse(tnc_trip$o_jobdensity<quantile(be$jobdensity,0.25,na.rm = T),1,
                                  ifelse(tnc_trip$o_jobdensity>=quantile(be$jobdensity,0.25,na.rm = T) & tnc_trip$o_jobdensity<quantile(be$jobdensity,0.5,na.rm = T),2,
                                         ifelse(tnc_trip$o_jobdensity>=quantile(be$jobdensity,0.5,na.rm = T) & tnc_trip$o_jobdensity<quantile(be$jobdensity,0.75,na.rm = T),3,4)))



#### Trip D ####
tnc_trip<-tnc_trip %>%
  merge(be[,c("GEOID","popdensity","jobdensity")],by.x="d_bg_geo_id",by.y ="GEOID",all.x = T) %>%
  merge(sacog_taz[,c("TAZ07","taz_popdensity","taz_jobdensity")], by.x = "d_taz",by.y="TAZ07",all.x = T) %>%
  rename(d_popdensity = popdensity,d_jobdensity=jobdensity)

# summary(pop_7days$taz_popdensity[pop_7days$region=="SACOG"])

tnc_trip$d_popdensity[tnc_trip$region=="SACOG"]<-tnc_trip$taz_popdensity.y[tnc_trip$region=="SACOG"]
tnc_trip$d_jobdensity[tnc_trip$region=="SACOG"]<-tnc_trip$taz_jobdensity.y[tnc_trip$region=="SACOG"]

# group by quartile
tnc_trip$d_popdensity<-ifelse(tnc_trip$d_popdensity<quantile(be$popdensity,0.25,na.rm = T),1,
                                  ifelse(tnc_trip$d_popdensity>=quantile(be$popdensity,0.25,na.rm = T) & tnc_trip$d_popdensity<quantile(be$popdensity,0.5,na.rm = T),2,
                                         ifelse(tnc_trip$d_popdensity>=quantile(be$popdensity,0.5,na.rm = T) & tnc_trip$d_popdensity<quantile(be$popdensity,0.75,na.rm = T),3,4)))

tnc_trip$d_jobdensity<-ifelse(tnc_trip$d_jobdensity<quantile(be$jobdensity,0.25,na.rm = T),1,
                                  ifelse(tnc_trip$d_jobdensity>=quantile(be$jobdensity,0.25,na.rm = T) & tnc_trip$d_jobdensity<quantile(be$jobdensity,0.5,na.rm = T),2,
                                         ifelse(tnc_trip$d_jobdensity>=quantile(be$jobdensity,0.5,na.rm = T) & tnc_trip$d_jobdensity<quantile(be$jobdensity,0.75,na.rm = T),3,4)))

# summary(tnc_trip$o_popdensity)
# summary(tnc_trip$o_jobdensity)
# summary(tnc_trip$d_popdensity)
# summary(tnc_trip$d_jobdensity)

# table(tnc_trip$o_popdensity)
# table(tnc_trip$o_jobdensity)
# table(tnc_trip$d_popdensity)
# table(tnc_trip$d_jobdensity)

#### Group by class####
o_popden<-tnc_trip %>%
  filter(!is.na(o_popdensity)) %>% 
  group_by(class,o_popdensity) %>% 
  summarise(o_popden = n()) %>% 
  mutate(o_popden_perc=o_popden/sum(o_popden)) %>% 
  select(class,o_popdensity,o_popden_perc) %>% 
  pivot_wider(id_cols=o_popdensity,names_from = class, values_from=o_popden_perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4")) %>% mutate(category=c("1st quartile","2nd quartile","3rd quartile","4th quartile"))

o_jobden<-tnc_trip %>%
  filter(!is.na(o_jobdensity)) %>% 
  group_by(class,o_jobdensity) %>% 
  summarise(o_jobden = n()) %>% 
  mutate(o_jobden_perc=o_jobden/sum(o_jobden)) %>% 
  select(class,o_jobdensity,o_jobden_perc)%>% 
  pivot_wider(id_cols=o_jobdensity,names_from = class, values_from=o_jobden_perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("1st quartile","2nd quartile","3rd quartile","4th quartile"))

d_popden<-tnc_trip %>%
  filter(!is.na(d_popdensity)) %>% 
  group_by(class,d_popdensity) %>% 
  summarise(d_popden = n()) %>% 
  mutate(d_popden_perc=d_popden/sum(d_popden)) %>% 
  select(class,d_popdensity,d_popden_perc)%>% 
  pivot_wider(id_cols=d_popdensity,names_from = class, values_from=d_popden_perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("1st quartile","2nd quartile","3rd quartile","4th quartile"))

d_jobden<-tnc_trip %>%
  filter(!is.na(d_jobdensity)) %>% 
  group_by(class,d_jobdensity) %>% 
  summarise(d_jobden = n()) %>% 
  mutate(d_jobden_perc=d_jobden/sum(d_jobden)) %>% 
  select(class,d_jobdensity,d_jobden_perc)%>% 
  pivot_wider(id_cols=d_jobdensity,names_from = class, values_from=d_jobden_perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("1st quartile","2nd quartile","3rd quartile","4th quartile"))

```

### Mode Replcement
```{r}
# table(tnc_trip$tnc_replace, tnc_trip$region)
# summary(tnc_trip$tnc_replace)
tnc_trip$tnc_replace<-dplyr::recode(tnc_trip$tnc_replace,`9` = 4L,`10` = 4L,`8` = 4L)

mode_replace<-tnc_trip %>%
  filter(!is.na(tnc_replace) & tnc_replace>0) %>% 
  group_by(class,tnc_replace) %>% 
  summarise(replce = n()) %>% 
  mutate(replace_perc=replce/sum(replce)) %>% 
  select(class,tnc_replace,replace_perc) %>% 
  pivot_wider(id_cols=tnc_replace,names_from = class, values_from=replace_perc) %>% 
  setNames(.,c("category","class1","class2","class3","class4"))%>% mutate(category=c("Would make same trip by using a taxi","Would make same trip by driving own car","Would make same trip by riding with family/friend/coworker","Would make same trip by using transit","Would make same trip by walking/biking","Would travel to a different place instead","Would NOT make trip at all","Other"))

```

## Summary Table
```{r}
tnc_character<-rbind(tnc_freq,tnc_freq_bytype,tnc_pool,tnc_travelsize,day_of_week,time_of_day,o_purpose,d_purpose,dur_dist_fare,mode_replace,o_popden,o_jobden,d_popden,d_jobden)


```



# 5 class
## Output
```{r}
mplus <- setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/mplus_withcolname.csv",colClasses = c('person_id'='character'),header=TRUE))
```

```{r}
# mean indicator
measure_nbi_c5_out <-read.table("measure_nbi_c5_covariates.txt", header = FALSE, sep = "")

mean_indicator<-measure_nbi_c5_out %>% 
  group_by(V51) %>% 
  summarise_at(vars(V1,V2,V3,V4,V5,V6,V7,V8,V9,V10), funs(mean(., na.rm=TRUE)))
mean_indicator<-as.data.frame(t(as.matrix(mean_indicator)))[-1,]

# proportion

measure_nbi_c5_out[,ncol(measure_nbi_c5_out)]<-as.character(measure_nbi_c5_out[,ncol(measure_nbi_c5_out)])
m5_data<-merge(mplus,measure_nbi_c5_out,by.x = "person_id",by.y = "V52",all.y = T)

prop_m5<-m5_data%>% 
  select((ncol(m5_data)-5):(ncol(m5_data)-1)) %>% 
  summarise_all(sum)

m5_data$wktrip_TNC<-m5_data$wktrip_TNC_Commuting+ m5_data$wktrip_TNC_Non.commuting
m5_data$wktrip_TNC_dummy<- ifelse(m5_data$wktrip_TNC>0,1,0)


prop_self_report<-m5_data %>% 
  group_by(tnc_user) %>% 
  summarise(total=n(),V46=sum(V46),V47=sum(V47),V48=sum(V48),V49=sum(V49),V50=sum(V50))%>%
  mutate(V46=V46/total,V47=V47/total,V48=V48/total,V49=V49/total,V50=V50/total) %>% 
  setNames(.,c("TNC user group","Sample size","Car heavier user","Car lighter user","Transit+Walk","Bicyclist"))

prop_observe<-m4_data %>% 
  group_by(wktrip_TNC_dummy) %>% 
  summarise(total=n(),V46=sum(V46),V47=sum(V47),V48=sum(V48),V49=sum(V49))%>%
  mutate(V46=V46/total,V47=V47/total,V48=V48/total,V49=V49/total) %>% 
  setNames(.,c("TNC user group","Sample size","Car heavier user","Car lighter user","Transit+Walk","Bicyclist"))

# prop_self_report<-m4_data %>% 
#   group_by(V50,tnc_user) %>% 
#   summarise(n=n()) %>% 
#   mutate(perc=n/sum(n),2) %>% 
#   select(V50, tnc_user,perc) %>% 
#   pivot_wider(names_from = tnc_user,values_from= perc) %>% 
#   setNames(.,c("Class","Non-users","Occasional Users","Frequent Users"))

# prop_observe<-m4_data %>% 
#   group_by(V50,wktrip_TNC_dummy) %>% 
#   summarise(n=n()) %>% 
#   mutate(perc=n/sum(n),2) %>% 
#   select(V50, wktrip_TNC_dummy,perc) %>% 
#   pivot_wider(names_from = wktrip_TNC_dummy,values_from= perc) %>% 
#   setNames(.,c("Class","Non-users","Users"))


prop_both<-rbind(prop_self_report, prop_observe)


```









# ________LCA R________
# Measurement Model
## mclust/ tidyLPA (without TNC)
https://cran.r-project.org/web/packages/tidyLPA/vignettes/Introduction_to_tidyLPA.html


### Num of Classes
```{r}
library(tidyLPA)
mplus<- setDT(read.csv("mplus_withcolname.csv",colClasses = c('person_id'='character'),header=TRUE)) 

mplus_dummy<-merge(mplus,pop_7days[,c("person_id","n")],by="person_id",all.y=T)

class_compare<-mplus_dummy%>% 
  select(
         wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>% 
    single_imputation() %>%
    estimate_profiles(1:10, 
                      variances = c("equal", "varying"),
                      covariances = c("zero", "varying")) %>%
    compare_solutions(statistics = c("AIC", "BIC"))

class_compare_fit<-data.frame(class_compare$fits)

library(xlsx)
write.xlsx(x = class_compare_fit, file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output_employee.xlsx",sheetName = "class_compare", row.names = FALSE, col.names=TRUE, append = TRUE)
```

### m4
```{r}
m4<- class_compare<-mplus_dummy%>% 
  select(wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>% 
    single_imputation() %>%
    estimate_profiles(4)

# get_estimates(m4)
library(xlsx)
write.xlsx(x = data.frame(get_estimates(m4)), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output_employee.xlsx",sheetName = "m4", row.names = FALSE, col.names=TRUE,append=TRUE)
```

```{r}
m4_plot<- m4 %>% 
  plot_profiles()
    
```

```{r}
m4_output<-data.frame(get_estimates(m4)) %>%
  filter(Category=="Means") %>% 
  select(Parameter,Estimate,Class) %>%
  mutate(Estimate=round(Estimate,2)) %>% 
  pivot_wider(names_from = Class,values_from =Estimate,names_glue = "Class_{Class}") %>% setNames(.,c("Parameter","Bicyclist","Carpooler","Transit+Walk","SOV User"))
  

library(dplyr)
prop_m4<-get_data(m4) %>% 
  select(CPROB1,CPROB2,CPROB3,CPROB4) %>% 
  setNames(.,c("Bicyclist","Carpooler","Transit+Walk","SOV User")) %>% 
  summarise_all(sum)

library(plyr)
m4_tnc_final<-rbind.fill(prop_m4,m4_output)
detach(package:plyr)

write.xlsx(x = data.frame(m4_tnc_final), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output_employee.xlsx",sheetName = "m4_tnc_output", row.names = FALSE, col.names=TRUE,append=TRUE)
```


### m5
```{r}
m5<- class_compare<-mplus_dummy%>% 
  select(wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>% 
    single_imputation() %>%
    estimate_profiles(5)


library(xlsx)
write.xlsx(x = data.frame(get_estimates(m5)), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output_employee.xlsx",sheetName = "m5", row.names = FALSE, col.names=TRUE,append=TRUE)
```

```{r}
m5_output<-data.frame(get_estimates(m5)) %>%
  filter(Category=="Means") %>% 
  select(Parameter,Estimate,Class) %>%
  mutate(Estimate=round(Estimate,2)) %>% 
  pivot_wider(names_from = Class,values_from =Estimate,names_glue = "Class_{Class}") %>% setNames(.,c("Parameter","Multimodal car-light user","Non-commuting Carpooler","Commuting Carpooler","Bicyclist","SOV User"))
  

library(dplyr)
prop_m5<-get_data(m5) %>% 
  select(CPROB1,CPROB2,CPROB3,CPROB4,CPROB5) %>% 
  setNames(.,c("Multimodal car-light user","Non-commuting Carpooler","Commuting Carpooler","Bicyclist","SOV User")) %>% 
  summarise_all(sum)

library(plyr)
m5_tnc_final<-rbind.fill(prop_m5,m5_output)
detach(package:plyr)

write.xlsx(x = data.frame(m5_tnc_final), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output_employee.xlsx",sheetName = "m5_tnc_output", row.names = FALSE, col.names=TRUE,append=TRUE)
```


```{r}
m5_plot<- m5 %>% 
  plot_profiles()

m5_data<-get_data(m5)

prop_5class<-m5_data %>% 
  select(CPROB1,CPROB2,CPROB3,CPROB4,CPROB5) %>% 
  summarise_all(sum)

m5_data<-cbind(m5_data,mplus$tnc_user,mplus$wktrip_TNC_Commuting,mplus$wktrip_TNC_Non.commuting)

colnames(m5_data)[21]<-'TNC_noncommute'
colnames(m5_data)[20]<-'TNC_commute'
m5_data$wktrip_TNC<-m5_data$TNC_commute+ m5_data$TNC_noncommute
m5_data$wktrip_TNC_dummy<- ifelse(m5_data$wktrip_TNC>0,1,0)

prop_self_report<-m5_data %>% 
  group_by(Class,`mplus$tnc_user`) %>% 
  summarise(n=n()) %>% 
  mutate(perc=n/sum(n))

prop_observe<-m5_data %>% 
  group_by(Class,wktrip_TNC_dummy) %>% 
  summarise(n=n()) %>% 
  mutate(perc=n/sum(n))
    
```



## mclust/ tidyLPA (with TNC)
https://cran.r-project.org/web/packages/tidyLPA/vignettes/Introduction_to_tidyLPA.html
### Num of Classes
```{r}
library(tidyLPA)

class_compare<-mplus_dummy%>% 
  select(
         wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_TNC_Commuting, wktrip_TNC_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>% 
    single_imputation() %>%
    estimate_profiles(1:10, 
                      variances = c("equal", "varying"),
                      covariances = c("zero", "varying")) %>%
    compare_solutions(statistics = c("AIC", "BIC"))

class_compare_fit<-data.frame(class_compare$fits)

library(xlsx)
write.xlsx(x = class_compare_fit, file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "class_compare_TNC", row.names = FALSE, col.names=TRUE, append = TRUE)
```

### m4
```{r}
m4_tnc<- class_compare<-mplus_dummy%>% 
  select(wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_TNC_Commuting, wktrip_TNC_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>% 
    single_imputation() %>%
    estimate_profiles(4)

write.xlsx(x = data.frame(get_estimates(m4_tnc)), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m4_tnc", row.names = FALSE, col.names=TRUE,append=TRUE)

m4_tnc_output<-data.frame(get_estimates(m4_tnc)) %>%
  filter(Category=="Means") %>% 
  select(Parameter,Estimate,Class) %>%
  mutate(Estimate=round(Estimate,2)) %>% 
  pivot_wider(names_from = Class,values_from =Estimate,names_glue = "Class_{Class}") %>% setNames(.,c("Parameter","Bicyclist","Carpooler","Multimodal car-light user","SOV User"))
  
write.xlsx(x = data.frame(m4_tnc_output), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m4_tnc_output", row.names = FALSE, col.names=TRUE,append=TRUE)

library(dplyr)
prop_m4_tnc<-get_data(m4_tnc) %>% 
  select(CPROB1,CPROB2,CPROB3,CPROB4) %>% 
  setNames(.,c("Bicyclist","Carpooler","Multimodal car-light user","SOV User")) %>% 
  summarise_all(sum)

library(plyr)
m4_tnc_final<-rbind.fill(prop_m4_tnc,m4_tnc_output)
detach(package:plyr)

write.xlsx(x = data.frame(m4_tnc_final), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m4_tnc_output", row.names = FALSE, col.names=TRUE,append=TRUE)

```

### m5
```{r}
m5_tnc<- class_compare<-mplus_dummy%>% 
  select(wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_TNC_Commuting, wktrip_TNC_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>% 
    single_imputation() %>%
    estimate_profiles(5)

write.xlsx(x = data.frame(get_estimates(m5_tnc)), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m5_tnc", row.names = FALSE, col.names=TRUE,append=TRUE)

m5_tnc_output<-data.frame(get_estimates(m5_tnc)) %>%
  filter(Category=="Means") %>% 
  select(Parameter,Estimate,Class) %>%
  mutate(Estimate=round(Estimate,2)) %>% 
  pivot_wider(names_from = Class,values_from =Estimate,names_glue = "Class_{Class}") %>% setNames(.,c("Parameter","Bicyclist","Multimodal car-light user","Non-commuting Carpooler","Commuting Carpooler","SOV User"))
  

library(dplyr)
prop_m5_tnc<-get_data(m5_tnc) %>% 
  select(CPROB1,CPROB2,CPROB3,CPROB4,CPROB5) %>% 
  setNames(.,c("Bicyclist","Multimodal car-light user","Non-commuting Carpooler","Commuting Carpooler","SOV User")) %>% 
  summarise_all(sum)

library(plyr)
m5_tnc_final<-rbind.fill(prop_m5_tnc,m5_tnc_output)
detach(package:plyr)

write.xlsx(x = data.frame(m5_tnc_final), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m5_tnc_output", row.names = FALSE, col.names=TRUE,append=TRUE)

```

### m6
```{r}
m6_tnc<- class_compare<-mplus%>% 
  select(wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_TNC_Commuting, wktrip_TNC_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>% 
    single_imputation() %>%
    estimate_profiles(6)

write.xlsx(x = data.frame(get_estimates(m6_tnc)), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m6_tnc", row.names = FALSE, col.names=TRUE,append=TRUE)

m6_tnc_output<-data.frame(get_estimates(m6_tnc)) %>%
  filter(Category=="Means") %>% 
  select(Parameter,Estimate,Class) %>%
  mutate(Estimate=round(Estimate,2)) %>% 
  pivot_wider(names_from = Class,values_from =Estimate,names_glue = "Class_{Class}") %>% setNames(.,c("Parameter","Non-commuting Carpooler","SOV Moderate User","Multimodal Car-light User","SOV Heavy User","Commuting Carpooler","Bicyclist")) 

library(dplyr)
prop_m6_tnc<-get_data(m6_tnc) %>% 
  select(CPROB1,CPROB2,CPROB3,CPROB4,CPROB5,CPROB6) %>% 
  setNames(.,c("Non-commuting Carpooler","SOV Moderate User","Multimodal Car-light User","SOV Heavy User","Commuting Carpooler","Bicyclist")) %>% 
  summarise_all(sum)

library(plyr)
m6_tnc_final<-rbind.fill(prop_m6_tnc,m6_tnc_output)
detach(package:plyr)

write.xlsx(x = data.frame(m6_tnc_final), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m6_tnc_output", row.names = FALSE, col.names=TRUE,append=TRUE)

```

### m6_tnc_summary
```{r}
library(tidyLPA)
m6_tnc_data<-get_data(m6_tnc)
m6_tnc_data<-cbind(m6_tnc_data,pop_7days$person_id,pop_7days$region,pop_7days$tnc_user,pop_7days$wktrip_TNC_Commuting,pop_7days$`wktrip_TNC_Non-commuting`)
colnames(m6_tnc_data)[22:26]<-c('person_id','region','tnc_user','TNC_commute','TNC_noncommute')

m6_tnc_data$wktrip_TNC<-m6_tnc_data$TNC_commute+ m6_tnc_data$TNC_noncommute
m6_tnc_data$wktrip_TNC_dummy<- ifelse(m6_tnc_data$wktrip_TNC>0,1,0)

library(dplyr)
prop_self_report<-m6_tnc_data %>% 
  group_by(Class,tnc_user) %>% 
  summarize(n=n()) %>% 
  mutate(perc=round(n/sum(n),2)) %>% 
  select(Class, tnc_user,perc) %>% 
  pivot_wider(names_from = tnc_user,values_from= perc) %>% 
  setNames(.,c("Class","Non-users","Occasional Users","Frequent Users"))

  

prop_observe<-m6_tnc_data %>% 
  group_by(Class,wktrip_TNC_dummy) %>% 
  summarise(n=n()) %>%
  mutate(perc=round(n/sum(n),2)) %>% 
  select(Class, wktrip_TNC_dummy,perc) %>% 
  pivot_wider(names_from = wktrip_TNC_dummy,values_from= perc) %>% 
  setNames(.,c("Class","Non-users","Users"))

prop_both<-merge(prop_self_report, prop_observe, by="Class")

write.xlsx(x = prop_both, file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m6_tnc_prop", row.names = FALSE, col.names=TRUE,append=TRUE)


prop_self_report_region<-m6_tnc_data %>% 
  group_by(region,Class,tnc_user) %>% 
  summarize(n=n()) %>% 
  mutate(perc=round(n/sum(n),2)) %>% 
  select(region,Class, tnc_user,perc) %>% 
  pivot_wider(names_from = tnc_user,values_from= perc) %>% 
  setNames(.,c("Class","Non-users","Occasional Users","Frequent Users"))

  

prop_observe<-m6_tnc_data %>% 
  group_by(Class,wktrip_TNC_dummy) %>% 
  summarise(n=n()) %>%
  mutate(perc=round(n/sum(n),2)) %>% 
  select(Class, wktrip_TNC_dummy,perc) %>% 
  pivot_wider(names_from = wktrip_TNC_dummy,values_from= perc) %>% 
  setNames(.,c("Class","Non-users","Users"))

prop_both<-merge(prop_self_report, prop_observe, by="Class")

write.xlsx(x = prop_both, file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m6_tnc_prop", row.names = FALSE, col.names=TRUE,append=TRUE)
    
```


#Structrual Model
```{r}
library(mclust)
library(tidyLPA)
mplus = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/mplus_withcolname.csv",colClasses = c('person_id'='character'),header=TRUE))
```

## Model Estimation
### Mclust
```{r}
height_fit_mclust <- Mclust(height)
summary(height_fit_mclust, parameters = TRUE)

m6_tnc<-mplus %>% 
  select(wktrip_SOV_Commuting,wktrip_SOV_Non.commuting,
         wktrip_Carpool_Commuting,wktrip_Carpool_Non.commuting,
         wktrip_TNC_Commuting, wktrip_TNC_Non.commuting,
         wktrip_Transit_Commuting, wktrip_Transit_Non.commuting,
         wktrip_Biking_Commuting,wktrip_Biking_Non.commuting,
         wktrip_Walking_Commuting,wktrip_Walking_Non.commuting) %>%
    single_imputation() %>%
    estimate_profiles(
      n_profiles=6,
      models = 1,
      # variances = "varying",
      # covariances = "varying",
      package = "mclust",
      )

write.xlsx(x = data.frame(get_estimates(m6_tnc)), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m6_tnc", row.names = FALSE, col.names=TRUE,append=TRUE)

m6_tnc_output<-data.frame(get_estimates(m6_tnc)) %>%
  filter(Category=="Means") %>% 
  select(Parameter,Estimate,Class) %>%
  mutate(Estimate=round(Estimate,2)) %>% 
  pivot_wider(names_from = Class,values_from =Estimate,names_glue = "Class_{Class}") %>% setNames(.,c("Parameter","Non-commuting Carpooler","SOV Moderate User","Multimodal Car-light User","SOV Heavy User","Commuting Carpooler","Bicyclist")) 

library(dplyr)
prop_m6_tnc<-get_data(m6_tnc) %>% 
  select(CPROB1,CPROB2,CPROB3,CPROB4,CPROB5,CPROB6) %>% 
  setNames(.,c("Non-commuting Carpooler","SOV Moderate User","Multimodal Car-light User","SOV Heavy User","Commuting Carpooler","Bicyclist")) %>% 
  summarise_all(sum)

library(plyr)
m6_tnc_final<-rbind.fill(prop_m6_tnc,m6_tnc_output)
detach(package:plyr)

write.xlsx(x = data.frame(m6_tnc_final), file = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Paper_Multimodality/Model_Output/Model_output.xlsx",sheetName = "m6_tnc_output", row.names = FALSE, col.names=TRUE,append=TRUE)

```

### poLCA
```{r}
# define formula 
# as.vector(colnames(mplus))
# summary(mplus)
mplus$subsidy_tnc<-mplus$subsidy_tnc+1
mplus$subsidy_transit<-mplus$subsidy_transit+1
mplus$subsidy_other<-mplus$subsidy_other+1

mplus[,2:ncol(mplus)] <- lapply(mplus[,2:ncol(mplus)], as.integer)


mplus_complete <- mplus %>% complete.cases()
poLCA_final <- mplus[mplus_complete, ]

f <- with(poLCA_final, cbind(  wktrip_SOV_Commuting,
                         wktrip_SOV_Non.commuting,
                         wktrip_Carpool_Commuting,
                         wktrip_Carpool_Non.commuting, 
                         wktrip_TNC_Commuting,
                         wktrip_TNC_Non.commuting,
                         wktrip_Transit_Commuting,
                         wktrip_Transit_Non.commuting,
                         wktrip_Biking_Commuting,
                         wktrip_Biking_Non.commuting,
                         wktrip_Walking_Commuting,
                         wktrip_Walking_Non.commuting ) ~ 
            race_ethnicity+
            age+
            gender+
            education+
            stud_emp+
            houseown+
            housetype+
            hhincome+
            hhkid+
            # hhveh_worker+
            subsidy_transit+
            subsidy_tnc+
            subsidy_other+
            home_popdensity+
            home_jobdensity
          ) 


model1 <- 
  poLCA(f, poLCA_final, nclass=6, maxiter=5000, tol=1e-5, 
        na.rm=TRUE, nrep=10, verbose=TRUE, calc.se=FALSE)

summary(poLCA_final)

# reorder classes by size 
vec_class_size_rank <- -(model_0$P) %>% rank()
new.probs.start <- poLCA.reorder(model_0$probs.start, order(vec_class_size_rank))

# rerun model with reordered classes 
model_1 <- 
  poLCA(f, temp01, nclass=4, maxiter=3000, tol=1e-5, 
        na.rm=TRUE, nrep=1, verbose=TRUE, calc.se=FALSE, 
        probs.start = new.probs.start)

model_0$time
model_1$time
# model_1 %>% write_rds(file.path(path_prj, "41_Project1/01_model/02_with covariates", "model_1.rds"))
model_1 <- read_rds("/Users/graceyhchen/Dropbox (GaTech)/25_Southern_Cities/41_Project1/01_model/02_with covariates/model_1.rds")

# compute class probabilites for each case 
model_1$posterior
```



```{r}
# plot class-specific barcharts ----
lcmodel <- model_1$probs %>%  reshape2::melt(level=2)

lcmodel$L2 <- factor(
  lcmodel$L2, 
  levels = c("D5_1", "D5_2", "D5_3", "D5_4", "D5_5", "D5_6", "D5_7", "D5_8"), 
  labels = c("Drive alone", "Drive with others", "Ride with others",
             "Bus", "Rail", "Taxi", "Bicycle or e-scooter", "Walk")
  )

levels(lcmodel$Var1) <- list(
  "Middle-class suburban family"="class 1: ",               
  "Moderate-income urbanite"="class 2: ",         
  "Young affluent urbanite"="class 3: ",   
  "Car-deficient suburbanite"="class 4: "     
)

lcmodel$Var2 <- ordered(lcmodel$Var2, levels = c("Pr(4)", "Pr(3)", "Pr(2)", "Pr(1)"))
levels(lcmodel$Var2) <- list(
  "More often"="Pr(4)", 
  "About the Same"="Pr(3)", 
  "Less often"="Pr(2)", 
  "Changed for other reasons"="Pr(1)")

lcmodel$Changes <- lcmodel$Var2

brks <- 0:10/10

ggplot(lcmodel,aes(x = L2, y = value, fill = Changes)) + 
  geom_bar(stat = "identity", position = "stack", ) + 
  scale_x_discrete(limits = rev(levels(lcmodel$L2))) +  
  scale_y_continuous(breaks = brks, labels = scales::percent(brks)) + 
  coord_flip() +
  facet_grid(Var1 ~ .) + #, switch = "y"
  scale_fill_brewer(type="seq", palette="YlGnBu", direction=-1) + 
  theme_bw() + 
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(), 
        # axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        # axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = rel(1)),
        panel.grid.major.y=element_blank(), 
        strip.text.y.left = element_text(angle = 90), 
        legend.position="bottom", 
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse=TRUE)) 

ggsave(filename = "/Users/graceyhchen/Dropbox (GaTech)/25_Southern_Cities/41_Project1/03_writing/05_figures/lca_4class_0729.png", 
       width = 7, height = 8.4, units = c("in"), dpi = 300)
```



```{r}
# plot at the aggregate level ----

lcmodel %>% as_tibble()

temp02 <-
  temp01 %>%
  select(D5_1, D5_2, D5_3, D5_4, D5_5, D5_6, D5_7, D5_8,
         age_group, income, ln_dep_pop, freq_user, impacts_bigger, env_friendly, pro_den, transit_reliable) %>%
  na.omit() %>%
  pivot_longer(cols = c("D5_1", "D5_2", "D5_3", "D5_4", "D5_5", "D5_6", "D5_7", "D5_8"),
               names_to = "L2", values_to = "Changes") %>%
  mutate(L2 = factor(L2, levels = c("D5_1", "D5_2", "D5_3", "D5_4", "D5_5", "D5_6", "D5_7", "D5_8"),
                     labels = c("Drive alone", "Drive with others", "Ride with others",
                                "Bus", "Rail", "Taxi", "Bicycle or e-scooter", "Walk"))) %>%
  group_by(L2, Changes) %>%
  summarize(n_case = n())

levels(temp02$Changes) <- list(
  "More often"="More",
  "About the Same"="Same",
  "Less often"="Less",
  "Changed for other reasons"="Changed for other reasons")

temp02 %>%
  pivot_wider(names_from = Changes, values_from = n_case) #%>%
#  write_csv(file.path(path_prj, "73_presentation/viz_D5", "D5_count.csv"))

temp02$value <- temp02$n_case/1439

ggplot(temp02, aes(x = L2, y = value, fill = Changes)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_x_discrete(limits = rev(levels(temp02$L2))) +
  scale_y_continuous(breaks = brks, labels = scales::percent(brks)) +
  coord_flip() +
  scale_fill_brewer(type="seq", palette="YlGnBu", direction=-1) +
  theme_bw() +
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        # axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        # axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = rel(1)),
        panel.grid.major.y=element_blank(),
        strip.text.y.left = element_text(angle = 90),
        legend.position="bottom",
        legend.title = element_blank()) +
  guides(fill = guide_legend(reverse=TRUE))

ggsave(filename = "/Users/graceyhchen/Dropbox (GaTech)/25_Southern_Cities/41_Project1/03_writing/05_figures/aggregate.png",
       width = 7, height = 2.7, units = c("in"), dpi = 300)

```





#_______________________
#_______________________

# Overall Summary Table
```{r}
colnames(gender_total)[2]<-'category'
colnames(age_total)[2]<-'category'
colnames(ethnicity_total)[2]<-'category'
colnames(education_total)[2]<-'category'
colnames(income_total)[2]<-'category'
colnames(vehicle_total)[2]<-'category'
# colnames(modeshare1)[2]<-'category'
# colnames(geo)[1]<-'variable'
# modeshare1$category<-as.numeric(modeshare1$category)
# geo$variable<-as.numeric(as.factor(geo$variable))
summary_long<-rbind(num_total,gender_total,age_total,ethnicity_total,education_total,income_total,vehicle_total)
# summary_wide<-dcast(summary_long, variable+Percent~variable,sum)

library(XLConnect)
writeWorksheetToFile("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Results/R_results_4MPOs.xlsx", 
                 data = summary_long, 
                 sheet = "SDE", 
                 header = TRUE,
                 clearSheets = TRUE)


## chi-square of significance
chisq.test(table(pop_7days$gender_final,pop_7days$tnc_user),correct=FALSE)

```







# Summmary Statistics
## Survey periods by region
```{r }

library("dplyr")

complete_person<-mpos4_day %>% subset(survey_complete_day==1) %>% select (person_id, day_num,region) %>% distinct(person_id, .keep_all = TRUE) %>% group_by(region) %>% summarise(n=n())
complete_persondays<-mpos4_day %>% subset(day_complete==1) %>% select (person_id, day_num,region) %>% group_by(region) %>% summarise(n=n())
complete_persondays<-mpos4_day %>% select (person_id, day_num,region) %>% group_by(region) %>% summarise(n=n())
complete_person<-mpos4_per %>% group_by(region) %>% summarise(n=n())
complete_hh<-mpos4_hh %>% group_by(region) %>% summarise(n=n())
complete_trip<-mpos4_trip %>% group_by(region) %>% summarise(n=n())

isTNC_trip<-mpos4_trip %>% subset(is_tnc_trip_new==1)%>% group_by(region) %>% summarise(n=n())
isTNC_per<-na.omit(mpos4_per[,.(region,num_tnc_trips_per)]) %>% group_by(region) %>% summarise(n=sum(num_tnc_trips_per))
table(mpos4_per$num_tnc_trips_per)

TNCdriver<-mpos4_per %>% subset(share_work_drive_tnc==1)%>%group_by(region) %>% summarise(n=n())
TNCuser<-mpos4_per %>% subset(uses_tnc==1 | uses_tnc==0)%>% group_by(region) %>% summarise(n=n())

# survey period
travel_day<- mpos4_per %>% group_by(region) %>% summarise(min=min(first_travel_date))
travel_day<- mpos4_per %>% group_by(region,first_travel_date) %>% summarise(n=n())
travel_day<- mpos4_per %>% group_by(region,last_travel_date) %>% summarise(n=n())

```

## How many survey days
```{r}
# either one day or seven days
survey_day<-mpos4_day %>% 
  group_by(person_id) %>% 
  summarise(num_day=n()) %>% 
  group_by(num_day) %>% 
  summarise(n=n())

survey_day<-mpos4_trip %>% 
  group_by(person_id,day_num) %>% 
  summarise(num_trip=n()) %>%
  distinct(person_id,day_num) %>% 
  group_by(person_id) %>% 
  summarise(n=n()) %>%
  distinct(person_id,n) %>%
  merge(mpos4_per[,c("person_id","region")],by="person_id",all.x=T) %>%
  group_by(n,region) %>% 
  summarise(num_person=n())

day<- survey_day %>%
  pivot_wider(names_from = region, values_from = c(num_person))
  
  
```


## TNC Users

```{r,TNC User}

# nontnc_hh<-mpos4_per[tnc_user_new==0] %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byhh=sum(WEIGHT_HH))

nontnc_per<-mpos4_per[tnc_user_new==0] %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))


# tnc_hh<-mpos4_per[tnc_user_new>0] %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byhh=sum(WEIGHT_HH))


tnc_per<-mpos4_per[tnc_user_new>0] %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))


# tnc_occa_hh<-mpos4_per[tnc_user_new==1] %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byhh=sum(WEIGHT_HH))


tnc_occa_per<-mpos4_per[tnc_user_new==1] %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))


# tnc_freq_hh<-mpos4_per[tnc_user_new==2] %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byhh=sum(WEIGHT_HH))

tnc_freq_per<-mpos4_per[tnc_user_new==2] %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))

# total population 

# total_hh<-mpos4_per %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byhh=sum(WEIGHT_HH))

total_per<-mpos4_per %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))

# total adult
# total_hh_adult<-mpos4_per[mpos4_per$age>3,] %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byhh=sum(WEIGHT_HH))

total_adult<-mpos4_per[mpos4_per$age>3,] %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))

# total_hh_DL<-mpos4_per[mpos4_per$age>3 & mpos4_per$license==1,] %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byper=sum(WEIGHT_HH))

total_adult_DL<-mpos4_per[mpos4_per$age>3 & mpos4_per$license==1,] %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))


# tnc_driver_hh<-mpos4_per[share_work_drive_tnc==1] %>%
#   distinct(hh_id, .keep_all = TRUE) %>%
#   group_by(region) %>%
#   summarize(n=n(),TNC_byper=sum(WEIGHT_HH))

tnc_driver_per<-mpos4_per[share_work_drive_tnc==1] %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER))

tnc_driver<-mpos4_per[share_work_drive_tnc==1] %>%
  group_by(region) %>%
  summarize(TNC_byper=n())

```


```{r, 4MPOs visual}

tnc_per0<-mpos4_per %>%
  subset(tnc_user_new>=0) %>%
  group_by(region) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER)) %>%
  mutate(perc=TNC_byper/sum(TNC_byper))

tnc_per<-mpos4_per %>%
  subset(tnc_user_new>=0) %>%
  group_by(region, tnc_user_new) %>%
  summarize(n=n(),TNC_byper=sum(WEIGHT_PER)) %>%
  mutate(perc=round(TNC_byper/sum(TNC_byper)*100,1))

ggplot_tnc_per<-ggplot(tnc_per, aes(x = region, y=perc, fill=factor(tnc_user_new)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 80)+
  scale_x_discrete(limits=c(c("MTC/SFCTA","SACOG","SANDAG","SCAG")),
    labels=c("MTC/SFCTA\n(n=9123)","SACOG\n(n=6770)","SANDAG\n(n=4450)","SCAG\n(n=2770)" ))+
  scale_fill_manual( labels = c("Non-user", "Occasional user","Frequent user"),values = c("#a6bddb","#2b8cbe","#1A476F" ))+
  geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Region", y="Percentage (%)") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("ggplot_tnc_per.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 3,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


```

```{r,TNC frequency from person table}
###########################################################################
# 
# ## Distribution of number of Taxi/TNCtrips
# 
# frequency<-person17 %>%
#   merge(data.frame(nhts17_weights_person),by=c("HOUSEID","PERSONID")) %>%
#   group_by(RIDESHARE)%>%
#   summarise(count= sum(WEIGHT_HH))
# 
# frequency$Frequency[(frequency$RIDESHARE< 0)] <- "0"
# frequency$Frequency[(frequency$RIDESHARE==0)] <- "0"
# frequency$Frequency[(frequency$RIDESHARE==1)] <- "1"
# frequency$Frequency[(frequency$RIDESHARE==2)] <- "2"
# frequency$Frequency[(frequency$RIDESHARE==3)] <- "3"
# frequency$Frequency[(frequency$RIDESHARE==4)] <- "4"
# frequency$Frequency[(frequency$RIDESHARE>4 & frequency$RIDESHARE<=8)] <- "5-8"
# frequency$Frequency[(frequency$RIDESHARE>8 & frequency$RIDESHARE<=12)] <- "9-12"
# frequency$Frequency[(frequency$RIDESHARE>12 & frequency$RIDESHARE<=16)] <- "12-16"
# frequency$Frequency[frequency$RIDESHARE>16] <- ">16"
# 
# frequency_distribution<-frequency %>%
#   subset(Frequency !="0") %>%
#   group_by(Frequency)%>%
#   summarise(count= sum(count))
# 
# # sum(frequency_distribution$count)/ sum(frequency$count)
# ggplot(data=frequency_distribution, aes(x=Frequency, y=count/1000000))+
#   geom_bar(stat = "identity")+
#   geom_text(aes(label=round(count/1000000,2)), vjust=-0.5)+
#   scale_x_discrete(limits = c("1","2","3","4","5-8","9-12","12-16",">16"))+
#   labs(x="TNC Trip Frequency")+
#   labs(y="Weighted Population (millioin)")+
#   theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))

```

```{r,TNC USER | Socio-demo | by group}
mpos4_per1<-mpos4_per
mpos4_per<-mpos4_per[mpos4_per$tnc_user_new>=0]

num<-mpos4_per %>%
  mutate(variable=1) %>%
  group_by(tnc_user_new,variable) %>%
  summarise(n=n(),Count=sum(WEIGHT_PER))%>%
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop")
num_pop<-mpos4_per %>%
  mutate(variable=1) %>%
  group_by(variable) %>%
  summarise(n=n(),Count=sum(WEIGHT_PER))%>%
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop",tnc_user_new=3)
num_total<-rbind(num, num_pop)
  
# Race
mpos4_per$ethnicity_recode<- ifelse(mpos4_per$ethnicity_white==1, 1,
                          ifelse(mpos4_per$ethnicity_af_am==1,2,
                                 ifelse(mpos4_per$ethnicity_asian==1 | mpos4_per$ethnicity_hapi==1, 3,
                          ifelse(mpos4_per$ethnicity_hisp==1,4,
                                 ifelse (mpos4_per$ethnicity_other==1 | mpos4_per$ethnicity_multi==1 | mpos4_per$ethnicity_aiak==1,5,-1)))))
mpos4_per$ethnicity_recode<-ifelse(mpos4_per$region %in% c("SANDAG","MTC/SFCTA","SCAG") & mpos4_per$ethnicity_mideast==1, 3,mpos4_per$ethnicity_recode)
mpos4_per$ethnicity_recode<-ifelse(is.na(mpos4_per$ethnicity_recode), -1,mpos4_per$ethnicity_recode)


mpos4_per$ethnicity_recode<-ifelse(mpos4_per$ethnicity_recode==-1 & !is.na(mpos4_per$raceeth_imputed),mpos4_per$raceeth_imputed,
                                   ifelse(mpos4_per$ethnicity_recode==5 & mpos4_per$raceeth_imputed %between% c(1,4),mpos4_per$raceeth_imputed,mpos4_per$ethnicity_recode))
# mpos4_per$ethnicity_recode<-ifelse(mpos4_per$ethnicity_recode==-1,mpos4_per$raceeth_imputed,mpos4_per$ethnicity_recode)
a<-mpos4_per[,c("ethnicity_recode","raceeth_imputed")]
table(mpos4_per$ethnicity_recode)

ethnicity<-mpos4_per %>%
  subset(ethnicity_recode>0)%>%
  group_by(tnc_user_new,ethnicity_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="ethnicity")
ethnicity_pop<-mpos4_per %>%
  subset(ethnicity_recode>0)%>%
  group_by(ethnicity_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="ethnicity",tnc_user_new=3)
ethnicity_total<-rbind(ethnicity,ethnicity_pop)




#Age
mpos4_per$age_final<-ifelse(mpos4_per$age<=3,1, #<18
                      ifelse(mpos4_per$age>=4 & mpos4_per$age<=5,2, # 18-34
                         ifelse(mpos4_per$age>=6 &mpos4_per$age<=7,3, # 35-54
                        ifelse(mpos4_per$age>=8 & mpos4_per$age<9,4, # 55-64
                        ifelse(mpos4_per$age>=9,5, -1))))) # 65
age<-mpos4_per %>%
  group_by(tnc_user_new,age_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100,variable="age")
age_pop<-mpos4_per %>%
  group_by(age_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100,variable="age",tnc_user_new=3)
age_total<-rbind(age,age_pop)


# Gender
gender<-mpos4_per %>%
  subset(gender_final>0) %>%
  group_by(tnc_user_new,gender_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="gender")
gender_pop<-mpos4_per %>%
  subset(gender_final>0) %>%
  group_by(gender_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="gender",tnc_user_new=3)
gender_total<-rbind(gender, gender_pop)


# HH Income
mpos4_per$income_adjusted_category<-NULL
mpos4_per<-merge(mpos4_per,mpos4_hh[,c("hh_id","income_adjusted_category")],by="hh_id")

income<-mpos4_per %>%
  subset(income_adjusted_category>0) %>%
  group_by(tnc_user_new,income_adjusted_category,) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="income")
income_pop<-mpos4_per %>%
  subset(income_adjusted_category>0) %>%
  group_by(income_adjusted_category,) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="income",tnc_user_new=3)
income_total<-rbind(income, income_pop)


# Education
# table(mpos4_per$education)
mpos4_per$education_recode<-ifelse(mpos4_per$education %in% c(1,2),1,
               ifelse(mpos4_per$education %in% c(3,4,5),2,
                      ifelse(mpos4_per$education %in% c(6),3,
               ifelse( mpos4_per$education %in% c(7),4,-1))))
               
education<-mpos4_per %>%
  subset(education_recode>0) %>%
  group_by(tnc_user_new,education_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="education")
education_pop<-mpos4_per %>%
  subset(education_recode>0) %>%
  group_by(education_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="education",tnc_user_new=3)
education_total<-rbind(education, education_pop)

# HH VEHICLE
mpos4_per<-merge(mpos4_per,mpos4_hh[,c("hh_id","num_trips_hh")],by="hh_id")
# table(mpos4_per$num_trips_hh)
mpos4_per$hhveh_recode<-ifelse(mpos4_per$num_trips_hh>=1,1,mpos4_per$num_trips_hh)

vehicle<-mpos4_per %>%
  group_by(tnc_user_new,hhveh_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="vehicle")
vehicle_pop<-mpos4_per %>%
  group_by(hhveh_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="vehicle",tnc_user_new=3)
vehicle_total<-rbind(vehicle, vehicle_pop)


# ggplot_veh<-ggplot(fre_perc_large, aes(x = reorder(mode, -perc), y=perc))+ 
#    geom_bar(stat="identity",colour="black", size=.2, alpha=1
#              ,width=0.6, position = position_dodge(width=0.7)) +
#   ylim(0, 80)+
#   scale_fill_brewer(palette="Greys")+
#   scale_x_discrete(limits=c(c("3","13","1","5","36","2","35","23","15","135","4")),
#     labels=c("Car\nOnly","Car+\nWalk","Walk\nOnly","Transit\nOnly","Car+\nOther","Bike\nOnly","Car+\nTransit","Car+\nBike","Transit+\nWalk","Car+\nTransit+\nWalk","TNC\nRelated"))+
#   geom_text(aes(label=Frequency), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
#   geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-1.5,family = "Times") +
#   labs(x="Panel 1: Modes in All Daily Trip Chain", y="Mode Share (%)") +
#   # ggtitle("Composition of Exports to China ($)") + 
#   # scale_fill_manual(values=fill) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 14), 
#     axis.text.y=element_text(colour="black", size = 14),
#     axis.title=element_text(colour="black", size = 14),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="right", legend.direction="vertical", 
#     legend.title = element_blank(),
#     legend.text = element_text(colour="black", size = 14),
#     # panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     text=element_text(family="Times")) +
#   guides(fill = guide_legend(reverse=T))
# 


# # Geographic Location
# mpos4_per<-merge(mpos4_per,mpos4_hh[,c("hh_id","sample_segment")],by="hh_id")
# # table(mpos4_per$sample_segment)
#               
# geo<-mpos4_per %>%
#   group_by(sample_segment,tnc_user_new) %>%
#   summarise(Count = sum(WEIGHT_HH)) %>%
#   mutate(Percent = Count / sum(Count)*100)


# 
# # Pop density
# table(mpos4_per$HBPPOPDN)
# mpos4_per$HBPPOPDN<-ifelse(mpos4_per$HBPPOPDN %in% c("50","300","750"),1,
#                ifelse(mpos4_per$HBPPOPDN %in% c("1500","3000"),2,
#                       ifelse(mpos4_per$HBPPOPDN %in% c("7000"),3,
#                ifelse( mpos4_per$HBPPOPDN %in% c("17000","30000"),4,-1))))
#                
# pop<-mpos4_per %>%
#   group_by(tnc_user_new,HBPPOPDN) %>%
#   summarise(Count = sum(WEIGHT_HH)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,2))

# pop<-mpos4_per %>%
#   group_by(HBPPOPDN) %>%
#   summarise(Count = sum(WEIGHT_HH)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,2))

# Mode Share
# mpos4_trip<-mpos4_trip1
# mpos4_trip$person_id<-as.numeric(mpos4_trip$person_id)
# mpos4_trip<-merge(mpos4_trip,mpos4_per[,c("hh_id","person_id","tnc_user_new")],by=c("hh_id","person_id"))
mpos4_trip<-mpos4_trip[tnc_user_new>=0]
# mpos4_trip$tnc_user_new<-mpos4_trip$tnc_user_new.y
# mpos4_trip$tnc_user_new.x<-NULL
# mpos4_trip$tnc_user_new.y<-NULL


modeshare<-mpos4_trip %>%
  group_by(tnc_user_new,mode_recode) %>%
  summarise(n=n(),Frequency = sum(WEIGHT_TRIP)) %>%
  mutate(Percent = round(Frequency / sum(Frequency)*100,2))

modeshare<-modeshare %>%
    mutate (w=0,
            b=0,
            car=0,
            pt=0,
            # tnc_s=0,
            tnc=0,
            o=0)

for (i in (1:nrow(modeshare))){
  modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
  modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
  modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
  modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
  # modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
  modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
  modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
}

# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s

modeshare1<- melt(modeshare[,c(1,6:11)], id.vars=c("tnc_user_new")) %>%
  group_by(tnc_user_new,variable) %>%
  summarise(n=n(),Count=sum(value)) %>%
  mutate(Percent = round(Count / sum(Count)*100,2))
colnames(modeshare1)[2]<-"category"
modeshare1$variable<-"modeshare"

# # Total Trips
# 
# modeshare<-mpos4_trip %>%
#   group_by(mode_recode,tnc_user_new) %>%
#   mutate(count=1) %>%
#   summarise(Frequency=sum(count))
#   
#   
# 
# modeshare<-modeshare %>%
#     mutate (w=0,
#             b=0,
#             car=0,
#             pt=0,
#             tnc_s=0,
#             tnc=0,
#             o=0)
# 
# for (i in (1:nrow(modeshare))){
#   modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
#   modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
#   modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
#   modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
#   modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
#   modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
#   modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
# }
# 
# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s
# 
# modeshare1<- melt(modeshare[,c(2,4:10)], id.vars=c("tnc_user_new")) %>%
#   group_by(variable,tnc_user_new) %>%
#   summarise(Count=sum(value)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,2))
# 
# sum(modeshare[c(4:10)])

### Overall Summary Table####
colnames(gender_total)[2]<-'category'
colnames(age_total)[2]<-'category'
colnames(ethnicity_total)[2]<-'category'
colnames(education_total)[2]<-'category'
colnames(income_total)[2]<-'category'
colnames(vehicle_total)[2]<-'category'
# colnames(modeshare1)[2]<-'category'
# colnames(geo)[1]<-'variable'
# modeshare1$category<-as.numeric(modeshare1$category)
# geo$variable<-as.numeric(as.factor(geo$variable))
summary_long<-rbind(num_total,gender_total,age_total,ethnicity_total,education_total,income_total,vehicle_total)
# summary_wide<-dcast(summary_long, variable+Percent~variable,sum)

library(XLConnect)
writeWorksheetToFile("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Results/R_results_4MPOs.xlsx", 
                 data = summary_long, 
                 sheet = "SDE", 
                 header = TRUE,
                 clearSheets = TRUE)


## chi-square of significance
chisq.test(table(mpos4_per$gender_final,mpos4_per$tnc_user_new),correct=FALSE)

```


## TNC Drivers
### Socio-demo
```{r,TNC DRIVER | Socio-demo}

#### RECODE

driver<- mpos4_per[mpos4_per$share_work_drive_tnc==1,]

driver_region<-mpos4_per[mpos4_per$share_work_drive_tnc==1,] %>%
  group_by(region) %>%
  summarise(n=n())

  
# Race

mpos4_per$ethnicity_recode<-ifelse(mpos4_per$ethnicity_white==1, 1,
                          ifelse(mpos4_per$ethnicity_af_am==1,2,
                                 ifelse(mpos4_per$ethnicity_asian==1, 3,
                          ifelse(mpos4_per$ethnicity_hisp==1,4,5))))
table(mpos4_per$raceeth_new_imputed,mpos4_per$region)

table(mpos4_per$raceeth_new_imputed)

SACOG<-mpos4_per %>%
  subset(region="SACOG") %>%
  group_by(ethnicity_recode) %>%
  summarise(Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100)

ethnicity<-driver %>%
  group_by(ethnicity_recode) %>%
  summarise(Count = sum(WEIGHT_HH)) %>%
  mutate(Percent = Count / sum(Count)*100)

# race<-mpos4_per %>%
#   group_by(R_RACE) %>%
#   summarise(Count = sum(WEIGHT_HH)) %>%
#   mutate(Percent = Count / sum(Count)*100)


#Age

mpos4_per$age_recode<-ifelse(mpos4_per$age<=3,1, #<18
                      ifelse(mpos4_per$age>=4 &mpos4_per$age<=5,2, # 18-34
                         ifelse(mpos4_per$age>=6 & mpos4_per$age<=7 ,3, # 35-54
                        ifelse(mpos4_per$age==8 ,4, # 55-64
                        ifelse(mpos4_per$age>=9,5, -1))))) # >=65

table(mpos4_per$age_recode)
      
age<-driver %>%
  group_by(age_recode) %>%
  summarise(Count = n()) %>%
  mutate(Percent = Count / sum(Count)*100)


# Gender

# mpos4_per$gender_recode<-ifelse(mpos4_per$gender_imputed>3,3,mpos4_per$gender_imputed)
# table(mpos4_per$gender_recode)

gender_imputed<-driver %>%
  group_by(gender_recode) %>%
  summarise(Count = sum(WEIGHT_HH)) %>%
  mutate(Percent = Count / sum(Count)*100)


# HH Income
# mpos4_per<-merge(mpos4_per,mpos4_hh[,c("hh_id","income_broad")],by="hh_id")
# table(mpos4_per$income_broad)
               
income<-driver %>%
  group_by(income_broad) %>%
  summarise(Count = sum(WEIGHT_HH)) %>%
  mutate(Percent = Count / sum(Count)*100)


# Education
# table(mpos4_per$education)
# mpos4_per$education<-ifelse(mpos4_per$education %in% c(1,2),1,
#                ifelse(mpos4_per$education %in% c(3,4,5),2,
#                       ifelse(mpos4_per$education %in% c(6),3,
#                ifelse( mpos4_per$education %in% c(7),4,999))))
#                
education<-driver %>%
  group_by(education_recode) %>%
  summarise(Count = sum(WEIGHT_HH)) %>%
  mutate(Percent = Count / sum(Count)*100)


# HH VEHICLE
# mpos4_per<-merge(mpos4_per,mpos4_hh[,c("hh_id","num_trips_hh")],by="hh_id")
# table(mpos4_per$num_trips_hh)
# mpos4_per$num_trips_hh<-ifelse(mpos4_per$num_trips_hh>=1,1,mpos4_per$num_trips_hh)

vehicle<-driver %>%
  group_by(hhveh_recode) %>%
  summarise(Count = sum(WEIGHT_HH)) %>%
  mutate(Percent = Count / sum(Count)*100)


# Geographic Location
# mpos4_per<-merge(mpos4_per,mpos4_hh[,c("hh_id","sample_segment")],by="hh_id")
# table(mpos4_per$sample_segment)
              
geo<-driver %>%
  group_by(sample_segment) %>%
  summarise(Count = sum(WEIGHT_HH)) %>%
  mutate(Percent = Count / sum(Count)*100)

# table(mpos4_per$ComType4)
# 
# # Pop density
# table(mpos4_per$HBPPOPDN)
# mpos4_per$HBPPOPDN<-ifelse(mpos4_per$HBPPOPDN %in% c("50","300","750"),1,
#                ifelse(mpos4_per$HBPPOPDN %in% c("1500","3000"),2,
#                       ifelse(mpos4_per$HBPPOPDN %in% c("7000"),3,
#                ifelse( mpos4_per$HBPPOPDN %in% c("17000","30000"),4,-1))))
#                
# pop<-mpos4_per %>%
#   group_by(tnc_user_new,HBPPOPDN) %>%
#   summarise(Count = sum(WEIGHT_HH)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,2))

# pop<-mpos4_per %>%
#   group_by(HBPPOPDN) %>%
#   summarise(Count = sum(WEIGHT_HH)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,2))

# Mode Share
mpos4_trip$person_id<-as.numeric(mpos4_trip$person_id)
mpos4_trip<-merge(mpos4_trip,mpos4_per[,c("hh_id","person_id","share_work_drive_tnc")],by=c("hh_id","person_id"))
# mpos4_trip$share_work_drive_tnc<-mpos4_trip$share_work_drive_tnc.x
# mpos4_trip$share_work_drive_tnc.y<-NULL
# mpos4_trip$share_work_drive_tnc.x<-NULL
modeshare<-mpos4_trip[mpos4_trip$share_work_drive_tnc==1,] %>%
  group_by(mode_recode) %>%
  summarise(Frequency = sum(WEIGHT_TRIP)) %>%
  mutate(Percent = round(Frequency / sum(Frequency)*100,2))

modeshare<-modeshare %>%
    mutate (w=0,
            b=0,
            car=0,
            pt=0,
            tnc_s=0,
            tnc=0,
            o=0)

for (i in (1:nrow(modeshare))){
  modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
  modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
  modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
  modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
  modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
  modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
  modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
}

modeshare$tnc<-modeshare$tnc-modeshare$tnc_s

modeshare1<- melt(modeshare[,c(5:10)]) %>%
  group_by(variable) %>%
  summarise(Count=sum(value)) %>%
  mutate(Percent = round(Count / sum(Count)*100,2))


### Overall Summary Table####
colnames(gender_imputed)[1]<-'variable'
colnames(age)[1]<-'variable'
colnames(ethnicity)[1]<-'variable'
colnames(education)[1]<-'variable'
colnames(income)[1]<-'variable'
colnames(vehicle)[1]<-'variable'
colnames(modeshare1)[1]<-'variable'
colnames(geo)[1]<-'variable'
modeshare1$variable<-as.numeric(modeshare1$variable)
geo$variable<-as.numeric(as.factor(geo$variable))
summary_long<-rbind(gender_imputed,age,ethnicity,education,income,vehicle,modeshare1,geo)

# summary_wide<-dcast(summary_long, variable+Percent~variable,sum)




```

```{r}
### number of jobs on average

driver_employ<-driver_trip_chain_o_m_d %>%
  distinct(person_id) %>%
  merge(mpos4_per[,c("person_id","employment","job_type","num_jobs")], by ="person_id")
driver_employ$num_jobs<-dplyr::recode(driver_employ$num_jobs,  `995` = 0L)
table(driver_employ$num_jobs)
employ0<-driver_employ[driver_employ$num_jobs>=0,] %>%
  group_by(num_jobs) %>%
  summarise(n=n()) %>%
  mutate(perc=n/sum(n))

employ<-driver_employ[driver_employ$num_jobs>=0,] %>%
  group_by(employment) %>%
  summarise(n=mean(num_jobs))
```

### vehicle ownership
```{r}

# HH VEHICLE
mpos4_per<-merge(mpos4_per,mpos4_hh[,c("hh_id","num_vehicles")],by="hh_id")
# table(mpos4_per$num_vehicles)
mpos4_per$hhveh_recode<-ifelse(mpos4_per$num_vehicles>=1,1,mpos4_per$num_vehicles)

# driver<- mpos4_per[mpos4_per$share_work_drive_tnc==1,]

vehicle_user<-mpos4_per %>%
  filter(region=="SANDAG") %>%
  group_by(tnc_user_new,hhveh_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = round(Count / sum(Count)*100,1))

# vehicle_driver<-mpos4_per %>%
#   filter(share_work_drive_tnc==1) %>% 
#   group_by(hhveh_recode) %>%
#   summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,1),tnc_user_new=3)

vehicle_driver<-mpos4_per %>%
  filter(region=="SANDAG") %>%
  filter(share_work_drive_tnc==1) %>% 
  group_by(hhveh_recode) %>%
  summarise(Count=n())%>%
  mutate(Percent = round(Count / sum(Count)*100,1),tnc_user_new=3)

vehicle_pop<-mpos4_per %>%
  filter(region=="SANDAG") %>%
  group_by(hhveh_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = round(Count / sum(Count)*100,1),tnc_user_new=4)

# vehicle_driver<-driver %>%
#   group_by(hhveh_recode) %>%
#   summarise(Count = sum(WEIGHT_HH)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,1),tnc_user_new=3)
nrow(mpos4_per[mpos4_per$region=="SANDAG",])
vehicle_total<-rbind(vehicle_user,vehicle_driver,vehicle_pop)
n<-vehicle_total %>%
  group_by(tnc_user_new) %>%
  summarise(n=sum(n))

HHvehicle_TNCuser_driver_SANDAG<-ggplot(vehicle_total, aes(x = as.factor(tnc_user_new),y=Percent,fill=as.factor(hhveh_recode)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 100)+
  # scale_fill_brewer()+
  # scale_x_discrete(limits=c(c("0","1","2","3","4")),
  #     labels=c("Non-users\n(n=14538)","Occasional Users\n(n=5383)","Freqent Users\n(n=2033)","TNC Drivers\n(n=234)","Total Population\n(n=21954)"))+
    scale_x_discrete(limits=c(c("0","1","2","3","4")),
      labels=c("Non-users\n(n=2672)","Occasional Users\n(n=1188)","Freqent Users\n(n=378)","TNC Drivers\n(n=44)","Total Population\n(n=4801)"))+
  geom_text(aes(label=Percent), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Household vehicle ownership across TNC user groups", y="Percentage (%)") +
  scale_fill_manual(name = "Household\nVehicle\nOwnership", labels = c("No", "Yes"), values = c("#a6bddb","#1A476F"))+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
        plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("HHvehicle_TNCuser_driver_SANDAG.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8.5,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


```

### Mode Share
```{r}
# Mode Share- Driver
mpos4_trip = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_trip.csv",colClasses = c('hh_id'='character','person_id'='character', 'trip_id'='character'),header=TRUE))

mpos4_trip$WEIGHT_TRIP<- ifelse(mpos4_trip$region %in% c("MTC/SFCTA","SANDAG","SCAG"),mpos4_trip$daywt_alladult_7day,mpos4_trip$trip_weight_7day)

mpos4_trip<-merge(mpos4_trip,mpos4_per[,c("hh_id","person_id","share_work_drive_tnc")],by=c("hh_id","person_id"))


# mpos4_trip$share_work_drive_tnc<-mpos4_trip$share_work_drive_tnc.x
# mpos4_trip$share_work_drive_tnc.y<-NULL
# mpos4_trip$share_work_drive_tnc.x<-NULL
modeshare<-mpos4_trip[mpos4_trip$share_work_drive_tnc==1,] %>%
  filter(region=="SANDAG") %>% 
  group_by(mode_recode) %>%
  # summarise(Frequency = sum(WEIGHT_TRIP)) %>%
  summarise(Frequency = n()) %>%
  mutate(Percent = round(Frequency / sum(Frequency)*100,2))

modeshare<-modeshare %>%
    mutate (w=0,
            b=0,
            car=0,
            pt=0,
            tnc=0,
            o=0)

for (i in (1:nrow(modeshare))){
  modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
  modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
  modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
  modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
  modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="tnc")*modeshare$Frequency[i]
  modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
}

modeshare_driver<- melt(modeshare[,c(5:9)]) %>%
  group_by(variable) %>%
  summarise(Count=sum(value)) %>%
  mutate(Percent = round(Count / sum(Count)*100,1),tnc_user_new=3)


### Mode share_user ####
mpos4_trip<-mpos4_trip[tnc_user_new>=0]
# mpos4_trip$tnc_user_new<-mpos4_trip$tnc_user_new.y
# mpos4_trip$tnc_user_new.x<-NULL
# mpos4_trip$tnc_user_new.y<-NULL


modeshare<-mpos4_trip %>%
  filter(region=="SANDAG") %>% 
  group_by(tnc_user_new,mode_recode) %>%
  summarise(Frequency = sum(WEIGHT_TRIP)) %>%
  mutate(Percent = round(Frequency / sum(Frequency)*100,2))

modeshare<-modeshare %>%
    mutate (w=0,
            b=0,
            car=0,
            pt=0,
            # tnc_s=0,
            tnc=0,
            o=0)

for (i in (1:nrow(modeshare))){
  modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
  modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
  modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
  modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
  # modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
  modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
  modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
}

# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s

modeshare_rider<- melt(modeshare[,c(1,5:10)], id.vars=c("tnc_user_new")) %>%
  group_by(tnc_user_new,variable) %>%
  summarise(Count=sum(value)) %>%
  mutate(Percent = round(Count / sum(Count)*100,2))


### Mode share_ general population ####
modeshare<-mpos4_trip %>%
  filter(region=="SANDAG") %>% 
  group_by(mode_recode) %>%
  summarise(Frequency = sum(WEIGHT_TRIP)) %>%
  mutate(Percent = round(Frequency / sum(Frequency)*100,2))

modeshare<-modeshare %>%
    mutate (w=0,
            b=0,
            car=0,
            pt=0,
            # tnc_s=0,
            tnc=0,
            o=0)

for (i in (1:nrow(modeshare))){
  modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
  modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
  modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
  modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
  # modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
  modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
  modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
}

# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s

modeshare_pop<- melt(modeshare[,c(4:9)]) %>%
  group_by(variable) %>%
  summarise(Count=sum(value)) %>%
  mutate(Percent = round(Count / sum(Count)*100,2),tnc_user_new=4) 
  


mode_share_total<-rbind(modeshare_rider,modeshare_driver,modeshare_pop)

tnc_user_driver_mode_share_SANDAG<-ggplot(mode_share_total, aes(x =as.factor(tnc_user_new),y=Percent,fill=as.factor(variable)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 100)+
  # scale_fill_brewer()+
  # scale_x_discrete(limits=c(c("0","1","2","3")),
  #   labels=c("Non-users","Occasional Users","Freqent Users","TNC Drivers"))+
  # geom_text(aes(label=round(Percent,1)), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
    scale_x_discrete(limits=c(c("0","1","2","3","4")),
    labels=c("Non-users\n(n=2672)","Occasional Users\n(n=1188)","Freqent Users\n(n=378)","TNC Drivers\n(n=44)","Total Population\n(n=4801)"))+
  geom_text(aes(label=round(Percent,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Mode Share across TNC User Groups and TNC Drivers", y="Percentage (%)") +
  scale_fill_discrete(name = "Modes", labels = c("Walk", "Bike","Car","Transit","TNC","Other"))+
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("tnc_user_driver_mode_share_SANDAG.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 10,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)
```


## TNC Trips

```{r, Initial Scan} 
###########################################################################
## Total Trips
###########################################################################

############ Based on Assigned Travel Day #############

round(prop.table(table(mpos4_trip$mode_1_primary))*100,2)
round(prop.table(table(mpos4_trip$mode_2_primary))*100,2)
round(prop.table(table(mpos4_trip$mode_3_primary))*100,2)
round(prop.table(table(mpos4_trip$mode_4_primary))*100,2)

round(prop.table(table(mpos4_trip$linking_class))*100,2)


### what modes are combined into 1-walk, 2-bike, 3-car, 4-taxi, 5-transit, 6-school bus, 7-other ####
# walk - 1
table(mpos4_trip[mpos4_trip$mode_type_primary==1 & mpos4_trip$data_source==2,]$mode_1_primary)

# bike - 2,3,4
table(mpos4_trip[mpos4_trip$mode_type_primary==2 & mpos4_trip$data_source==2,]$mode_1_primary)

# car - 6,7,8,9,10,16,17,18,21,22,33,34,47,59
table(mpos4_trip[mpos4_trip$mode_type_primary==3 & mpos4_trip$data_source==2,]$mode_1_primary)
table(mpos4_trip[mpos4_trip$mode_type_primary==3 ,]$mode_1_primary)

# taxi - 36,37,49,60
table(mpos4_trip[mpos4_trip$mode_type_primary==4 & mpos4_trip$data_source==2,]$mode_1_primary)

# transit - 23  25  26  28  30 32 38  39  41  42  55  61 (add on 62,24)
table(mpos4_trip[mpos4_trip$mode_type_primary==5 & mpos4_trip$data_source==2,]$mode_1_primary)
table(mpos4_trip[mpos4_trip$mode_type_primary==5 ,]$mode_1_primary)

# school bus - 24 (move to transit)
table(mpos4_trip[mpos4_trip$mode_type_primary==6 & mpos4_trip$data_source==2,]$mode_1_primary)

# other - 5,31,43,44,45 (move 62 to transit)
table(mpos4_trip[mpos4_trip$mode_type_primary==7 & mpos4_trip$data_source==2,]$mode_1_primary)



### what trip purposes are combined into 1-home, 2-work, 3-work-related, 4-school, 5-escort, 6-shop, 7-meal, 8-social/recreation, 9-errand/other, 10-change mode ####
# 1-home - 1
table(mpos4_trip[mpos4_trip$o_purpcat==1 ,]$o_purpose)

# 2-work - 10
table(mpos4_trip[mpos4_trip$o_purpcat==2 ,]$o_purpose)

# 3-work-related - 11   12   13   14 
table(mpos4_trip[mpos4_trip$o_purpcat==3 ,]$o_purpose)

# 4-school - 20   21   22   23   24   25 (add on 4)
table(mpos4_trip[mpos4_trip$o_purpcat==4 ,]$o_purpose)

# 5-escort -  40   41   42   43   44 
table(mpos4_trip[mpos4_trip$o_purpcat==5 ,]$o_purpose)

# 6-shop - 30   31   32   36
table(mpos4_trip[mpos4_trip$o_purpcat==6 ,]$o_purpose)

# 7	Meal - 50
table(mpos4_trip[mpos4_trip$o_purpcat==7 ,]$o_purpose)

# 8-social/recreation - 51   52   53   54   55   56   62
table(mpos4_trip[mpos4_trip$o_purpcat==8 ,]$o_purpose)

# 9-errand/other - 33    34    37    61   997 
table(mpos4_trip[mpos4_trip$o_purpcat==9 ,]$o_purpose)

# 10-change mode - 60
table(mpos4_trip[mpos4_trip$o_purpcat==10 ,]$o_purpose)

```

### Party size
```{r, Travel Party Size}
detach(package:plyr)
library("dplyr")
library(stringr)
#### Distinguish TNC pool/non-pool trips ####
tnc_trip<-mpos4_trip %>%
  filter(str_detect(mode_recode, "tnc") | is_tnc_trip_new==1) %>%
  mutate (pool=ifelse(str_detect(mode_recode, "tnc_s")| mode_uber== 1 | mode_lyft==1,1,0))
tnc_trip$pool[is.na(tnc_trip$pool)]<-0
daily_tnc<- tnc_trip %>%
  group_by(pool)%>%
  summarize(daily_tnc=sum(WEIGHT_TRIP))

# a<-tnc_trip[,.(tnc_pooled,num_hh_travelers,num_non_hh_travelers,pool)]

#### traveler size ####
tnc_travelsize<-tnc_trip %>%
  filter(num_travelers>=0 & num_non_hh_travelers >=0 & num_hh_travelers>=0 & !is.na(day_time)) %>%
  mutate(all=sum(WEIGHT_TRIP)) %>%
  group_by(pool,day_time,all,region) %>%
  summarize(sample=n(),weightcount=sum(WEIGHT_TRIP),avg=sum(num_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),hh=sum(num_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),nonhh= sum(num_non_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP)) %>%
  mutate(perc=weightcount/all)


pv_travelsize<-mpos4_trip %>%
  filter(str_detect(mode_recode, "car") & !is.na(day_time)) %>%
  mutate(all=sum(WEIGHT_TRIP)) %>%
  group_by(day_time,all,region) %>%
  summarize(sample=n(),weightcount=sum(WEIGHT_TRIP),hh=sum(num_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),nonhh= sum(num_non_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),avg=sum(num_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP))%>%
  mutate(perc=weightcount/all,pool=2)

travelsize<-rbind(tnc_travelsize, pv_travelsize)

travelsize$pool<-as.factor(travelsize$pool)

ggplot_travelsize_region<-ggplot(travelsize, aes(x =pool,y=avg,fill=day_time))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 4)+
  # scale_fill_brewer()+
  # scale_x_discrete(limits=c(c("0","1","2")),
  #   labels=c("TNC Non-pooled","TNC Pooled","Private Vehicle"))+
  # geom_text(aes(label=round(avg,1)), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
    scale_x_discrete(limits=c(c("0","1","2")),
    labels=c("Non-pooled","Pooled","PV"))+
  scale_fill_discrete(name = "Time Peroids", labels = c("Weekday","Weekend","Weekend night","Weeknight"))+
  facet_grid(. ~ region)+
  geom_text(aes(label=round(avg,1)), position = position_dodge(width = 0.7), vjust=-0.2,size =3) +
  labs(x="Vehicle Occupancy of TNC Services and Private Vehicle", y="Average Occupancy") +
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 14,face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("ggplot_travelsize_region.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 13,
  height = 5,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


ggplot_travelsize_region_notime<-ggplot(travelsize, aes(x =pool,y=avg))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 4)+
  # scale_fill_brewer()+
  # scale_x_discrete(limits=c(c("0","1","2")),
  #   labels=c("TNC Non-pooled","TNC Pooled","Private Vehicle"))+
  geom_text(aes(label=round(avg,1)), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
    scale_x_discrete(limits=c(c("0","1","2")),
    labels=c("Non-pooled","Pooled","PV"))+
  scale_fill_manual(values = c("#a6bddb"))+
  # scale_fill_discrete(name = "Time Peroids", labels = c("Weekday","Weekend","Weekend night","Weeknight"))+
  facet_grid(. ~ region)+
  # geom_text(aes(label=round(avg,1)), position = position_dodge(width = 0.7), vjust=-0.2,size =3) +
  labs(x="Vehicle Occupancy of TNC Services and Private Vehicle", y="Average Occupancy") +
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 14,face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("ggplot_travelsize_region_notime.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 13,
  height = 5,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

```

### Party size_no time
```{r, Travel Party Size}
detach(package:plyr)
library("dplyr")
library(stringr)
#### Distinguish TNC pool/non-pool trips ####
tnc_trip<-mpos4_trip %>%
  filter(str_detect(mode_recode, "tnc") | is_tnc_trip_new==1) %>%
  mutate (pool=ifelse(str_detect(mode_recode, "tnc_s")| mode_uber== 1 | mode_lyft==1,1,0))
tnc_trip$pool[is.na(tnc_trip$pool)]<-0
daily_tnc<- tnc_trip %>%
  group_by(pool)%>%
  summarize(daily_tnc=sum(WEIGHT_TRIP))

# a<-tnc_trip[,.(tnc_pooled,num_hh_travelers,num_non_hh_travelers,pool)]

#### traveler size ####
tnc_travelsize<-tnc_trip %>%
  filter(num_travelers>=0 & num_non_hh_travelers >=0 & num_hh_travelers>=0 & !is.na(day_time)) %>%
  mutate(all=sum(WEIGHT_TRIP)) %>%
  group_by(pool,all,region) %>%
  summarize(sample=n(),weightcount=sum(WEIGHT_TRIP),avg=sum(num_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),hh=sum(num_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),nonhh= sum(num_non_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP)) %>%
  mutate(perc=weightcount/all)


pv_travelsize<-mpos4_trip %>%
  filter(str_detect(mode_recode, "car") & !is.na(day_time)) %>%
  mutate(all=sum(WEIGHT_TRIP)) %>%
  group_by(all,region) %>%
  summarize(sample=n(),weightcount=sum(WEIGHT_TRIP),hh=sum(num_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),nonhh= sum(num_non_hh_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP),avg=sum(num_travelers*WEIGHT_TRIP)/sum(WEIGHT_TRIP))%>%
  mutate(perc=weightcount/all,pool=2)

travelsize<-rbind(tnc_travelsize, pv_travelsize)

travelsize$pool<-as.factor(travelsize$pool)


ggplot_travelsize_region_notime<-ggplot(travelsize, aes(x =pool,y=avg,fill="#1A476F"))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 2.5)+
  # scale_fill_brewer()+
  # scale_x_discrete(limits=c(c("0","1","2")),
  #   labels=c("TNC Non-pooled","TNC Pooled","Private Vehicle"))+
  geom_text(aes(label=round(avg,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
    scale_x_discrete(limits=c(c("0","1","2")),
    labels=c("Non-pooled","Pooled","PV"))+
  scale_fill_manual(values = c("#a6bddb"))+
  # scale_fill_discrete(name = "Time Peroids", labels = c("Weekday","Weekend","Weekend night","Weeknight"))+
  facet_grid(. ~ region)+
  # geom_text(aes(label=round(avg,1)), position = position_dodge(width = 0.7), vjust=-0.2,size =3) +
  labs(x=" \n Vehicle Occupancy of TNC Services and Private Vehicle", y="Average Occupancy") +
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 14,face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("ggplot_travelsize_region_notime.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 13,
  height = 5,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

```

### Trip purpose
#### Recode
```{r,Trip Purpose & Mode Recode & Create O_mode_D}
###########################################################################
## Trip Purpose
###########################################################################
################### Changing Category 
library("plyr")

## re-define the trip purpose -- home1-mandatory-2-maintenance3-discretionary4-transfer5-other6

# table(mpos4_trip$o_purpose)
# table(mpos4_trip$o_purpcat)
mpos4_trip$o_purpcat_recode<-as.numeric(revalue(as.character(mpos4_trip$o_purpcat), c("0" = "-9998","3" = "2", "4" = "3", "6" = "4", "7" = "6", "8" = "6", "10" = "7","9" = "8" )))
table(mpos4_trip$o_purpcat_recode)
# summary(mpos4_trip$o_purpcat_recode)

# table(mpos4_trip$d_purpose)
# table(mpos4_trip$d_purpcat)
mpos4_trip$d_purpcat_recode<-as.numeric(revalue(as.character(mpos4_trip$d_purpcat), c("0" = "-9998","3" = "2", "4" = "3", "6" = "4", "7" = "6", "8" = "6", "10" = "7","9" = "8" )))
# table(mpos4_trip$d_purpcat_recode)
# summary(mpos4_trip$d_purpcat_recode)


## re-define the trip mode -- new mobility(tnc), motor(mo), Public Transportation(pt), Active Transportation (bw), Airport Transportation(at)

# table(mpos4_trip$mode_1_primary)
# table(mpos4_trip$mode_type_primary)

mpos4_trip$mode_1_primary_recode<-revalue(as.character(mpos4_trip$mode_1_primary), c("1"="w","2"="b","3"="b","4"="b","5"="o","6"="car","7"="car","8"="car","9"="car","10"="car","11"="car","12"="car","13"="car","16"="car","17"="car","18"="car","21"="car","22"="car","23"="pt","24"="pt","25"="pt","26"="pt","28"="pt","30"="pt","31"="o","32"="pt","33"="car","34"="car","36"="car","37"="tnc_s","38"="pt","39"="pt","41"="pt","42"="pt","43"="o","44"="o","45"="o","47"="car","49"="tnc","55"="pt","59"="car","60"="car","61"="pt","62"="pt"))

mpos4_trip$mode_2_primary_recode<-revalue(as.character(mpos4_trip$mode_2_primary), c("1"="w","2"="b","3"="b","4"="b","5"="o","6"="car","7"="car","8"="car","9"="car","10"="car","11"="car","12"="car","13"="car","16"="car","17"="car","18"="car","21"="car","22"="car","23"="pt","24"="pt","25"="pt","26"="pt","28"="pt","30"="pt","31"="o","32"="pt","33"="car","34"="car","36"="car","37"="tnc_s","38"="pt","39"="pt","41"="pt","42"="pt","43"="o","44"="o","45"="o","47"="car","49"="tnc","55"="pt","59"="car","60"="car","61"="pt","62"="pt"))

mpos4_trip$mode_3_primary_recode<-revalue(as.character(mpos4_trip$mode_3_primary), c("1"="w","2"="b","3"="b","4"="b","5"="o","6"="car","7"="car","8"="car","9"="car","10"="car","11"="car","12"="car","13"="car","16"="car","17"="car","18"="car","21"="car","22"="car","23"="pt","24"="pt","25"="pt","26"="pt","28"="pt","30"="pt","31"="o","32"="pt","33"="car","34"="car","36"="car","37"="tnc_s","38"="pt","39"="pt","41"="pt","42"="pt","43"="o","44"="o","45"="o","47"="car","49"="tnc","55"="pt","59"="car","60"="car","61"="pt","62"="pt"))

mpos4_trip$mode_4_primary_recode<-revalue(as.character(mpos4_trip$mode_4_primary), c("1"="w","2"="b","3"="b","4"="b","5"="o","6"="car","7"="car","8"="car","9"="car","10"="car","11"="car","12"="car","13"="car","16"="car","17"="car","18"="car","21"="car","22"="car","23"="pt","24"="pt","25"="pt","26"="pt","28"="pt","30"="pt","31"="o","32"="pt","33"="car","34"="car","36"="car","37"="tnc_s","38"="pt","39"="pt","41"="pt","42"="pt","43"="o","44"="o","45"="o","47"="car","49"="tnc","55"="pt","59"="car","60"="car","61"="pt","62"="pt"))

# table(mpos4_trip$mode_1_primary_recode)
# table(mpos4_trip$mode_2_primary_recode)
# table(mpos4_trip$mode_3_primary_recode)
# table(mpos4_trip$mode_4_primary_recode)

detach(package:plyr)
library("dplyr")

tnc<-mpos4_trip %>% 
  filter(mode_recode)
table(mpos4_trip$mode_recode)

################### Link multiple modes ####

# chain ID & O_mode_D 
mpos4_trip[,c("person_id","placeidR")] <- lapply(mpos4_trip[,c("person_id","placeidR")], as.character)

mpos4_trip$mode_recode<-
  ifelse (mpos4_trip$mode_2_primary_recode=="0" & mpos4_trip$mode_3_primary_recode=="0" & mpos4_trip$mode_4_primary_recode=="0",mpos4_trip$mode_1_primary_recode,
          ifelse(mpos4_trip$mode_3_primary_recode=="0" & mpos4_trip$mode_4_primary_recode=="0", apply(mpos4_trip[, c("mode_1_primary_recode","mode_2_primary_recode")],1,paste, collapse = "-" ),
                 ifelse( mpos4_trip$mode_4_primary_recode=="0",apply(mpos4_trip[, c("mode_1_primary_recode","mode_2_primary_recode","mode_3_primary_recode")],1,paste, collapse = "-" ),
  apply(mpos4_trip[, c("mode_1_primary_recode","mode_2_primary_recode","mode_3_primary_recode", "mode_4_primary_recode")],1,paste, collapse = "-" ))))

library("stringr")
mpos4_trip$mode_recode <- gsub("b-b","b",mpos4_trip$mode_recode)
mpos4_trip$mode_recode <- gsub("pt-pt","pt",mpos4_trip$mode_recode)
mpos4_trip$mode_recode <- gsub("car-car","car",mpos4_trip$mode_recode)
mpos4_trip$mode_recode <- gsub("car-car-car","car",mpos4_trip$mode_recode)

table(mpos4_trip$mode_recode)


################### Link each O_MODE_D ####
# mpos4_trip<-mpos4_trip1
mpos4_trip<-mpos4_trip %>%
  mutate(o_d=paste0(o_purpcat_recode,sep = "_", d_purpcat_recode,collapse = NULL)) %>%
  mutate(o_mode_d=paste0(o_purpcat_recode,sep = "_",mode_recode,sep = "_", d_purpcat_recode,collapse = NULL)) %>%
  mutate(o_mode=paste0(o_purpcat_recode,sep = "_",mode_recode,sep = "_",collapse = NULL)) %>%
  mutate(mode_d=paste0(mode_recode,sep = "_",d_purpcat_recode,sep = "_",collapse = NULL)) %>%
  mutate(mode_d=paste0(mode_recode,sep = "_",d_purpcat_recode,collapse = NULL)) %>% 
  mutate(mode_d_nextmode= paste0(mode_d,sep = "_",lead(mode_recode),collapse = NULL)) %>% 
  mutate(priormode_o_mode= paste0(lag(mode_recode),sep = "_",o_purpcat_recode,sep = "_",mode_recode,collapse = NULL))

# mpos4_trip<-mpos4_trip %>%
#   mutate(mode=paste0(mode_recode,sep = "_",collapse = NULL))

# write.csv(mpos4_trip,"mpos4_trip_processed.csv", row.names = FALSE)

# mpos4_trip1<-mpos4_trip

```


#### Chord diagram
```{r,Trip Purpose  | Chord Diagram}
library("dplyr")

tnc_trip<-mpos4_trip %>%
  filter(str_detect(mode_recode, "tnc") | is_tnc_trip_new==1 ) %>%
  filter(driver!=2) %>% 
  filter(d_purpcat_recode==5)
write.csv(tnc_trip,"tnc_trip.csv", row.names = F)


tnc_trip<-mpos4_trip %>%
  filter( is_tnc_trip==1) 
  

table(tnc_trip$driver,tnc_trip$region)

car_trip<-mpos4_trip %>%
  filter(str_detect(mode_recode, "car")) 

table(car_trip$driver)



#########  only 2017 TNC trips
tnc<-tnc_trip %>%
  filter(o_purpcat_recode>0 & d_purpcat_recode>0 ) %>%
  # select(WHYFROM, WHYTO,WHYO_mode_D,WEIGHT_HH=WEIGHT_HH) %>%
  mutate(O_D=paste0(o_purpcat_recode,sep="-->",d_purpcat_recode,collapse=NULL)) %>%
  group_by(O_D) %>%
  summarise(count = sum(WEIGHT_TRIP)) 
total_count<-sum(tnc$count)
tnc<-tnc%>%
  mutate(perc= count/total_count*100)  


# write.table(tnc,file="MPOS4_tnc_purpose.csv",row.names=FALSE, na="")



# ################### TNC TRIP PURPOSE ####
# trip_w_tnc<-mpos4_trip_w %>%
#   filter(str_detect(WHYO_mode_D, "tnc"))
# 
# trip_w_tnc$Type<-"Other-Other"
# trip_w_tnc$Type<-ifelse(trip_w_tnc$WHYFROM %in% c("97","-9","-8","-7","-1") | trip_w_tnc$WHYTO %in% c("97","-9","-8","-7","-1"),"Unknown", trip_w_tnc$Type)
# trip_w_tnc$Type<-ifelse(trip_w_tnc$WHYFROM=="1"| trip_w_tnc$WHYTO=="1", "H-Other", trip_w_tnc$Type)
# trip_w_tnc$Type<-ifelse((trip_w_tnc$WHYFROM=="1" & trip_w_tnc$WHYTO=="5")|(trip_w_tnc$WHYFROM=="5"& trip_w_tnc$WHYTO=="1"), "H-Transit", trip_w_tnc$Type)
# 
# # home1-mandatory2-maintenance3-discretionary4-transfer5-other97
# 
# trip_w_tnc_agg<-trip_w_tnc %>% 
#   group_by(TRIPPURP) %>% 
#   summarise(Frequency = sum(WEIGHT_HH)) %>%
#   mutate(perc = Frequency / sum(Frequency)) %>%
#   mutate(year="2017")
# # sum(trip_w_tnc_agg$Frequency)
# 
# # trip_w_tnc_agg$category<-c("NHB","HBSOCREC","HBO","HBSHOP","HBW")
# ggplot(trip_w_tnc_agg, aes(x = reorder(TRIPPURP, -perc), y = perc, fill=TRIPPURP))+
#   geom_bar(stat = "identity")+
#   geom_text(aes(label=round(perc,4)*100), vjust=-0.5)+
#   scale_y_continuous(labels = scales::percent)+
#   scale_fill_grey(start = 0.2, end = 0.7)+
#   labs(x="OD of TNC trips")+
#   labs(y="Percentage")+
#   theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))
```

```{r, chord diagrams for all trip purpose}
library('circlize') 
library('stringr')
library('reshape')
# matrix2017<- matrix(1:25, nrow = 5, ncol = 5,
#                     dimnames = list(c("Home","Mandatory","Flexible","Optional","Mode Transfer"), c("Home","Mandatory","Flexible","Optional","Mode Transfer")))

# eliminate 97 in tnc17

setwd("~/Box/Clean Mile Standard/DataAnalysis/R_input")
tnc_OD = read.csv("MPOS4_tnc_purpose_cast.csv", header=TRUE)[,-1]
# tnc_OD$origin<-str_sub(tnc_OD$O_D,start=1,1)
# tnc_OD$destination<-str_sub(tnc_OD$O_D,start=-1,-1)
# tnc_OD$O_D<-NULL
# # cast the melted data
# tnc_OD_cast <- dcast(tnc_OD, origin ~ destination)
# timemeans <- cast(mdata, time~variable, mean)
tnc_OD<-round(prop.table(tnc_OD)*100,2)
rownames(tnc_OD)<-c("Home","Work","School","Maintenance","Escort","Discretionary","Change mode","Other")
colnames(tnc_OD)<-c("Home","Work","School","Maintenance","Escort","Discretionary","Change mode","Other")
tnc_OD<-as.matrix(tnc_OD)
# class(tnc_OD_perc) <- "numeric"

# A loop to create 9 circular plots

# par(mar = c(0.1, 0.1, 0.1, 0.1) )
# factors = 1:3
# circos.par(cell.padding = c(0, 0, 0, 0))
# circos.initialize(factors, xlim = c(0, 1))

# layout(matrix(1:3, 1, 3))

# color
grid.col = c(Home = "mediumseagreen", Work = "skyblue4", School = "skyblue4", Maintenance = "plum4", Discretionary = "gold4", `Change mode`= "black", Escort="wheat1", Other ="gray55")
# # grey
# grid.col = c(Home = "gray90", Mandatory = "gray70", Flexible = "gray50",
#              Optional = "gray25", Mode_Transfer = "gray0")

# col_mat = rand_color(length(tnc17), transparency = 0.5)
# dim(col_mat) = dim(tnc17)  # to make sure it is a matrix
    
chordDiagram(tnc_OD,order = c("Home","School","Work","Maintenance","Discretionary","Escort","Other","Change mode"), grid.col = grid.col,transparency = 0.3)

circos.clear()


#### Summary Statistics####
home_based<-(sum(tnc_OD[1,])+sum(tnc_OD[,1])-tnc_OD[1,1])/2
discretionary<- (sum(tnc_OD[6,])+sum(tnc_OD[,6])-tnc_OD[6,6])/2
mandatory<-(sum(tnc_OD[2:3,])+sum(tnc_OD[,2:3])-sum(tnc_OD[2:3,2:3]))/2
modetransfer<-(sum(tnc_OD[7,])+sum(tnc_OD[,7])-sum(tnc_OD[7,7]))/2


# # library
# library(circlize)
# # Arrange the layout
# layout(matrix(1:9, 3, 3)) 
#  
# # A loop to create 9 circular plots
# for(i in 1:9) {
#     par(mar = c(0.5, 0.5, 0.5, 0.5), bg=rgb(1,1,1,0.1) )
#     factors = 1:8
#     circos.par(cell.padding = c(0, 0, 0, 0)) 
#     circos.initialize(factors, xlim = c(0, 1)) 
#     circos.trackPlotRegion(ylim = c(0, 1), track.height = 0.05, bg.col = rand_color(8), bg.border = NA ) 
#  
#     # add links
#     for(i in 1:20) {
#         se = sample(1:8, 2)
#         circos.link(se[1], runif(2), se[2], runif(2), col = rand_color(1, transparency = 0.4)) 
#         
#     }
#     circos.clear()
# }

```

```{r, chord diagram example}
# # library
# library(circlize)
# # Arrange the layout
# layout(matrix(1:9, 3, 3)) 
#  
# # A loop to create 9 circular plots
# for(i in 1:9) {
#     par(mar = c(0.5, 0.5, 0.5, 0.5), bg=rgb(1,1,1,0.1) )
#     factors = 1:8
#     circos.par(cell.padding = c(0, 0, 0, 0)) 
#     circos.initialize(factors, xlim = c(0, 1)) 
#     circos.trackPlotRegion(ylim = c(0, 1), track.height = 0.05, bg.col = rand_color(8), bg.border = NA ) 
#  
#     # add links
#     for(i in 1:20) {
#         se = sample(1:8, 2)
#         circos.link(se[1], runif(2), se[2], runif(2), col = rand_color(1, transparency = 0.4)) 
#         
#     }
#     circos.clear()
# }
```

### Trip Time-of-day
```{r, Asymmatric OD--time of the day}

tnc_trip$timeperoid<-ifelse(tnc_trip$depart_time_decimal>=5 & tnc_trip$depart_time_decimal<10,"Morning",
                        ifelse(tnc_trip$depart_time_decimal>=10 & tnc_trip$depart_time_decimal<15,"Midday",
                               ifelse(tnc_trip$depart_time_decimal>=15 & tnc_trip$depart_time_decimal<19,"Afternoon",
                                      ifelse(tnc_trip$depart_time_decimal>=19 & tnc_trip$depart_time_decimal<23,"Evening",ifelse(tnc_trip$depart_time_decimal>=23 | tnc_trip$depart_time_decimal<5,"Night","NA")))))

tnc_trip$chaintype<-ifelse (tnc_trip$o_purpcat_recode==1 & tnc_trip$d_purpcat_recode==2,"Home-Work",
                ifelse (tnc_trip$o_purpcat_recode==2 & tnc_trip$d_purpcat_recode==1,"Work-H",
                ifelse (tnc_trip$o_purpcat_recode==1 & tnc_trip$d_purpcat_recode==3,"Home-School",
                ifelse (tnc_trip$o_purpcat_recode==3 & tnc_trip$d_purpcat_recode==1, "School-Home",
                ifelse (tnc_trip$o_purpcat_recode==1 & tnc_trip$d_purpcat_recode==7,"Home-Change mode",
                ifelse (tnc_trip$o_purpcat_recode==7 & tnc_trip$d_purpcat_recode==1,"Change mode-Home",NA))))))
tnc_trip1<-tnc_trip[!is.na (tnc_trip$chaintype)]

summary<-tnc_trip1 %>%
  group_by(chaintype,timeperoid) %>% 
  summarise(Frequency = sum(WEIGHT_TRIP))

total_Frequency<-sum(summary$Frequency)
summary<-summary%>%
  mutate(perc = round(Frequency/total_Frequency,4))

tnc_trip<-mpos4_trip %>%
  filter(str_detect(mode_recode, "tnc")) %>%
  mutate (pool=ifelse(str_detect(mode_recode, "tnc_s"),1,0))

daily_tnc<- tnc_trip %>%
  # group_by(pool)%>%
  summarize(daily_tnc=sum(WEIGHT_TRIP))

summary$perc_all<-round(summary$Frequency/daily_tnc$daily_tnc,2)
summary$timeperoid <- factor(summary$timeperoid, levels=c("Morning","Midday","Afternoon","Evening","Night"))
summary$chaintype <- factor(summary$chaintype, levels=c("Home-Work","Work-H","Home-School","School-Home","Home-Change mode","Change mode-Home"))

# ggplot(summary, aes(x=chaintype,y=Frequency/1000, fill=hourperoid))+ 
#     geom_bar(stat="identity",colour="black", size=.2, alpha=1
#              ,width=0.6, position = position_dodge(width=0.7)) +
#     scale_fill_brewer(palette="Greys", breaks=rev(levels(summary$hourperoid)),
#                       labels=c("  Late Night (22-4)","  Evening (18-22)","  Afternoon (12-18)","  Morning (4-12)"))+
#   labs(x="OD", y="Trip (Thousand)") +
#   # ggtitle("Composition of Exports to China ($)") + 
#   # scale_fill_manual(values=fill) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 14), 
#     axis.text.y=element_text(colour="black", size = 14),
#     axis.title=element_text(colour="black", size = 14),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="right", legend.direction="vertical", 
#     legend.title = element_blank(),
#     legend.text = element_text(colour="black", size = 14),
#     panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     text=element_text(family="Times")) +
#   guides(fill = guide_legend(reverse=T))

library(ggplot2)
ggplot(summary, aes(x=chaintype,y=perc_all*100, fill=timeperoid))+
    geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
    scale_fill_brewer(name="Travel Time",
      palette="Greys", breaks=rev(levels(summary$timeperoid)),
                      labels=c("Morning(5am-10am)","Midday(10am-3pm)","Afternoon(3pm-7pm)","Evening(7pm-11pm)","Night(11pm-5am)"))+
  labs(x="Activity Type by Origin-Destination", y="% of Total Trips") +
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 14), 
    axis.text.y=element_text(colour="black", size = 14),
    axis.title=element_text(colour="black", size = 16),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_text(size = 16, family = "Times", face = "bold"), 
    legend.text = element_text(colour="black", size = 14),
    panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 16, family = "Times", face = "bold"), 
    text=element_text(family="Times")) +
  guides(fill = guide_legend(reverse=T))

```

```{r,Daily Distribution--aggregated bar chat }
###########################################################################
##  Daily Distribution--aggregated bar chat
###########################################################################
### transfer DATE--TIME format ###
## year-month
# mpos4_trip$TDAYyear <-str_sub(mpos4_trip$TDAYDATE,1,4)
# mpos4_trip$TDAYmonth<- str_sub(mpos4_trip$TDAYDATE,-2,-1)
# mpos4_trip$TDAYym<-paste0 (mpos4_trip$TDAYyear,sep = "-", mpos4_trip$TDAYmonth,collapse = NULL)
# mpos4_trip$TDAYym_final<-as.yearmon(mpos4_trip$TDAYym,"%Y-%m")
## hour-min
trip01<-nhts01$data$trip
trip09<-nhts09$data$trip
mpos4_trip<-nhts17$data$trip

mpos4_trip$TIMEhhs <- substr(mpos4_trip$STRTTIME,1,nchar(mpos4_trip$STRTTIME)-2)
mpos4_trip$TIMEmms<-str_sub(mpos4_trip$STRTTIME,-2,-1)
mpos4_trip$TIMEhhmms<-paste0 (mpos4_trip$TIMEhhs,sep = ":", mpos4_trip$TIMEmms,collapse = NULL)
# mpos4_trip$TIMEhhmms_final<- strptime(x = mpos4_trip$TIMEhhmms, format = "%H:%M")

mpos4_trip$TIMEhhe <- substr(mpos4_trip$ENDTIME,1,nchar(mpos4_trip$ENDTIME)-2)
mpos4_trip$TIMEmme<-str_sub(mpos4_trip$ENDTIME,-2,-1)
mpos4_trip$TIMEhhmme<-paste0 (mpos4_trip$TIMEhhe,sep = ":", mpos4_trip$TIMEmme,collapse = NULL)
# mpos4_trip$TIMEhhmme_final<- strptime(x = mpos4_trip$TIMEhhmme, format = "%H:%M")

# mpos4_trip<-mpos4_trip[,-which(names(mpos4_trip) %in% c("ENDTIME","STRTTIME","TDAYyear","TDAYmonth","TDAYym","TIMEmms","TIMEhhmms","TIMEhhe","TIMEmme","TIMEhhmme")),]

TNCtrip<-mpos4_trip %>%
  subset(TRPTRANS=="17") %>%
  merge(data.frame(nhts17_weights_person),by=c("HOUSEID","PERSONID"))


TNCtrip$TIMEhhs<-factor(as.numeric(TNCtrip$TIMEhhs),levels=c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23"))


TNCtrip_pop<-TNCtrip%>%
  filter(!is.na(TNCtrip$TIMEhhs)) %>%
  group_by(TIMEhhs)%>%
  summarise(Frequency = sum(WEIGHT_HH)*365) %>%
  mutate(Percent = Frequency / sum(Frequency)) %>%
  mutate(Year='2017')
sum(TNCtrip_pop$Percent[c(8:10, 16:18)])
# define peak hour: 8-10 am & 16-18 pm
# 33.93% are concentrated in peak hour 

all$time<- as.POSIXct(all$TIMEhhs, format= "%H")

ggplot(all, aes(x=time))+
  geom_bar(stat="bin",aes(y=..density..))+
  geom_density()

## frequency
ggplot(data=all, aes(x=TIMEhhs, y=Frequency/1000000, fill=Year))+
  geom_bar(stat = "identity",position='dodge')+
  geom_line()+
  # scale_fill_grey(start=0.7, end=0)+
  labs(x="Time of the day")+
  labs(y="Annual Trips (million)")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))

## percentage
ggplot(data=all, aes(x=TIMEhhs, y= Percent, fill=Year))+
  geom_density(stat = "identity",position='dodge')+
  scale_y_continuous(labels = scales::percent)+
  # scale_fill_grey(start=0.7, end=0)+
  labs(x="Time of the day")+
  labs(y="Percentage")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))

```



### Trip Chaining

```{r,Get trip_chain_o_m_d}

# #### fist/last trip from/to Home ###
# first<-mpos4_trip_w %>%
#   filter(TDTRPNUM=="01" & WHYFROM=="1")  %>%
#   select(HOUSEID,PERSONID,WEIGHT_HH.x)
# # sum(first$WEIGHT_HH.x)/sum(mpos4_trip_w$WEIGHT_HH.x[mpos4_trip_w$TDTRPNUM=="01"]) ##  0.9233377 trip origin is Home
#
#
# ## Person total trip count
# person_num_trip<-mpos4_trip_w %>%
#   group_by(HOUSEID,PERSONID) %>%
#   summarise(tripcount=n())
#
# last<-mpos4_trip_w %>%
#   merge(person_num_trip, by=c("HOUSEID","PERSONID")) %>%
#   filter(as.numeric(TDTRPNUM)==tripcount & WHYTO=="1")  %>%
#   select(HOUSEID,PERSONID,WEIGHT_HH.x)
#
# mpos4_trip_w_sum<-mpos4_trip_w %>%
#   merge(person_num_trip, by=c("HOUSEID","PERSONID")) %>%
#   filter(as.numeric(TDTRPNUM)==tripcount) %>%
#   summarise(total=sum(WEIGHT_HH.x))
# # sum(last$WEIGHT_HH.x)/mpos4_trip_w_sum$total ##  0.9267324 trip destination is Home
# # majority of travel commenced (0.9233377 of initial trips) and ended (0.9267324 percent of final trips) at home
#
#
# #########  only for trips from and to home #################################
# mpos4_trip_home<-mpos4_trip_w %>%
#   merge(first, by = c("HOUSEID","PERSONID")) %>%
#   merge(last, by = c("HOUSEID","PERSONID"))
# # sum(mpos4_trip_home$WEIGHT_HH.x) ## 820,352 trips, 904842731 weighted trip




###########################################################################
## Trip Chain
###########################################################################

# # get last d
# last_d<-mpos4_trip%>%
#  group_by(person_id,day_num) %>%
#  summarise_all(last) %>%
#   mutate(last_d=1) 
# 
# 
# ### get trip chain O_mode_D ###
# mpos4_trip$o_mode=paste0(mpos4_trip$o_purpcat_recode,sep = "_",mpos4_trip$mode_recode,sep = "_",collapse = NULL)
# 
# mpos4_trip<-mpos4_trip%>%
#   merge(last_d[,c("person_id","day_num","trip_num","last_d")],by =c("person_id","day_num","trip_num"), all.x = TRUE)
# mpos4_trip$last_d[is.na(mpos4_trip$last_d)] <- 0


mpos4_trip$o_mode<-ifelse(mpos4_trip$last_d==1, mpos4_trip$o_mode_d,mpos4_trip$o_mode)

trip_chain_o_m_d<-mpos4_trip%>%
  group_by(person_id,day_num) %>%
  summarise(o_mode_d=paste(o_mode,collapse = ""),numtrip = n()) %>%
  merge(last_d[,c("person_id","day_num")],by =c("person_id","day_num"), all.x = TRUE)



## total daily trips
numtrip<-trip_chain_o_m_d %>%
  group_by(numtrip)%>%
  summarise(totaltrip=round(sum(WEIGHT_DAY),2))%>%
  mutate(perc=round(totaltrip/sum(totaltrip)*100,2))

sum(numtrip$totaltrip)

## trip chains with 5 or more trips
sum(numtrip[1:4,3])




# ############# Mean trip count by TNC user & nonTNC user
# # trip_chain_omd_tnc<-trip_chain_o_m_d %>%
# #   filter(str_detect(o_mode_d, "tnc"))%>%
# #   mutate(hhperid=paste0(HOUSEID, PERSONID))
# # trip_chain_o_m_d<-trip_chain_o_m_d%>%
# #   mutate(hhperid=paste0(HOUSEID, PERSONID))
# # 
# # trip_chain_omd_nottnc<-trip_chain_o_m_d[!(trip_chain_o_m_d$hhperid %in% trip_chain_omd_tnc$hhperid),]
# # mean(trip_chain_omd_tnc$numtrip)
# # mean(trip_chain_omd_nottnc$numtrip)
# 
# 
# 
# # trip_chain$first_mile_h_w <- str_count(trip_chain$WHYO_mode_D, "1_0_2_")
# # trip_chain$first_mile_h_f <- str_count(trip_chain$WHYO_mode_D, "1_0_3_")
# # trip_chain$first_mile_h_o <- str_count(trip_chain$WHYO_mode_D, "1_0_4_")
# # trip_chain$last_mile_h_w <- str_count(trip_chain$WHYO_mode_D, "_2_0_1")
# # trip_chain$last_mile_h_f <- str_count(trip_chain$WHYO_mode_D, "_3_0_1")
# # trip_chain$last_mile_h_o <- str_count(trip_chain$WHYO_mode_D, "_4_0_1")
# # trip_chain$TNC_work <- str_count(trip_chain$WHYO_mode_D, "_0_1_")+str_count(trip_chain$WHYO_mode_D, "_1_0_")
# # trip_chain$TNC_tran <- str_count(trip_chain$WHYO_mode_D, "1_0_5_2_")+str_count(trip_chain$WHYO_mode_D, "_2_5_0_1")
# 
# 
# trip_chain_o_d$type<-"other"
# i<-1
# for (i in (1:nrow(trip_chain_o_d))){
#   if((str_detect(trip_chain_o_d[i,5], "2")==FALSE) & 
#       (str_detect(trip_chain_o_d[i,5], "3")==FALSE) & 
#       (str_detect(trip_chain_o_d[i,5], "4")==FALSE) & 
#       (str_detect(trip_chain_o_d[i,5], "5")==FALSE) &
#       (str_detect(trip_chain_o_d[i,5], "97")==FALSE)){
#     trip_chain_o_d[i,6] <-"h-round-trip"
#   } else if ((str_detect(trip_chain_o_d[i,5], "2")==FALSE) & 
#       (str_detect(trip_chain_o_d[i,5], "3")==TRUE) & 
#       (str_detect(trip_chain_o_d[i,5], "4")==FALSE) & 
#       (str_detect(trip_chain_o_d[i,5], "5")==FALSE)){
#     trip_chain_o_d[i,6] <-"h-f-h"
#   } else if ((str_detect(trip_chain_o_d[i,5], "2")==FALSE) & 
#              (str_detect(trip_chain_o_d[i,5], "3")==FALSE) & 
#              (str_detect(trip_chain_o_d[i,5], "4")==TRUE)){
#     trip_chain_o_d[i,6] <-"h-o-h"
#   } else if ((str_detect(trip_chain_o_d[i,5], "2")==FALSE) & 
#              ((str_detect(trip_chain_o_d[i,5], "3")==TRUE) | 
#               (str_detect(trip_chain_o_d[i,5], "4")==TRUE))){
#     trip_chain_o_d[i,6] <-"h-f&o -h"
#   }
# }
# 
# 
# for (i in (1:nrow(trip_chain_o_d))){
#   if (str_detect(trip_chain_o_d[i,5], "2")==TRUE){
#     if (str_count(trip_chain_o_d[i,5], "_2_")==1){
#       if (str_detect(trip_chain_o_d[i,5], "1_2")==TRUE | 
#           str_detect(trip_chain_o_d[i,5], "2_1")==TRUE){
#         trip_chain_o_d[i,6] <-"h-p-h"
#         } else if (str_detect(trip_chain_o_d[i,5], "1_2")==FALSE | 
#                    str_detect(trip_chain_o_d[i,5], "2_1")==FALSE){
#         trip_chain_o_d[i,6] <-"h-(s)-p-(s)-h"
#       }
#     }
#   }
# }
# 
# for (i in (1:nrow(trip_chain_o_d))){
#   if (str_detect(trip_chain_o_d[i,5], "2")==TRUE){
#     if (str_count(trip_chain_o_d[i,5], "_2_")>=2){
#       if ((str_detect(trip_chain_o_d[i,5], "1_2")==TRUE) &
#           (str_detect(trip_chain_o_d[i,5], "2_1")==TRUE)){
#         trip_chain_o_d[i,6] <-"h-p-s-p-h"
#       } else {
#         trip_chain_o_d[i,6] <-"h-(s)-p-s-p-(s)-h"
#       }
#     }
#   }
# }
# 
# 
# # for (i in (1:nrow(trip_chain_o_d))){
# #   if (str_detect(trip_chain_o_d[i,5], "2")==TRUE){
# #     if (str_count(trip_chain_o_d[i,5], "_2_")>=2){
# #       if ((str_detect(trip_chain_o_d[i,5], "1_2")==TRUE) &
# #           (str_detect(trip_chain_o_d[i,5], "2_1")==TRUE)){
# #         trip_chain_o_d[i,6] <-"h-p-s-p-h"
# #       } else if ((str_detect(trip_chain_o_d[i,5], "1_2")==FALSE) & 
# #                  (str_detect(trip_chain_o_d[i,5], "2_1")==FALSE)){
# #         trip_chain_o_d[i,6] <-"h-(s)-p-s-p-(s)-h"
# #       } else if ((str_detect(trip_chain_o_d[i,5], "1_2")==TRUE) & 
# #                  (str_detect(trip_chain_o_d[i,5], "2_1")==FALSE)){
# #         trip_chain_o_d[i,6] <-"h-(s)-p-s-p-(s)-h"
# #       } else if ((str_detect(trip_chain_o_d[i,5], "1_2")==FALSE) & 
# #                  (str_detect(trip_chain_o_d[i,5], "2_1")==TRUE)){
# #         trip_chain_o_d[i,6] <-"h-(s)-p-s-p-(s)-h"
# #       }
# #     }
# #   }
# # }
# 
# trip_chain_o_d$type<-as.factor(trip_chain_o_d$type)
# trip_chain_o_d$type<-as.character(trip_chain_o_d$type)
# trip_chain_o_d<-merge(trip_chain_o_d,as.data.frame(nhts17_weights_person)[,c(1:3)],by=c("HOUSEID","PERSONID"))
# # trip_chain_o_d$count_weight<-trip_chain_o_d$WEIGHT_HH/360
# 
# 
# o_d_per<-trip_chain_o_d %>% 
#   group_by(type) %>% 
#   summarise(Frequency = sum(WEIGHT_HH)) %>%
#   mutate(perc = Frequency / sum(Frequency))
# 
# o_d_per$category<-c("Work Based","Work Based","Nonwork Based","Nonwork Based","Nonwork Based","Work Based","Work Based","Nonwork Based","Other")
# 
# ggplot(o_d_per, aes(x = reorder(type, -perc), y = perc, fill=category))+
#   geom_text(aes(x =reorder(type, -perc), y = perc, label = round(perc*100,2)), position = position_dodge(width = 1),vjust = -0.3, size = 5)+
#   geom_bar(stat = "identity")+
#   labs(x="Trip Chain Typology")+
#   labs(y="Percentage")+
#   labs(title="Typology of Trip Chain")+
#   scale_fill_manual(values=c("#E69F00","#999999", "#56B4E9"))+
#   theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))
# 
# 
# ####### Compare TNC Users & Non-TNC Users
# 
# trip_chain_o_m_d$tnc<-ifelse(trip_chain_o_m_d$numTNC>0, "Yes", "No")
# trip_chain<-merge(trip_chain_o_d,trip_chain_o_m_d, by=c("HOUSEID","PERSONID"))
# trip_chain$WEIGHT_HH.x<-NULL
# trip_chain$WEIGHT_HH.y<-NULL
# 
# o_d_per_tnc<-trip_chain %>% 
#   subset(tnc=="Yes")%>% 
#   group_by(type) %>% 
#   summarise(Frequency = sum(WEIGHT_HH.y)) %>%
#   mutate(perc = Frequency / sum(Frequency), tnc="Yes")
#   
# 
# o_d_per_notnc<-trip_chain %>% 
#   subset(tnc=="No")%>% 
#   group_by(type) %>% 
#   summarise(Frequency = sum(WEIGHT_HH.y)) %>%
#   mutate(perc = Frequency / sum(Frequency),tnc="No")
# 
# o_d_per<-rbind(o_d_per_tnc, o_d_per_notnc)
# 
# # o_d_per$category<-c("Work Based","Work Based","Nonwork Based","Nonwork Based","Nonwork Based","Work Based","Work Based","Nonwork Based","Other")
# 
# ggplot(o_d_per, aes(x = reorder(type, -perc), y = perc, fill=factor(tnc)))+
#   geom_text(aes(x =reorder(type, -perc), y = perc, label = round(perc*100,2)), position = position_dodge(width = 1),vjust = -0.3, size = 5)+
#   geom_bar(stat = "identity",position = "dodge")+
#   labs(x="Trip Chain Typology")+
#   labs(y="Percentage")+
#   labs(title="Typology of Trip Chain")+
#   scale_fill_manual(values=c("#E69F00", "#56B4E9"), name = "TNC User")+
#   theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))
#   
# 
# 
# 
# 
# ################################## persons who use TNC at least once
# # allperson<-mpos4_trip %>% 
# #   group_by(hhperID) %>%
# #   summarise(numtrip = n())
# # ### get trip chain O_mode_D ###
# # all_trip_chain<- mpos4_trip %>%
# #   arrange(TDTRPNUM,hhperID)%>%
# #   group_by(hhperID) %>%
# #   summarise(WHYO_=paste(WHYO_,collapse = ""),numtrip = n()) %>%
# #   arrange(hhperID)
# # all_trip_chain$WHYD_<-1
# # all_trip_chain$WHYD_<-as.character(all_trip_chain$WHYD_)
# # all_trip_chain$WHYO_mode_D<-with(all_trip_chain,paste0(WHYO_,WHYD_))
# # 
# # ## Search for the number of occurance of trip chain for first/mile transfer
# # all_trip_chain$TNC<- str_count(all_trip_chain$WHYO_mode_D, "_0_")
# # table(all_trip_chain$TNC)
# 
# 
# ######################## select trip chain related to TNC
# 
# person<-mpos4_trip %>%
#   group_by(hhperID) %>%
#   summarise(numtrip = n())
# nonTNCperson<-person[!(person$hhperID %in% TNCperson$hhperID),]
# nonTNCperson_trip<-merge(x = nonTNCperson, y = mpos4_trip, by = "hhperID", all.x = TRUE)
# TNCperson_trip<-nonTNCperson_trip
# 
# 
# ########################################################################
# ############ select trip chain related to TNC
# ########################################################################
# TNCtrip<-subset(mpos4_trip,mpos4_trip$TRPTRANS=="tnc")
# TNCperson<-TNCtrip %>%
#   filter(TRPTRANS=="tnc") %>% 
#   group_by(hhperID) %>%
#   summarise(numtrip = n())
# TNCperson_trip<-merge(x = TNCperson, y = mpos4_trip, by = "hhperID", all.x = TRUE)
# #1474 ever took TNC, chaining 7458 trips
# 
# 
# # #### transfer DATE--TIME format ###
# ## year-month
# # TNCtrip<-subset(TNCperson_trip,TRPTRANS=="tnc")
# # 
# # barplot(summary(as.factor(TNCtrip$TIMEhhs)))
# # 
# # TNCperson_trip$TDAYyear <- str_sub(TNCperson_trip$TDAYDATE,1,4)
# # TNCperson_trip$TDAYmonth<- str_sub(TNCperson_trip$TDAYDATE,-2,-1)
# # TNCperson_trip$TDAYym<-paste0 (TNCperson_trip$TDAYyear,sep = "-", TNCperson_trip$TDAYmonth,collapse = NULL)
# # TNCperson_trip$TDAYym_final<-as.yearmon(TNCperson_trip$TDAYym,"%Y-%m")
# # ## hour-min
# # TNCperson_trip$TIMEhhs <- substr(TNCperson_trip$STRTTIME,1,nchar(TNCperson_trip$STRTTIME)-2)
# # TNCperson_trip$TIMEmms<-str_sub(TNCperson_trip$STRTTIME,-2,-1)
# # TNCperson_trip$TIMEhhs<-as.numeric (TNCperson_trip$TIMEhhs)
# # TNCperson_trip$TIMEhhs[is.na(TNCperson_trip$TIMEhhs)] <-0
# # TNCperson_trip$TIMEmms<-as.numeric (TNCperson_trip$TIMEmms)
# # TNCperson_trip$TIMEmms_round10<-round_any(TNCperson_trip$TIMEmms, 10, f = ceiling)
# # i<-1
# # for (i in (1:nrow(TNCperson_trip))){
# #   if (TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEmms_round10")]==60){
# #     TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEmms_round10")]<- 0
# #     TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEhhs")]<-TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEhhs")]+1
# #   }
# # }
# # # TNCperson_trip$TIMEhhmms<-paste0 (TNCperson_trip$TIMEhhs,sep = ":", TNCperson_trip$TIMEmms_round10,collapse = NULL)
# # # s<-as.data.frame(table(TNCperson_trip$TIMEhhmms))
# # # colnames(s)<-c("Time","Count")
# # # s$Time<- as.ITime(strptime(x = s$Time, format = "%H:%M"))
# # # ggplot(s, aes(Time, Count)) + geom_line() 
# # 
# # 
# # TNCperson_trip$TIMEhhe <- substr(TNCperson_trip$ENDTIME,1,nchar(TNCperson_trip$ENDTIME)-2)
# # TNCperson_trip$TIMEmme<-str_sub(TNCperson_trip$ENDTIME,-2,-1)
# # TNCperson_trip$TIMEhhe<-as.numeric (TNCperson_trip$TIMEhhe)
# # TNCperson_trip$TIMEhhe[is.na(TNCperson_trip$TIMEhhe)] <-0
# # TNCperson_trip$TIMEmme<-as.numeric (TNCperson_trip$TIMEmme)
# # TNCperson_trip$TIMEmme_round10<-round_any(TNCperson_trip$TIMEmme, 10, f = ceiling)
# # i<-1
# # for (i in (1:nrow(TNCperson_trip))){
# #   if (TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEmme_round10")]==60){
# #     TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEmme_round10")]<- 0
# #     TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEhhe")]<-TNCperson_trip[i,which(colnames(TNCperson_trip)=="TIMEhhe")]+1
# #   }
# # }
# # TNCperson_trip$TIMEhhmme<-paste0 (TNCperson_trip$TIMEhhe,sep = ":", TNCperson_trip$TIMEmme_round10,collapse = NULL)
# # # TNCperson_trip$TIMEhhmme_final<- as.ITime(strptime(x = TNCperson_trip$TIMEhhmme, format = "%H:%M"))
# # 
# # table(TNCperson_trip$TIMEhhmme_final)
# # F1 <- ggplot(TNCperson_trip, aes(x=TNCperson_trip$TIMEhhmme_final))
# # F1 + geom_bar()
# # ggplot(data=TNCperson_trip, aes(x=TNCperson_trip$TIMEhhmme_final,y=count())) + geom_point()
# # # TNCperson_trip<-TNCperson_trip[,-which(names(TNCperson_trip) %in% c("ENDTIME","STRTTIME","TDAYyear","TDAYmonth","TDAYym","TIMEmms","TIMEhhmms","TIMEhhe","TIMEmme","TIMEhhmme")),]
# 
# 
# 
# ###########################################################################
# ## Trip Chain
# ###########################################################################
# 
# ### get trip chain O_mode_D ###
# trip_chain_o_m_d<- TNCperson_trip %>%
#   arrange(TDTRPNUM,hhperID)%>%
#   group_by(hhperID) %>%
#   summarise(WHYO_=paste(WHYO_,collapse = ""),numtrip = n()) %>%
#   arrange(hhperID)
# trip_chain_o_m_d$O_mode_D<-with(trip_chain_o_m_d,paste0(WHYO_,"1"))
# 
# ## Search for the number of occurance of trip chain for first/mile transfer
# trip_chain_o_m_d$numTNC <- str_count(trip_chain_o_m_d$O_mode_D, "_tnc_")
# 
# ### get trip chain OD ###
# trip_chain_o_d<- TNCperson_trip %>%
#   arrange(TDTRPNUM,hhperID)%>%
#   group_by(hhperID) %>%
#   summarise(OD=paste(WHYFROM,collapse = "_"),numtrip = n()) %>%
#   arrange(hhperID)
# trip_chain_o_d$O_D<- with(trip_chain_o_d,paste0(OD,"_1"))
# 
# 
# # trip_chain$first_mile_h_w <- str_count(trip_chain$WHYO_mode_D, "1_0_2_")
# # trip_chain$first_mile_h_f <- str_count(trip_chain$WHYO_mode_D, "1_0_3_")
# # trip_chain$first_mile_h_o <- str_count(trip_chain$WHYO_mode_D, "1_0_4_")
# # trip_chain$last_mile_h_w <- str_count(trip_chain$WHYO_mode_D, "_2_0_1")
# # trip_chain$last_mile_h_f <- str_count(trip_chain$WHYO_mode_D, "_3_0_1")
# # trip_chain$last_mile_h_o <- str_count(trip_chain$WHYO_mode_D, "_4_0_1")
# # trip_chain$TNC_work <- str_count(trip_chain$WHYO_mode_D, "_0_1_")+str_count(trip_chain$WHYO_mode_D, "_1_0_")
# # trip_chain$TNC_tran <- str_count(trip_chain$WHYO_mode_D, "1_0_5_2_")+str_count(trip_chain$WHYO_mode_D, "_2_5_0_1")
# 
# trip_chain_o_d$type<-"other"
# i<-1
# for (i in (1:nrow(trip_chain_o_d))){
#   if ((str_detect(trip_chain_o_d[i,4], "2")==FALSE) & (str_detect(trip_chain_o_d[i,4], "3")==TRUE) & (str_detect(trip_chain_o_d[i,4], "4")==FALSE)){
#     trip_chain_o_d[i,5] <-"h-f-h"
#   } else if ((str_detect(trip_chain_o_d[i,4], "2")==FALSE) & (str_detect(trip_chain_o_d[i,4], "3")==FALSE) & (str_detect(trip_chain_o_d[i,4], "4")==TRUE)){
#     trip_chain_o_d[i,5] <-"h-o-h"
#   } else if ((str_detect(trip_chain_o_d[i,4], "2")==FALSE) & ((str_detect(trip_chain_o_d[i,4], "3")==TRUE) | (str_detect(trip_chain_o_d[i,4], "4")==TRUE)) ){
#     trip_chain_o_d[i,5] <-"h-(f+o)-h"
#   }
# }
# 
# 
# for (i in (1:nrow(trip_chain_o_d))){
#   if (str_detect(trip_chain_o_d[i,4], "2")==TRUE){
#     if (str_count(trip_chain_o_d[i,4], "_2_")==1){
#       if (str_detect(trip_chain_o_d[i,4], "1_2")==TRUE | str_detect(trip_chain_o_d[i,4], "2_1")==TRUE){
#         trip_chain_o_d[i,5] <-"h-p-h"
#         } else if (str_detect(trip_chain_o_d[i,4], "1_2")==FALSE | str_detect(trip_chain_o_d[i,4], "2_1")==FALSE){
#         trip_chain_o_d[i,5] <-"h-(s)-p-(s)-h"
#       }
#     }
#   }
# }
# 
# for (i in (1:nrow(trip_chain_o_d))){
#   if (str_detect(trip_chain_o_d[i,4], "2")==TRUE){
#     if (str_count(trip_chain_o_d[i,4], "_2_")>=2){
#       if ((str_detect(trip_chain_o_d[i,4], "1_2")==TRUE) & (str_detect(trip_chain_o_d[i,4], "2-1")==TRUE)){
#         trip_chain_o_d[i,5] <-"h-(s)-p-s-p-(s)-h"
#       } else if ((str_detect(trip_chain_o_d[i,4], "1_2")==FALSE) & (str_detect(trip_chain_o_d[i,4], "2-1")==FALSE)){
#         trip_chain_o_d[i,5] <-"h-(s)-p-s-p-(s)-h"
#       } else if ((str_detect(trip_chain_o_d[i,4], "1_2")==TRUE) & (str_detect(trip_chain_o_d[i,4], "2-1")==FALSE)){
#         trip_chain_o_d[i,5] <-"h-(s)-p-s-p-(s)-h"
#       } else if ((str_detect(trip_chain_o_d[i,4], "1_2")==FALSE) & (str_detect(trip_chain_o_d[i,4], "2-1")==TRUE)){
#         trip_chain_o_d[i,5] <-"h-(s)-p-s-p-(s)-h"
#       }
#     }
#   }
# }
# trip_chain_o_d$type<-as.factor(trip_chain_o_d$type)
# trip_chain_o_d$HOUSEID<- as.character(str_sub(trip_chain_o_d$hhperID,1,8))
# trip_chain_o_d$PERSONID<- str_sub(trip_chain_o_d$hhperID,-1,-1)
# trip_chain_o_d$PERSONID<-paste0("0",sep = "",trip_chain_o_d$PERSONID,collapse = NULL)
# 
# person_weight<-as.data.frame(nhts_data$weights$person)[,c(1:3)]
# trip_chain_o_d<-merge(trip_chain_o_d,person_weight,by=c("HOUSEID","PERSONID"))
# trip_chain_o_d$count_weight<-trip_chain_o_d$WEIGHT_HH/360
# 
# o_d_per<-trip_chain_o_d %>% 
#   group_by(type) %>% 
#   summarise(Frequency = sum(count_weight)) %>%
#   mutate(perc = Frequency / sum(Frequency))
# o_d_per$category<-c("Nonwork Based","Work Based","Work Based","Nonwork Based","Nonwork Based","Work Based","Other")
# ggplot(o_d_per, aes(x = reorder(type, -perc), y = perc, fill=category))+
#   geom_bar(stat = "identity")+
#   labs(x="Trip Chain Typology")+
#   labs(y="Percentage")+
#   scale_fill_manual(values=c("#E69F00","#999999", "#56B4E9"))+
#   theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))
#   
```

```{r,create daily mode choice chaining}
# 
# ######## Indirect Connection with TNC ###########
# 
# # table(mpos4_trip$o_purpcat_recode)
# # table(mpos4_trip$d_purpcat_recode)
# 
# trip_chain_o_m_d$mode<-trip_chain_o_m_d$o_mode_d
# trip_chain_o_m_d$mode<-gsub('1',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('2',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('3',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('4',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('5',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('6',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('7',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('8',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('-9998',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('_',"", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('-',"", trip_chain_o_m_d$mode, fixed=TRUE)
# 
# # table(mpos4_trip$mode_recode)
# 
# #  1-w, 2-b, 3-car, 4-tnc/tnc_s, 5-pt, 6-o
# trip_chain_o_m_d$mode<-gsub('w',"1", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('b',"2", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('car',"3", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('tnc',"4", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('tnc_s',"4", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('pt',"5", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('o',"6", trip_chain_o_m_d$mode, fixed=TRUE)
# trip_chain_o_m_d$mode<-gsub('9',"", trip_chain_o_m_d$mode, fixed=TRUE)
# 
# trip_chain_o_m_d$uniquemode_order<-0
# trip_chain_o_m_d$uniquemode_unorder<-0
# ## unique mode
# col<-which(colnames(trip_chain_o_m_d)=="mode")
# i<-1
# for (i in (1:nrow(trip_chain_o_m_d))){
#   list<-unique(as.numeric(unlist(strsplit(trip_chain_o_m_d[i,col], ""))))
#   trip_chain_o_m_d[i,col+1]<-paste(list[order(list)], collapse='')
#   trip_chain_o_m_d[i,col+2]<-paste(list, collapse='')
#   i=i+1
# }
# trip_chain_o_m_d$uniquemode_order<-gsub('NA',"", trip_chain_o_m_d$uniquemode_order, fixed=TRUE)
# trip_chain_o_m_d$uniquemode_unorder<-gsub('NA',"", trip_chain_o_m_d$uniquemode_order, fixed=TRUE)
# 
# # table(trip_chain_o_m_d$uniquemode_order)
# 
# write.csv(trip_chain_o_m_d,file="MPOS4_allpop_trip_chain_o_m_d.csv",row.names=FALSE, na="")

```
#### Person-daily Distribution
##### 4MPOs
```{r,daily mode choice-bar chart visual}

### what modes are combined into 1-walk, 2-bike, 3-car, 4-taxi, 5-transit, 6-school bus, 7-other ####

mpos4_per = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_per.csv",colClasses = c('hh_id'='character','person_id'='character'),header=TRUE))%>%
  merge(mpos4_hh[,c("hh_id","num_vehicles")],by=c("hh_id"),all.x=TRUE)
mpos4_per<-arrange(mpos4_per,hh_id,person_id)

mpos4_per$hhveh_driver<-ifelse(mpos4_per$license==1 & mpos4_per$num_vehicles>0, 1,
                               ifelse(mpos4_per$license==0 | mpos4_per$num_vehicles==0,0,-1))
table(mpos4_per$hhveh_driver)

tour<- read.csv("MPOS4_allpop_trip_chain_o_m_d.csv") %>%
  merge(mpos4_per[,c("person_id","age","hhveh_driver")], by="person_id", all.x = TRUE) %>%
  merge(mpos4_day[,c("person_id","day_num","WEIGHT_DAY")], by=c("person_id","day_num"), all.x = TRUE)

### number of people with at least 5 days
num_daily_trip<-merge(mpos4_per[,c("person_id")],tour[,c("person_id","numtrip")],by="person_id",all = T)

## total daily trips
num_daily_trip_person<-tour %>%
  group_by(person_id) %>%
  summarise(n=mean(numtrip)) %>%
  merge(mpos4_per[,c("person_id")], by="person_id", all.y = T)
num_daily_trip_person$n[is.na(num_daily_trip_person$n)]<-0

nrow(num_daily_trip_person[num_daily_trip_person$n>=5,])/nrow(num_daily_trip_person)


## total frequency & percentage
fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY)) %>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))
# summary(tour$WEIGHT_DAY)
# fre_perc<-tour %>%
#   mutate(total=sum(WEIGHT_TRIP)) %>%
#   group_by(uniquemode_order,hhveh_driver,total) %>%
#   summarise(Frequency = round(sum(WEIGHT_TRIP),0)) %>%
#   mutate(perc= round(Frequency / total*100,4))%>%
#   arrange(desc(perc))

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(mode="4") %>%
  group_by(mode) %>%
  summarise(n=sum(n),Frequency=sum(Frequency),perc=sum(perc))%>%
  mutate(Frequency=round(Frequency,2),perc=round(perc,2))

fre_perc_tnc_total<-fre_perc_tnc[1,4]
  
## including TNC mode to the Panel 1

fre_perc_notnc<-fre_perc[1:10,c("mode","n","Frequency","perc")]
fre_perc_notnc$perc<-round(fre_perc_notnc$perc,2)
fre_perc_notnc$mode<-as.character(fre_perc_notnc$mode)
fre_perc_large<-bind_rows(fre_perc_notnc,fre_perc_tnc)
# fre_perc_large$mode<-c("Car","Car+B/W","B/W","Car+Transit","Transit","Transit + B/W","Car+Transit+B/W")

fre_perc_large$mode <- factor(fre_perc_large$mode, levels=c("3","13","1","15","135","36","23","35","2","4"))

daily_mode_choice_large<-ggplot(fre_perc_large, aes(x = reorder(mode, -perc), y=perc))+ 
   geom_bar(stat="identity",colour="black", fill ="#1A476F",size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 65)+
  # scale_fill_brewer(palette="#1A476F")+
  scale_x_discrete(limits=c(c("3","13","1","15","135","36","23","35","2","4")),
    labels=c("Car\nOnly","Car+\nWalk","Walk\nOnly","Transit+\nWalk","Car+\nTransit+\nWalk","Car+\nOther","Car+\nBike","Car+\nTransit","Bike\nOnly","TNC\nRelated"))+
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  # geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
    geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-1.5) +
  labs(x="Panel 1: Modes in All Daily Trip Chain", y="Mode share out of all trip chain (%)") +
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=T))

ggsave("daily_mode_choice_large.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


### TNC related 
fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY)) %>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(perc=round(perc/3.38,4))

fre_perc_tnc<-fre_perc_tnc[1:10,]
fre_perc_tnc$mode <- factor(fre_perc_tnc$mode, levels=c("34","134","145","14","1345","4","345","1346","234","146"))

daily_mode_choice_tnc<-ggplot(fre_perc_tnc, aes(x = reorder(mode, -perc), y=perc*100))+ 
   geom_bar(stat="identity",colour="black",fill="#1A476F",size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 23)+
  scale_x_discrete(limits=c("34","134","145","14","1345","4","345","1346","234","146"),
    labels=c("TNC+\nCar","TNC+\nCar+\nWalk","TNC+\nTransit+\nWalk","TNC+\nWalk","TNC+\nCar+\nTransit+\nWalk","TNC\nOnly","TNC+\nCar+\nTransit","TNC+\nCar+\nOther+\nWalk","TNC+\nCar+\nBike","TNC+\nWalk+\nOther"))+
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  geom_text(aes(label=perc*100), position = position_dodge(width = 0.7), vjust=-1.5) +
  labs(x="Panel 2: Modes in TNC Daily Trip Chain", y="Mode share of TNC trip chain (%)") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14,  face = "bold")) +
  guides(fill = guide_legend(reverse=T))

ggsave("daily_mode_choice_tnc.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


#### 
#### % tnc+ car/transit/active chaining ####
## non-tnc-containing
fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY)) %>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_notnc<-na.omit(fre_perc[fre_perc$tnc==0,])

fre_perc_notnc$car<-ifelse(str_detect(fre_perc_notnc$mode, "3")==TRUE,1,0)
fre_perc_notnc$pt<-ifelse(str_detect(fre_perc_notnc$mode, "5")==TRUE,1,0)
fre_perc_notnc$active<-ifelse(str_detect(fre_perc_notnc$mode, "1")|str_detect(fre_perc_notnc$mode, "2")==TRUE,1,0)

sum(fre_perc_notnc$perc[fre_perc_notnc$car==1])/ sum(fre_perc_notnc$perc)
sum(fre_perc_notnc$perc[fre_perc_notnc$pt==1])/ sum(fre_perc_notnc$perc)
sum(fre_perc_notnc$perc[fre_perc_notnc$active==1])/ sum(fre_perc_notnc$perc)


## tnc-containing
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(Frequency=round(Frequency,2),perc=round(perc,4))

fre_perc_tnc$tnc_car<-ifelse(str_detect(fre_perc_tnc$mode, "3")==TRUE,1,0)
fre_perc_tnc$tnc_pt<-ifelse(str_detect(fre_perc_tnc$mode, "5")==TRUE,1,0)
fre_perc_tnc$tnc_active<-ifelse(str_detect(fre_perc_tnc$mode, "1")|str_detect(fre_perc_tnc$mode, "2")==TRUE,1,0)

sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_car==1])/ sum(fre_perc_tnc$perc)
sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_pt==1])/ sum(fre_perc_tnc$perc)
sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_active==1])/ sum(fre_perc_tnc$perc)


```

##### SANDAG
```{r,daily mode choice-bar chart visual}

### what modes are combined into 1-walk, 2-bike, 3-car, 4-taxi, 5-transit, 6-school bus, 7-other ####

mpos4_per = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_per.csv",colClasses = c('hh_id'='character','person_id'='character'),header=TRUE))%>%
  merge(mpos4_hh[,c("hh_id","num_vehicles")],by=c("hh_id"),all.x=TRUE)
mpos4_per<-arrange(mpos4_per,hh_id,person_id)

mpos4_per$hhveh_driver<-ifelse(mpos4_per$license==1 & mpos4_per$num_vehicles>0, 1,
                               ifelse(mpos4_per$license==0 | mpos4_per$num_vehicles==0,0,-1))
table(mpos4_per$hhveh_driver)

tour<- read.csv("MPOS4_allpop_trip_chain_o_m_d.csv") %>%
  merge(mpos4_per[,c("person_id","age","hhveh_driver","region")], by="person_id", all.x = TRUE) %>%
  merge(mpos4_day[,c("person_id","day_num","WEIGHT_DAY")], by=c("person_id","day_num"), all.x = TRUE) %>% 
  filter(region =="SANDAG")

### number of people with at least 5 days
mpos4_per$person_id<-as.character(mpos4_per$person_id)
tour$person_id<-as.character(tour$person_id)
num_daily_trip<-merge(mpos4_per[,c("person_id")],tour[,c("person_id","numtrip")],by="person_id",all = T)

## total daily trips
num_daily_trip_person<-tour %>%
  group_by(person_id) %>%
  summarise(n=mean(numtrip)) %>%
  merge(mpos4_per[,c("person_id")], by="person_id", all.y = T)
num_daily_trip_person$n[is.na(num_daily_trip_person$n)]<-0

nrow(num_daily_trip_person[num_daily_trip_person$n>=5,])/nrow(num_daily_trip_person)


## total frequency & percentage
fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY)) %>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))
# summary(tour$WEIGHT_DAY)
# fre_perc<-tour %>%
#   mutate(total=sum(WEIGHT_TRIP)) %>%
#   group_by(uniquemode_order,hhveh_driver,total) %>%
#   summarise(Frequency = round(sum(WEIGHT_TRIP),0)) %>%
#   mutate(perc= round(Frequency / total*100,4))%>%
#   arrange(desc(perc))

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(mode="4") %>%
  group_by(mode) %>%
  summarise(n=sum(n),Frequency=sum(Frequency),perc=sum(perc))%>%
  mutate(Frequency=round(Frequency,2),perc=round(perc,2))

fre_perc_tnc_total<-fre_perc_tnc[1,4]
  
## including TNC mode to the Panel 1

fre_perc_notnc<-fre_perc[c(1:8,10:11),c("mode","n","Frequency","perc")] %>% 
  mutate(tnc=0)
fre_perc_notnc$perc<-round(fre_perc_notnc$perc,2)
fre_perc_notnc$mode<-as.character(fre_perc_notnc$mode)
fre_perc_large<-bind_rows(fre_perc_notnc,fre_perc_tnc)
# fre_perc_large$mode<-c("Car","Car+B/W","B/W","Car+Transit","Transit","Transit + B/W","Car+Transit+B/W")

fre_perc_large$mode <- factor(fre_perc_large$mode, levels=c("3","13","1","36","15","135","23","35","136","123"))

daily_mode_choice_large_SANDAG<-ggplot(fre_perc_large, aes(x = reorder(mode, -perc), y=perc))+ 
   geom_bar(stat="identity",colour="black", fill ="#1A476F",size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 75)+
  # scale_fill_brewer(palette="#1A476F")+
  scale_x_discrete(limits=c(c("3","13","1","36","15","135","23","35","136","123","4")),
    labels=c("Car\nOnly","Car+\nWalk","Walk\nOnly","Car+\nOther","Transit+\nWalk","Car+\nTransit+\nWalk","Transit+\nBike","Car+\nTransit","Car+\nWalk+\nOther","Car+\nBike+\nWalk","TNC\nRelated"))+
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  # geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
    geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-1.5) +
  labs(x="Panel 1: Modes in All Daily Trip Chain", y="Mode share out of all trip chain (%)") +
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=T))

ggsave("daily_mode_choice_large_SANDAG.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


### TNC related 
fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY)) %>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_tnc<-fre_perc%>%
  filter(tnc==1) %>%
  mutate(perc=round(perc/2.09,4))

fre_perc_tnc<-fre_perc_tnc[1:10,]
fre_perc_tnc$mode <- factor(fre_perc_tnc$mode, levels=c("34","134","14","1345","4","145","345","45","1346","3456"))

daily_mode_choice_tnc_SANDAG<-ggplot(fre_perc_tnc, aes(x = reorder(mode, -perc), y=perc*100))+ 
   geom_bar(stat="identity",colour="black",fill="#1A476F",size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 35)+
  scale_x_discrete(limits=c("34","134","14","1345","4","145","345","45","1346","3456"),
    labels=c("TNC+\nCar","TNC+\nCar+\nWalk","TNC+\nWalk","TNC+\nCar+\nTransit+\nWalk","TNC\nOnly","TNC+\nTransit+\nWalk","TNC+\nCar+\nTransit","TNC+\nTransit","TNC+\nCar+\nOther+\nWalk","TNC+\nCar+\nTransit+\nOther"))+
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  geom_text(aes(label=perc*100), position = position_dodge(width = 0.7), vjust=-1.5) +
  labs(x="Panel 2: Modes in TNC Daily Trip Chain", y="Mode share of TNC trip chain (%)") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14,  face = "bold")) +
  guides(fill = guide_legend(reverse=T))

ggsave("daily_mode_choice_tnc_SANDAG.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


#### 
#### % tnc+ car/transit/active chaining ####
## non-tnc-containing
fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY)) %>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_notnc<-na.omit(fre_perc[fre_perc$tnc==0,])

fre_perc_notnc$car<-ifelse(str_detect(fre_perc_notnc$mode, "3")==TRUE,1,0)
fre_perc_notnc$pt<-ifelse(str_detect(fre_perc_notnc$mode, "5")==TRUE,1,0)
fre_perc_notnc$active<-ifelse(str_detect(fre_perc_notnc$mode, "1")|str_detect(fre_perc_notnc$mode, "2")==TRUE,1,0)

sum(fre_perc_notnc$perc[fre_perc_notnc$car==1])/ sum(fre_perc_notnc$perc)
sum(fre_perc_notnc$perc[fre_perc_notnc$pt==1])/ sum(fre_perc_notnc$perc)
sum(fre_perc_notnc$perc[fre_perc_notnc$active==1])/ sum(fre_perc_notnc$perc)


## tnc-containing
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(Frequency=round(Frequency,2),perc=round(perc,4))

fre_perc_tnc$tnc_car<-ifelse(str_detect(fre_perc_tnc$mode, "3")==TRUE,1,0)
fre_perc_tnc$tnc_pt<-ifelse(str_detect(fre_perc_tnc$mode, "5")==TRUE,1,0)
fre_perc_tnc$tnc_active<-ifelse(str_detect(fre_perc_tnc$mode, "1")|str_detect(fre_perc_tnc$mode, "2")==TRUE,1,0)

sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_car==1])/ sum(fre_perc_tnc$perc)
sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_pt==1])/ sum(fre_perc_tnc$perc)
sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_active==1])/ sum(fre_perc_tnc$perc)


```

```{r,daily mode choice-bar chart visual- Group by hhveh_driver}

mpos4_per = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_per.csv",colClasses = c('hh_id'='character','person_id'='character'),header=TRUE)) %>% select(hh_id, person_id, everything()) %>%
  merge(mpos4_hh[,c("hh_id","num_vehicles")],by=c("hh_id"),all.x=TRUE)

# table(mpos4_per$num_vehicles)
mpos4_per$hhveh_driver<-ifelse(mpos4_per$license==1 & mpos4_per$num_vehicles %between% c(1,8), 1,
                               ifelse(mpos4_per$license==0 | mpos4_per$num_vehicles==0,0,-1))
# table(mpos4_per$hhveh_driver)

tour<- read.csv("MPOS4_allpop_trip_chain_o_m_d.csv") %>%
  merge(mpos4_per[,c("person_id","age","hhveh_driver")], by="person_id", all.x = TRUE) %>%
  merge(mpos4_day[,c("person_id","day_num","WEIGHT_DAY")], by=c("person_id","day_num"), all.x = TRUE)

# tour$mode_cate<-ifelse(tour$uniquemode_order=="3","Only_Car",
#   ifelse(str_detect(tour$uniquemode_order,"3")==TRUE & str_detect(tour$uniquemode_order,"4")==FALSE,"Car_Other",
#          ifelse(str_detect(tour$uniquemode_order,"3")==TRUE & str_detect(tour$uniquemode_order,"4")==TRUE,"TNC_Car",
#                 ifelse(str_detect(tour$uniquemode_order,"3")==FALSE & str_detect(tour$uniquemode_order,"4")==TRUE,"TNC_Other",
#                        ifelse(str_detect(tour$uniquemode_order,"3")==FALSE & str_detect(tour$uniquemode_order,"4")==FALSE,"Only_Other","-1")))))

tour$mode_cate<-ifelse(tour$uniquemode_order=="3","Car Only",
                ifelse(str_detect(tour$uniquemode_order,"3")==FALSE & str_detect(tour$uniquemode_order,"4")==TRUE,"TNC-related (w/o car)","-1"))
# prop.table(table(tour$mode_cate))
# summary(tour$age)

## total frequency & percentage

fre_perc0<-tour %>%
  subset(!is.na(WEIGHT_DAY) & hhveh_driver>=0) %>%
  mutate(total=sum(WEIGHT_DAY)) %>%
  group_by(uniquemode_order,mode_cate,hhveh_driver,total) %>%
  summarise(Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency /total *100,4))%>%
  arrange(desc(perc))

fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY) & hhveh_driver>=0) %>%
  mutate(total=sum(WEIGHT_DAY)) %>%
  group_by(mode_cate, hhveh_driver,total) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc_total= round(Frequency / total*100,2))%>%
  arrange(desc(perc_total))

fre_perc<-na.omit(fre_perc) %>%
  subset(mode_cate != -1) %>%
  group_by(mode_cate) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,2))

# colnames(fre_perc)[1]<-"mode"

fre_perc$mode_cate <- factor(fre_perc$mode_cate, levels=c("Only_Car","Car_Other","Only_Other","TNC_Car","TNC_Other"))
fre_perc$hhveh_driver<-factor(fre_perc$hhveh_driver,levels=c(0,1))
# library(plyr)
# revalue(fre_perc$hhveh_driver, c("beta"="two", "gamma"="three"))

mode_choice_vehaccess<-ggplot(fre_perc, aes(x = mode_cate, y=perc,fill=as.factor(hhveh_driver)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 100)+
  # scale_x_discrete(limits=c("Only_Car","TNC-related (w/o car)"))+
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  geom_text(aes(label=round(perc,1)), position = position_dodge(width = 0.7), vjust=-1.5) +
  labs( y="Mode Share\namong total trip chaining (%)") +
  scale_fill_manual(name = "Population Group", labels = c("People without household vehicle or driver license", "People with household vehicle and driver license"),values = c("#a6bddb","#1A476F" ))+
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 14), 
    axis.text.y=element_text(colour="black", size = 14),
    axis.title.x=element_blank(),
    axis.title.y=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 14),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))


ggsave("mode_choice_vehaccess.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 6,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)
# #### % tnc+ car/transit/active chaining ####
# ## non-tnc-containing
# fre_perc<-tour %>%
#   group_by(uniquemode_order) %>%
#   summarise(Frequency = round(sum(WEIGHT_TRIP),0)) %>%
#   mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
#   arrange(desc(perc))
# 
# colnames(fre_perc)[1]<-"mode"
# fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
# fre_perc_notnc<-na.omit(fre_perc[fre_perc$tnc==0,])
# 
# fre_perc_notnc$car<-ifelse(str_detect(fre_perc_notnc$mode, "3")==TRUE,1,0)
# fre_perc_notnc$pt<-ifelse(str_detect(fre_perc_notnc$mode, "5")==TRUE,1,0)
# fre_perc_notnc$active<-ifelse(str_detect(fre_perc_notnc$mode, "1")|str_detect(fre_perc_notnc$mode, "2")==TRUE,1,0)
# 
# sum(fre_perc_notnc$perc[fre_perc_notnc$car==1])/ sum(fre_perc_notnc$perc)
# sum(fre_perc_notnc$perc[fre_perc_notnc$pt==1])/ sum(fre_perc_notnc$perc)
# sum(fre_perc_notnc$perc[fre_perc_notnc$active==1])/ sum(fre_perc_notnc$perc)
# 
# 
# ## tnc-containing
# fre_perc_tnc<-fre_perc%>%
#   subset(tnc>0) %>%
#   mutate(Frequency=round(Frequency,2),perc=round(perc,4))
# 
# fre_perc_tnc$tnc_car<-ifelse(str_detect(fre_perc_tnc$mode, "3")==TRUE,1,0)
# fre_perc_tnc$tnc_pt<-ifelse(str_detect(fre_perc_tnc$mode, "5")==TRUE,1,0)
# fre_perc_tnc$tnc_active<-ifelse(str_detect(fre_perc_tnc$mode, "1")|str_detect(fre_perc_tnc$mode, "2")==TRUE,1,0)
# 
# sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_car==1])/ sum(fre_perc_tnc$perc)
# sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_pt==1])/ sum(fre_perc_tnc$perc)
# sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_active==1])/ sum(fre_perc_tnc$perc)


```



#### Person Distribution
##### 4MPOs
```{r,daily mode choice-bar chart visual}

### what modes are combined into 1-walk, 2-bike, 3-car, 4-taxi, 5-transit, 6-school bus, 7-other ####

mpos4_per = setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/Data/4MPOs_Combined/ex_per.csv",colClasses = c('hh_id'='character','person_id'='character'),header=TRUE))%>%
  merge(mpos4_hh[,c("hh_id","num_vehicles")],by=c("hh_id"),all.x=TRUE)
mpos4_per<-arrange(mpos4_per,hh_id,person_id)

mpos4_per$hhveh_driver<-ifelse(mpos4_per$license==1 & mpos4_per$num_vehicles>0, 1,
                               ifelse(mpos4_per$license==0 | mpos4_per$num_vehicles==0,0,-1))
# table(mpos4_per$hhveh_driver)

tour<- read.csv("MPOS4_allpop_trip_chain_o_m_d.csv") %>%
  merge(mpos4_per[,c("person_id","age","hhveh_driver")], by="person_id", all.x = TRUE) %>%
  merge(mpos4_day[,c("person_id","day_num","WEIGHT_DAY")], by=c("person_id","day_num"), all.x = TRUE)

tour$mode_allday=paste0(tour$uniquemode_unorder,sep = "",collapse = NULL)

person_mode<-tour%>%
  group_by(person_id) %>%
  summarise(mode=paste(uniquemode_unorder,collapse = ""),numday = n()) 


list<-unique(as.numeric(unlist(strsplit(as.character(person_mode[1,2]), ""))))

person_mode$uniquemode_order<-"0"
person_mode$uniquemode_unorder<-"0"
## unique mode
col<-which(colnames(person_mode)=="mode")
i<-1
for (i in (1:nrow(person_mode))){
  list<-unique(as.numeric(unlist(strsplit(as.character(person_mode[i,col]), ""))))
  person_mode[i,col+2]<-paste(list[order(list)], collapse='')
  person_mode[i,col+3]<-paste(list, collapse='')
  i=i+1
}

person_mode$uniquemode_order<-gsub('NA',"", person_mode$uniquemode_order, fixed=TRUE)
person_mode$uniquemode_unorder<-gsub('NA',"", person_mode$uniquemode_order, fixed=TRUE)

# table(trip_chain_o_m_d$uniquemode_order)


### number of people with at least 5 days
num_daily_trip<-merge(mpos4_per[,c("person_id")],person_mode[,c("person_id","numtrip")],by="person_id",all = T)

## total daily trips
num_daily_trip_person<-person %>%
  group_by(person_id) %>%
  summarise(n=mean(numtrip)) %>%
  merge(mpos4_per[,c("person_id")], by="person_id", all.y = T)
num_daily_trip_person$n[is.na(num_daily_trip_person$n)]<-0

nrow(num_daily_trip_person[num_daily_trip_person$n>=5,])/nrow(num_daily_trip_person)


## total frequency & percentage
fre_perc<-person_mode %>%
  merge (mpos4_per[,c("person_id","WEIGHT_PER")], by="person_id")%>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_PER),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))
# summary(person_mode$WEIGHT_DAY)
# fre_perc<-person_mode %>%
#   mutate(total=sum(WEIGHT_TRIP)) %>%
#   group_by(uniquemode_order,hhveh_driver,total) %>%
#   summarise(Frequency = round(sum(WEIGHT_TRIP),0)) %>%
#   mutate(perc= round(Frequency / total*100,4))%>%
#   arrange(desc(perc))


colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(mode="4") %>%
  group_by(mode) %>%
  summarise(n=sum(n),Frequency=sum(Frequency),perc=sum(perc))%>%
  mutate(Frequency=round(Frequency,2),perc=round(perc,2))

fre_perc_tnc_total<-fre_perc_tnc[1,4]
  
## including TNC mode to the Panel 1
### what modes are combined into 1-walk, 2-bike, 3-car, 4-taxi, 5-transit, 6-school bus, 7-other ####

fre_perc_notnc<-fre_perc[c(1:3,5:7,9:11),c("mode","n","Frequency","perc")]
fre_perc_notnc$perc<-round(fre_perc_notnc$perc,2)
fre_perc_notnc$mode<-as.character(fre_perc_notnc$mode)
fre_perc_large<-bind_rows(fre_perc_notnc,fre_perc_tnc)
# fre_perc_large$mode<-c("Car","Car+B/W","B/W","Car+Transit","Transit","Transit + B/W","Car+Transit+B/W")

fre_perc_large$mode <- factor(fre_perc_large$mode, levels=c("3","13","135","123","36","136","1235","35","1356","4"))

person_mode_choice_large<-ggplot(fre_perc_large, aes(x = reorder(mode, -perc), y=perc))+ 
   geom_bar(stat="identity",colour="black", fill ="#1A476F",size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 40)+
  # scale_fill_brewer(palette="#1A476F")+
  scale_x_discrete(limits=c(c("3","13","135","123","36","136","1235","35","1356","4")),
    labels=c("Car\nOnly","Car+\nWalk","Car+\nTransit+\nWalk","Car+\nBike+\nWalk","Car+\nOther","Car+\nWalk+\nOther","Car+\nTransit+\nBike+\nWalk","Car+\nTransit","Car+\nTransit+\nWalk+\nOther","TNC\nRelated"))+
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  # geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
    geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-1.5) +
  labs(x="Panel 1: Modes in All Daily Trip Chain", y="Mode share out of all trip chain (%)") +
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=T))

ggsave("person_mode_choice_large.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


### TNC related 
fre_perc<-person_mode %>%
  merge (mpos4_per[,c("person_id","WEIGHT_PER")], by="person_id")%>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_PER),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))

fre_perc_tnc_total<-fre_perc_tnc[1,4]

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(perc=round(perc/12.3,4))

fre_perc_tnc<-fre_perc_tnc[1:10,]
fre_perc_tnc$mode <- factor(fre_perc_tnc$mode, levels=c("1345","134","34","12345","13456","1346","1234","145","123456","2345"))

person_mode_choice_tnc<-ggplot(fre_perc_tnc, aes(x = reorder(mode, -perc), y=perc*100))+ 
   geom_bar(stat="identity",colour="black",fill="#1A476F",size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 35)+
  scale_x_discrete(limits=c("1345","134","34","12345","13456","1346","1234","145","123456","2345"),
    labels=c("TNC+\nCar+\nTransit+\nWalk",
             "TNC+\nCar+\nWalk","TNC+\nCar",
             "TNC+\nCar+\nTransit+\nBike+\nWalk",
             "TNC+\nCar+\nTransit+\nWalk+\nOther",
             "TNC+\nCar+\nWalk+\nOther",
             "TNC+\nCar+\nBike+\nWalk",
             "TNC+\nTransit+\nWalk",
             "TNC+\nCar+\nTransit+\nBike+\nWalk+\nOther",
             "TNC+\nCar+\nTransit+\nBike"))+
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  geom_text(aes(label=perc*100), position = position_dodge(width = 0.7), vjust=-1.5) +
  labs(x="Panel 2: Modes in TNC Daily Trip Chain", y="Mode share of TNC trip chain (%)") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="right", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14,  face = "bold")) +
  guides(fill = guide_legend(reverse=T))

ggsave("person_mode_choice_tnc.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 4.5,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

# a<-mpos4_per %>% 
#   filter(region!="SACOG") %>% 
#   group_by(WEIGHT_PER) %>% 
#   summarise(n=n())
# b<-mpos4_trip %>% 
#   filter(is_tnc_trip==1)

#### 
#### % tnc+ car/transit/active chaining ####
## non-tnc-containing
fre_perc<-tour %>%
  subset(!is.na(WEIGHT_DAY)) %>%
  group_by(uniquemode_order) %>%
  summarise(n=n(),Frequency = round(sum(WEIGHT_DAY),0)) %>%
  mutate(perc= round(Frequency / sum(Frequency)*100,4))%>%
  arrange(desc(perc))

colnames(fre_perc)[1]<-"mode"
fre_perc$tnc<-str_count(fre_perc$mode, pattern = "4")
fre_perc_notnc<-na.omit(fre_perc[fre_perc$tnc==0,])

fre_perc_notnc$car<-ifelse(str_detect(fre_perc_notnc$mode, "3")==TRUE,1,0)
fre_perc_notnc$pt<-ifelse(str_detect(fre_perc_notnc$mode, "5")==TRUE,1,0)
fre_perc_notnc$active<-ifelse(str_detect(fre_perc_notnc$mode, "1")|str_detect(fre_perc_notnc$mode, "2")==TRUE,1,0)

sum(fre_perc_notnc$perc[fre_perc_notnc$car==1])/ sum(fre_perc_notnc$perc)
sum(fre_perc_notnc$perc[fre_perc_notnc$pt==1])/ sum(fre_perc_notnc$perc)
sum(fre_perc_notnc$perc[fre_perc_notnc$active==1])/ sum(fre_perc_notnc$perc)


## tnc-containing
fre_perc_tnc<-fre_perc%>%
  subset(tnc>0) %>%
  mutate(Frequency=round(Frequency,2),perc=round(perc,4))

fre_perc_tnc$tnc_car<-ifelse(str_detect(fre_perc_tnc$mode, "3")==TRUE,1,0)
fre_perc_tnc$tnc_pt<-ifelse(str_detect(fre_perc_tnc$mode, "5")==TRUE,1,0)
fre_perc_tnc$tnc_active<-ifelse(str_detect(fre_perc_tnc$mode, "1")|str_detect(fre_perc_tnc$mode, "2")==TRUE,1,0)

sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_car==1])/ sum(fre_perc_tnc$perc)
sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_pt==1])/ sum(fre_perc_tnc$perc)
sum(fre_perc_tnc$perc[fre_perc_tnc$tnc_active==1])/ sum(fre_perc_tnc$perc)

person_mode_choice_large
```





### Multi-modal Integration

#### Active modes share
```{r}
table(mpos4_trip$mode_recode)
active_mode_share<-mpos4_trip %>% 
  group_by(mode_recode) %>% 
  summarise(trip_weight=sum(WEIGHT_TRIP)) %>%
  mutate(perc=trip_weight/sum(trip_weight)) %>% 
  filter(mode_recode %in% c("w","b")) %>% 
  # group_by(region)%>%
  summarise(Percent=sum(perc))

```


#### Direct Connection
```{r,Direct Connection with TNC}

## number of occurance of Car in a trip chain

# trip_chain_o_m_d<-read.csv("MPOS4_allpop_trip_chain_o_m_d.csv", header = T)
trip_chain_o_m_d$numCar <- str_count(trip_chain_o_m_d$o_mode_d, "car")
numCar<-trip_chain_o_m_d %>%
  summarise(totalTNC=round(sum(numCar*WEIGHT_TRIP),2))

## number of occurance of TNC in a trip chain
trip_chain_o_m_d$numTNC <- str_count(trip_chain_o_m_d$o_mode_d, "tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_s")
numTNC<-trip_chain_o_m_d %>%
  summarise(totalTNC=round(sum(numTNC*WEIGHT_TRIP),2))

## number of occurance of TNC-Transit
trip_chain_o_m_d$numTNC_transit <- str_count(trip_chain_o_m_d$o_mode_d, "pt-tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_s-pt")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc-pt")+
  str_count(trip_chain_o_m_d$o_mode_d, "pt-tnc_s")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_7_pt")+
  str_count(trip_chain_o_m_d$o_mode_d, "pt_7_tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_s_7_pt")+
  str_count(trip_chain_o_m_d$o_mode_d, "pt_7_tnc_s")

numTNC_transit<-trip_chain_o_m_d %>%
  summarise(totalTNC_transit=round(sum(numTNC_transit*WEIGHT_TRIP),2))
  
## number of occurance of TNC-Active Transportation
trip_chain_o_m_d$numTNC_active <- str_count(trip_chain_o_m_d$o_mode_d, "b-tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "w-tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_7_b")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_7_w")+
  str_count(trip_chain_o_m_d$o_mode_d, "b_7_tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "w_7_tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_s_7_b")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_s_7_w")+
  str_count(trip_chain_o_m_d$o_mode_d, "b_7_tnc_s")+
  str_count(trip_chain_o_m_d$o_mode_d, "w_7_tnc_s")

numTNC_active<-trip_chain_o_m_d %>%
  summarise(totalTNC_active=round(sum(numTNC_active*WEIGHT_TRIP),2))


## number of occurance of TNC as a mode transfer
trip_chain_o_m_d$numTNC_transfer <-str_count(trip_chain_o_m_d$o_mode_d, "tnc-")+
  str_count(trip_chain_o_m_d$o_mode_d, "-tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_s-")+
  str_count(trip_chain_o_m_d$o_mode_d, "-tnc_s")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_7")+
  str_count(trip_chain_o_m_d$o_mode_d, "7_tnc")+
  str_count(trip_chain_o_m_d$o_mode_d, "tnc_s_7")+
  str_count(trip_chain_o_m_d$o_mode_d, "7_tnc_s")

## number of occurance of TNC-Other
trip_chain_o_m_d$numTNC_other<-trip_chain_o_m_d$numTNC_transfer-trip_chain_o_m_d$numTNC_transit-trip_chain_o_m_d$numTNC_active

numTNC_other<-trip_chain_o_m_d %>%
  summarise(totalTNC_other=round(sum(numTNC_other*WEIGHT_TRIP),2))


# ## numTNC/numtotaltrip
# sum(trip_chain_o_m_d$numTNC*trip_chain_o_m_d$WEIGHT_HH)/ sum(trip_chain_o_m_d$numtrip*trip_chain_o_m_d$WEIGHT_HH)# 0.04493728
# 
# sum(trip_chain_o_m_d$numTNC_firstlast*trip_chain_o_m_d$WEIGHT_HH)/ sum(trip_chain_o_m_d$numTNC*trip_chain_o_m_d$WEIGHT_HH)  #0.6920469
# 
# sum(trip_chain_o_m_d$numTNC_transfer*trip_chain_o_m_d$WEIGHT_HH)/ sum(trip_chain_o_m_d$numTNC*trip_chain_o_m_d$WEIGHT_HH) #0.0282138
# 
# 
# ### get trip chain OD ###
# trip_chain_o_d<- mpos4_trip_home %>%
#   arrange(TDTRPNUM,HOUSEID,PERSONID)%>%
#   group_by(HOUSEID,PERSONID) %>%
#   summarise(OD=paste(WHYFROM,collapse = "_"),numtrip = n()) %>%
#   arrange(HOUSEID,PERSONID)
# trip_chain_o_d$O_D<- with(trip_chain_o_d,paste0(OD,"_1"))

write.csv(trip_chain_o_m_d,"MPOS4_allpop_trip_chain_o_m_d.csv",row.names = F)

```

#### VMT & Duration
##### Transit
```{r,VMT & Duration of Direct Connection with TNC-transit}
trip_chain_o_m_d<-setDT(read.csv("MPOS4_allpop_trip_chain_o_m_d.csv",colClasses = c('person_id'='character'),header=TRUE))

#### total number of TNC trip ####
# nrow(trip_chain_o_m_d[trip_chain_o_m_d$numTNC>0,])
# tnc_region<- mpos4_trip %>%
#   subset(is_tnc_trip_new==1) %>%
#   group_by(region) %>%
#   summarise(n=n()) ## 8776 



#### TNC-TRANSIT ####

TNC_transit<-trip_chain_o_m_d[trip_chain_o_m_d$numTNC_transit>0,c("person_id","day_num")]%>%
  merge(mpos4_trip, by=c("person_id","day_num"))

TNC_transit<-arrange(TNC_transit,person_id,day_num,trip_num)
  
TNC_transit$directTNC_transit<-0
for (i in (1:nrow(TNC_transit))){
  if (TNC_transit$mode_recode[i] %in% c("pt-tnc","tnc_s-pt","tnc-pt","pt-tnc_s")){
    TNC_transit$directTNC_transit[i]<-1
  } else if (TNC_transit$mode_d_nextmode[i] %in% c("tnc_7_pt","pt_7_tnc","tnc_s_7_pt","pt_7_tnc_s")) {
    TNC_transit$directTNC_transit[i]<-1
    TNC_transit$directTNC_transit[i+1]<-1
  }
}



# TNC_transit<-TNC_transit[TNC_transit$directTNC_transit==1,] %>%
#   mutate(tnc=ifelse(str_detect(mode_recode,"tnc")==TRUE,1,0)) %>%
#   mutate(pt=ifelse(str_detect(mode_recode,"pt")==TRUE,1,0))

TNC_transit<-TNC_transit[TNC_transit$directTNC_transit==1,] %>%
  mutate(tnc=ifelse(mode_recode=="tnc"|mode_recode=="tnc_s",1,0)) %>%
  mutate(pt=ifelse(mode_recode=="pt",1,0))

TNC_transit$mode_1<-dplyr::recode(TNC_transit$mode_1,  `0` = 995L,`23` = 46L,`30` = 39L, `26` = 28L,`67` = 28L )

TNC_transit$nextmode<-lead(TNC_transit$mode_1)
TNC_transit$priormode<-lag(TNC_transit$mode_1)
TNC_transit$tnc_ptmode_detail<-ifelse(TNC_transit$mode_d_nextmode %in% c("tnc_7_pt","tnc_s_7_pt"),TNC_transit$nextmode,
                                      ifelse(TNC_transit$priormode_o_mode %in% c("pt_7_tnc","pt_7_tnc_s"),TNC_transit$priormode,NA))

tnc_transit <-TNC_transit %>% 
 filter(tnc==1)

write.csv(tnc_transit,"tnc_transit.csv", row.names = F)

## vmt-- TNC
TNC_transit_tncvmt<-TNC_transit[TNC_transit$tnc==1,]%>%
  summarise(avgvmt=mean(distance))

TNC_transit_tncvmt_mode<-TNC_transit[TNC_transit$tnc==1,]%>%
  group_by(tnc_ptmode_detail) %>%
  summarise(sample=n(),avgvmt=mean(distance)) %>%
  mutate(perc= sample/sum(sample)*100) 

# table(TNC_transit$tnc_ptmode_detail)

TNC_transit_tncvmt_mode$mode_combine<-ifelse(TNC_transit_tncvmt_mode$tnc_ptmode_detail==25 | TNC_transit_tncvmt_mode$tnc_ptmode_detail==28| TNC_transit_tncvmt_mode$tnc_ptmode_detail==46| TNC_transit_tncvmt_mode$tnc_ptmode_detail==55 | TNC_transit_tncvmt_mode$tnc_ptmode_detail==62 , "Bus/Shuttle",
                                              ifelse(TNC_transit_tncvmt_mode$tnc_ptmode_detail==30 | TNC_transit_tncvmt_mode$tnc_ptmode_detail== 39 | TNC_transit_tncvmt_mode$tnc_ptmode_detail== 41 | TNC_transit_tncvmt_mode$tnc_ptmode_detail== 42,"Rail","Boat/Ferry/Water taxi"))


TNC_transit_tncvmt_mode$mode_combine<-factor(TNC_transit_tncvmt_mode$mode_combine,levels = c("Bus/Shuttle","Rail","Boat/Ferry/Water taxi"))

direct_TNC_transit_tncvmt<-ggplot(TNC_transit_tncvmt_mode, aes(x =as.factor(tnc_ptmode_detail),y=avgvmt,fill=as.factor(mode_combine)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 10)+
  scale_x_discrete(limits=c(c("46","25","55","62","28","39","41","42","32")),
    labels=c("Public bus\n(n=20)","Intercity bus\n(n=4)","Express bus\n(n=5)","Employer\nshuttle/bus\n(n=19)","Other bus\n(n=8)","Light rail\n/subway\n(n=80)","Intercity rail\n(n=90)","Other rail\n(n=2)","Boat/ferry\n/water taxi\n(n=9)"))+
  geom_text(aes(label=round(avgvmt,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Direct Connection between TNCs and Transit Modes (n=237)", y="Average distance of\nTNC trips (miles)") +
  scale_fill_manual(name = "Mode Category",values = c("darkred","#2b8cbe", "#4daf4a"))+
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="horizontal", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 12,  face = "bold")) +
  guides(fill = guide_legend(reverse=F))              


ggsave("direct_TNC_transit_tncvmt.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 10,
  height = 3.2,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)



## vmt-- transit 
TNC_transit_tranvmt<-TNC_transit[TNC_transit$pt==1,]%>%
  summarise(avgvmt=mean(distance))

TNC_transit_tranvmt_mode<-TNC_transit[TNC_transit$pt==1,]%>%
  group_by(mode_1) %>%
  summarise(sample=n(),avgvmt=mean(distance)) %>%
  mutate(perc= sample/sum(sample)*100) # n=237


TNC_transit_tranvmt_mode$mode_combine<-ifelse(TNC_transit_tranvmt_mode$mode_1==25 | TNC_transit_tranvmt_mode$mode_1==28| TNC_transit_tranvmt_mode$mode_1==46| TNC_transit_tranvmt_mode$mode_1==55 | TNC_transit_tranvmt_mode$mode_1==62 , "Bus/Shuttle",
                                              ifelse(TNC_transit_tranvmt_mode$mode_1==30 | TNC_transit_tranvmt_mode$mode_1== 39 | TNC_transit_tranvmt_mode$mode_1== 41 | TNC_transit_tranvmt_mode$mode_1== 42,"Rail","Boat/Ferry/Water taxi"))


TNC_transit_tranvmt_mode$mode_combine<-factor(TNC_transit_tranvmt_mode$mode_combine,levels = c("Bus/Shuttle","Rail","Boat/Ferry/Water taxi"))

direct_TNC_transit_vmt<-ggplot(TNC_transit_tranvmt_mode, aes(x =as.factor(mode_1),y=avgvmt,fill=as.factor(mode_combine)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 83)+
  scale_x_discrete(limits=c(c("46","25","55","62","28","39","41","42","32")),
    labels=c("Public bus\n(n=20)","Intercity bus\n(n=4)","Express bus\n(n=5)","Employer\nshuttle/bus\n(n=19)","Other bus\n(n=8)","Light rail\n/subway\n(n=80)","Intercity rail\n(n=90)","Other rail\n(n=2)","Boat/ferry\n/water taxi\n(n=9)"))+
  geom_text(aes(label=round(avgvmt,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Direct Connection between TNCs and Transit Modes (n=237)", y="Average distance of\ntransit trips (miles)") +
  scale_fill_manual(name = "Mode Category",values = c("darkred","#2b8cbe", "#4daf4a") )+
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="horizontal", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 12,  face = "bold")) +
  guides(fill = guide_legend(reverse=F))              


ggsave("direct_TNC_transit_vmt.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 10,
  height = 3.2,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

# #### duration_imputed #####
# TNC_transit_tnctime<-TNC_transit[TNC_transit$tnc==1,]%>%
#   summarise(avgtime=mean(duration_imputed))
# 
# TNC_transit_trantime<-TNC_transit[TNC_transit$pt==1,]%>%
#   summarise(avgtime=mean(duration_imputed))
# 
# TNC_transit_trantime_mode<-TNC_transit[TNC_transit$pt==1,]%>%
#   # subset(!is.na(duration_imputed)) %>%
#   group_by(mode_1) %>%
#   summarise(sample=n(),avgtime=mean(duration_imputed)) %>%
#   mutate(perc= sample/sum(sample)*100)  
# 
# 
# TNC_transit_trantime_mode$mode_combine<-ifelse(TNC_transit_trantime_mode$mode_1==25 | TNC_transit_trantime_mode$mode_1==28| TNC_transit_trantime_mode$mode_1==46| TNC_transit_trantime_mode$mode_1==55 | TNC_transit_trantime_mode$mode_1==62 , "Bus/Shuttle",
#                                               ifelse(TNC_transit_trantime_mode$mode_1==30 | TNC_transit_trantime_mode$mode_1== 39 | TNC_transit_trantime_mode$mode_1== 41 | TNC_transit_trantime_mode$mode_1== 42,"Rail","Boat/Ferry/Water taxi"))
# 
# 
# TNC_transit_trantime_mode$mode_combine<-factor(TNC_transit_trantime_mode$mode_combine,levels = c("Bus/Shuttle","Rail","Boat/Ferry/Water taxi"))
# 
# 
# direct_TNC_transit_time<-ggplot(TNC_transit_trantime_mode, aes(x =as.factor(mode_1),y=avgtime,fill=as.factor(mode_combine)))+ 
#    geom_bar(stat="identity",colour="black", size=.2, alpha=1
#              ,width=0.6, position = position_dodge(width=0.7)) +
#   ylim(0, 83)+
#   scale_x_discrete(limits=c(c("46","25","55","62","28","39","41","42","32")),
#     labels=c("Public bus\n(n=20)","Intercity bus\n(n=4)","Express bus\n(n=5)","Employer\nshuttle/bus\n(n=19)","Other bus\n(n=8)","Light rail\n/subway\n(n=80)","Intercity rail\n(n=90)","Other rail\n(n=2)","Boat/ferry\n/water taxi\n(n=9)"))+
#   geom_text(aes(label=round(avgtime,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
#   labs(x="Direct Connection between TNCs and Transit Modes (n=237)", y="Average Duration\n (mins)") +
#   scale_fill_discrete(name = "Mode Category")+
#   # ggtitle("Composition of Exports to China ($)") + 
#   # scale_fill_manual(values=fill) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 12), 
#     axis.text.y=element_text(colour="black", size = 12),
#     axis.title.x=element_text(colour="black", size = 14),
#     axis.title.y=element_text(colour="black", size = 14),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="bottom", legend.direction="horizontal", 
#     legend.title =element_text(colour="black", size = 12),
#     legend.text = element_text(colour="black", size = 12),
#     # panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     # text=element_text(family="Times")) +
#       plot.title = element_text(size = 12,  face = "bold")) +
#   guides(fill = guide_legend(reverse=F))              
# 
# 
# ggsave("direct_TNC_transit_time.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
#   scale = 1,
#   width = 10,
#   height = 3,
#   # units = c("in", "cm", "mm"),
#   dpi = 300,
#   limitsize = TRUE
# )


```

##### Active
```{r,VMT & Duration of Direct Connection with TNC-active}

#### TNC-ACTIVE ####

TNC_active<-trip_chain_o_m_d[trip_chain_o_m_d$numTNC_active>0,c("person_id","day_num")]%>%
  merge(mpos4_trip, by=c("person_id","day_num"))

TNC_active<-arrange(TNC_active,person_id,day_num,trip_num)
  
# table(TNC_active$mode_recode)
# table(TNC_active$mode_d_nextmode)

TNC_active$directTNC_active<-0
for (i in (1:nrow(TNC_active))){
  if (TNC_active$mode_recode[i] %in% c("b-tnc","w-tnc")){
    TNC_active$directTNC_active[i]<-1
  } else if (TNC_active$mode_d_nextmode[i] %in% c("tnc_7_w","w_7_tnc","tnc_7_b","b_7_tnc","tnc_s_7_w","w_7_tnc_s","tnc_s_7_b","b_7_tnc_s")) {
    TNC_active$directTNC_active[i]<-1
    TNC_active$directTNC_active[i+1]<-1
  }
}


# TNC_active<-TNC_active[TNC_active$directTNC_active==1,] %>%
#   mutate(tnc=ifelse(str_detect(mode_recode,"tnc")==TRUE,1,0)) %>%
#   mutate(pt=ifelse(str_detect(mode_recode,"pt")==TRUE,1,0))

TNC_active<-TNC_active[TNC_active$directTNC_active==1,] %>%
  mutate(tnc=ifelse(mode_recode=="tnc"|mode_recode=="tnc_s",1,0)) %>%
    mutate(active=ifelse(mode_recode=="w"|mode_recode=="b",1,0))%>%
  mutate(w=ifelse(mode_recode=="w",1,0))%>%
  mutate(b=ifelse(mode_recode=="b",1,0))
# TNC_active$speed<-TNC_active$distance/(TNC_active$duration_imputed/60)
# TNC_active$pt<-ifelse(TNC_active$tnc==1 & TNC_active$pt==1, TNC_active$pt==0,TNC_active$pt)


TNC_active$nextmode<-lead(TNC_active$mode_1)
TNC_active$priormode<-lag(TNC_active$mode_1)
TNC_active$tnc_activemode_detail<-ifelse(TNC_active$mode_d_nextmode %in% c("tnc_7_w","tnc_7_b","tnc_s_7_w","tnc_s_7_b"),TNC_active$nextmode,
                                      ifelse(TNC_active$priormode_o_mode %in% c("w_7_tnc","b_7_tnc","w_7_tnc_s","b_7_tnc_s"),TNC_active$priormode,NA))

## vmt-- TNC
TNC_active_tncvmt<-TNC_active[TNC_active$tnc==1& TNC_active$distance<5,]%>%
  summarise(avgvmt=mean(distance))

TNC_active_tncvmt_mode<-TNC_active[TNC_active$tnc==1 & TNC_active$distance<5,]%>%
  group_by(tnc_activemode_detail) %>%
  summarise(sample=n(),avgvmt=mean(distance)) %>%
  mutate(perc= sample/sum(sample)*100) 

direct_TNC_active_tncvmt<-ggplot(TNC_active_tncvmt_mode, aes(x =as.factor(tnc_activemode_detail),y=avgvmt))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 35)+
  scale_x_discrete(limits=c(c("1","69","74")),
    labels=c("Walking\n(n=198)","Bikeshare\n(n=1)","Segway\n(n=1)"))+
  geom_text(aes(label=round(avgvmt,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Direct Connection between TNCs and Active Modes (n=200)", y="Average VMT of\nTNC (miles)") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="horizontal", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 12,  face = "bold")) +
  guides(fill = guide_legend(reverse=F))              


ggsave("direct_TNC_active_tncvmt.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 6,
  height = 3,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


## vmt -- Active modes
TNC_active_activevmt<-TNC_active[TNC_active$active==1 & TNC_active$distance<5,]%>%
  summarise(avgvmt=mean(distance))

TNC_active_activevmt_mode<-TNC_active[TNC_active$active==1 & TNC_active$distance<5 ,]%>%
  group_by(mode_1) %>%
  summarise(sample=n(),avgvmt=mean(distance)) %>%
  mutate(perc= sample/sum(sample)*100)  


direct_TNC_active_vmt<-ggplot(TNC_active_activevmt_mode, aes(x =as.factor(mode_1),y=avgvmt))+ 
   geom_bar(stat="identity",colour="black",fill="#2b8cbe",size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 0.6)+
  scale_x_discrete(limits=c(c("1","69","74")),
    labels=c("Walking\n(n=198)","Bikeshare\n(n=1)","Segway\n(n=1)"))+
  geom_text(aes(label=round(avgvmt,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Direct Connection between TNCs and Active Modes (n=200)", y="Average distance of\n active modes (miles)") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="horizontal", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 12,  face = "bold")) +
  guides(fill = guide_legend(reverse=F))              


ggsave("direct_TNC_active_vmt.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 6,
  height = 3,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

direct_TNC_active_vmt<-ggplot(TNC_active_activevmt_mode, aes(x =as.factor(mode_1),y=avgvmt))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  # ylim(0, 4)+
  scale_x_discrete(limits=c(c("1","69","74")),
    labels=c("Walking\n(n=198)","Bikeshare\n(n=1)","Segway\n(n=1)"))+
  geom_text(aes(label=round(avgvmt,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Direct Connection between TNCs and Active Modes (n=200)", y="Average VMT of\nactive modes (miles)") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="horizontal", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 12,  face = "bold")) +
  guides(fill = guide_legend(reverse=F))              


ggsave("direct_TNC_active_tncvmt.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 6,
  height = 3,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)


#### duration_imputed ####
# TNC_active_tnctime<-TNC_active[TNC_active$tnc==1,]%>%
#   summarise(avgtime=mean(duration_imputed))
# 
# TNC_active_activetime<-TNC_active[TNC_active$active==1,]%>%
#   summarise(avgtime=mean(duration_imputed))
# 
# TNC_active_activetime_mode<-TNC_active[TNC_active$active==1,]%>%
#   group_by(mode_1) %>%
#   summarise(sample=n(),avgtime=mean(duration_imputed)) %>%
#   mutate(perc= sample/sum(sample)*100)  
# 
#   
# direct_TNC_active_time<-ggplot(TNC_active_activetime_mode, aes(x =as.factor(mode_1),y=avgtime))+ 
#    geom_bar(stat="identity",colour="black", size=.2, alpha=1
#              ,width=0.6, position = position_dodge(width=0.7)) +
#   ylim(0, 14)+
#   scale_x_discrete(limits=c(c("1","69","74")),
#     labels=c("Walking\n(n=198)","Bikeshare\n(n=1)","Segway\n(n=1)"))+
#   geom_text(aes(label=round(avgtime,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
#   labs(x="Direct Connection between TNCs and Active Modes (n=200)", y="Average Duration\n (mins)") +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 12), 
#     axis.text.y=element_text(colour="black", size = 12),
#     axis.title.x=element_text(colour="black", size = 14),
#     axis.title.y=element_text(colour="black", size = 14),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="bottom", legend.direction="horizontal", 
#     legend.title =element_text(colour="black", size = 12),
#     legend.text = element_text(colour="black", size = 12),
#     # panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     # text=element_text(family="Times")) +
#       plot.title = element_text(size = 12,  face = "bold")) +
#   guides(fill = guide_legend(reverse=F))              
# 
# 
# ggsave("direct_TNC_active_time.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
#   scale = 1,
#   width = 6,
#   height = 3,
#   # units = c("in", "cm", "mm"),
#   dpi = 300,
#   limitsize = TRUE
# )



```

##### Access/Egress
```{r,VMT & Duration of Direct Connection with TNC-transit}
access_egress<-mpos4_trip %>% 
  filter()


trip_chain_o_m_d<-setDT(read.csv("MPOS4_allpop_trip_chain_o_m_d.csv",colClasses = c('person_id'='character'),header=TRUE))

#### total number of TNC trip ####
# nrow(trip_chain_o_m_d[trip_chain_o_m_d$numTNC>0,])
# tnc_region<- mpos4_trip %>%
#   subset(is_tnc_trip_new==1) %>%
#   group_by(region) %>%
#   summarise(n=n()) ## 8776 



#### TNC-TRANSIT ####

TNC_transit<-trip_chain_o_m_d[trip_chain_o_m_d$numTNC_transit>0,c("person_id","day_num")]%>%
  merge(mpos4_trip, by=c("person_id","day_num"))

TNC_transit<-arrange(TNC_transit,person_id,day_num,trip_num)
  
TNC_transit$directTNC_transit<-0
for (i in (1:nrow(TNC_transit))){
  if (TNC_transit$mode_recode[i] %in% c("pt-tnc","tnc_s-pt","tnc-pt","pt-tnc_s")){
    TNC_transit$directTNC_transit[i]<-1
  } else if (TNC_transit$mode_d_nextmode[i] %in% c("tnc_7_pt","pt_7_tnc","tnc_s_7_pt","pt_7_tnc_s")) {
    TNC_transit$directTNC_transit[i]<-1
    TNC_transit$directTNC_transit[i+1]<-1
  }
}



# TNC_transit<-TNC_transit[TNC_transit$directTNC_transit==1,] %>%
#   mutate(tnc=ifelse(str_detect(mode_recode,"tnc")==TRUE,1,0)) %>%
#   mutate(pt=ifelse(str_detect(mode_recode,"pt")==TRUE,1,0))

TNC_transit<-TNC_transit[TNC_transit$directTNC_transit==1,] %>%
  mutate(tnc=ifelse(mode_recode=="tnc"|mode_recode=="tnc_s",1,0)) %>%
  mutate(pt=ifelse(mode_recode=="pt",1,0))

TNC_transit$mode_1<-dplyr::recode(TNC_transit$mode_1,  `0` = 995L,`23` = 46L,`30` = 39L, `26` = 28L,`67` = 28L )

TNC_transit$nextmode<-lead(TNC_transit$mode_1)
TNC_transit$priormode<-lag(TNC_transit$mode_1)
TNC_transit$tnc_ptmode_detail<-ifelse(TNC_transit$mode_d_nextmode %in% c("tnc_7_pt","tnc_s_7_pt"),TNC_transit$nextmode,
                                      ifelse(TNC_transit$priormode_o_mode %in% c("pt_7_tnc","pt_7_tnc_s"),TNC_transit$priormode,NA))


## vmt-- TNC
TNC_transit_tncvmt<-TNC_transit[TNC_transit$tnc==1,]%>%
  summarise(avgvmt=mean(distance))

TNC_transit_tncvmt_mode<-TNC_transit[TNC_transit$tnc==1,]%>%
  group_by(tnc_ptmode_detail) %>%
  summarise(sample=n(),avgvmt=mean(distance)) %>%
  mutate(perc= sample/sum(sample)*100) 

# table(TNC_transit$tnc_ptmode_detail)

TNC_transit_tncvmt_mode$mode_combine<-ifelse(TNC_transit_tncvmt_mode$tnc_ptmode_detail==25 | TNC_transit_tncvmt_mode$tnc_ptmode_detail==28| TNC_transit_tncvmt_mode$tnc_ptmode_detail==46| TNC_transit_tncvmt_mode$tnc_ptmode_detail==55 | TNC_transit_tncvmt_mode$tnc_ptmode_detail==62 , "Bus/Shuttle",
                                              ifelse(TNC_transit_tncvmt_mode$tnc_ptmode_detail==30 | TNC_transit_tncvmt_mode$tnc_ptmode_detail== 39 | TNC_transit_tncvmt_mode$tnc_ptmode_detail== 41 | TNC_transit_tncvmt_mode$tnc_ptmode_detail== 42,"Rail","Boat/Ferry/Water taxi"))


TNC_transit_tncvmt_mode$mode_combine<-factor(TNC_transit_tncvmt_mode$mode_combine,levels = c("Bus/Shuttle","Rail","Boat/Ferry/Water taxi"))

direct_TNC_transit_tncvmt<-ggplot(TNC_transit_tncvmt_mode, aes(x =as.factor(tnc_ptmode_detail),y=avgvmt,fill=as.factor(mode_combine)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 10)+
  scale_x_discrete(limits=c(c("46","25","55","62","28","39","41","42","32")),
    labels=c("Public bus\n(n=20)","Intercity bus\n(n=4)","Express bus\n(n=5)","Employer\nshuttle/bus\n(n=19)","Other bus\n(n=8)","Light rail\n/subway\n(n=80)","Intercity rail\n(n=90)","Other rail\n(n=2)","Boat/ferry\n/water taxi\n(n=9)"))+
  geom_text(aes(label=round(avgvmt,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Direct Connection between TNCs and Transit Modes (n=237)", y="Average distance of\nTNC trips (miles)") +
  scale_fill_manual(name = "Mode Category",values = c("darkred","#2b8cbe", "#4daf4a"))+
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="horizontal", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 12,  face = "bold")) +
  guides(fill = guide_legend(reverse=F))              


ggsave("direct_TNC_transit_tncvmt.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 10,
  height = 3.2,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)



## vmt-- transit 
TNC_transit_tranvmt<-TNC_transit[TNC_transit$pt==1,]%>%
  summarise(avgvmt=mean(distance))

TNC_transit_tranvmt_mode<-TNC_transit[TNC_transit$pt==1,]%>%
  group_by(mode_1) %>%
  summarise(sample=n(),avgvmt=mean(distance)) %>%
  mutate(perc= sample/sum(sample)*100) # n=237


TNC_transit_tranvmt_mode$mode_combine<-ifelse(TNC_transit_tranvmt_mode$mode_1==25 | TNC_transit_tranvmt_mode$mode_1==28| TNC_transit_tranvmt_mode$mode_1==46| TNC_transit_tranvmt_mode$mode_1==55 | TNC_transit_tranvmt_mode$mode_1==62 , "Bus/Shuttle",
                                              ifelse(TNC_transit_tranvmt_mode$mode_1==30 | TNC_transit_tranvmt_mode$mode_1== 39 | TNC_transit_tranvmt_mode$mode_1== 41 | TNC_transit_tranvmt_mode$mode_1== 42,"Rail","Boat/Ferry/Water taxi"))


TNC_transit_tranvmt_mode$mode_combine<-factor(TNC_transit_tranvmt_mode$mode_combine,levels = c("Bus/Shuttle","Rail","Boat/Ferry/Water taxi"))

direct_TNC_transit_vmt<-ggplot(TNC_transit_tranvmt_mode, aes(x =as.factor(mode_1),y=avgvmt,fill=as.factor(mode_combine)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 83)+
  scale_x_discrete(limits=c(c("46","25","55","62","28","39","41","42","32")),
    labels=c("Public bus\n(n=20)","Intercity bus\n(n=4)","Express bus\n(n=5)","Employer\nshuttle/bus\n(n=19)","Other bus\n(n=8)","Light rail\n/subway\n(n=80)","Intercity rail\n(n=90)","Other rail\n(n=2)","Boat/ferry\n/water taxi\n(n=9)"))+
  geom_text(aes(label=round(avgvmt,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs(x="Direct Connection between TNCs and Transit Modes (n=237)", y="Average distance of\ntransit trips (miles)") +
  scale_fill_manual(name = "Mode Category",values = c("darkred","#2b8cbe", "#4daf4a") )+
  # ggtitle("Composition of Exports to China ($)") + 
  # scale_fill_manual(values=fill) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12),
    axis.title=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="horizontal", 
    legend.title =element_text(colour="black", size = 12),
    legend.text = element_text(colour="black", size = 12),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
    # text=element_text(family="Times")) +
      plot.title = element_text(size = 12,  face = "bold")) +
  guides(fill = guide_legend(reverse=F))              


ggsave("direct_TNC_transit_vmt.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 10,
  height = 3.2,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

# #### duration_imputed #####
# TNC_transit_tnctime<-TNC_transit[TNC_transit$tnc==1,]%>%
#   summarise(avgtime=mean(duration_imputed))
# 
# TNC_transit_trantime<-TNC_transit[TNC_transit$pt==1,]%>%
#   summarise(avgtime=mean(duration_imputed))
# 
# TNC_transit_trantime_mode<-TNC_transit[TNC_transit$pt==1,]%>%
#   # subset(!is.na(duration_imputed)) %>%
#   group_by(mode_1) %>%
#   summarise(sample=n(),avgtime=mean(duration_imputed)) %>%
#   mutate(perc= sample/sum(sample)*100)  
# 
# 
# TNC_transit_trantime_mode$mode_combine<-ifelse(TNC_transit_trantime_mode$mode_1==25 | TNC_transit_trantime_mode$mode_1==28| TNC_transit_trantime_mode$mode_1==46| TNC_transit_trantime_mode$mode_1==55 | TNC_transit_trantime_mode$mode_1==62 , "Bus/Shuttle",
#                                               ifelse(TNC_transit_trantime_mode$mode_1==30 | TNC_transit_trantime_mode$mode_1== 39 | TNC_transit_trantime_mode$mode_1== 41 | TNC_transit_trantime_mode$mode_1== 42,"Rail","Boat/Ferry/Water taxi"))
# 
# 
# TNC_transit_trantime_mode$mode_combine<-factor(TNC_transit_trantime_mode$mode_combine,levels = c("Bus/Shuttle","Rail","Boat/Ferry/Water taxi"))
# 
# 
# direct_TNC_transit_time<-ggplot(TNC_transit_trantime_mode, aes(x =as.factor(mode_1),y=avgtime,fill=as.factor(mode_combine)))+ 
#    geom_bar(stat="identity",colour="black", size=.2, alpha=1
#              ,width=0.6, position = position_dodge(width=0.7)) +
#   ylim(0, 83)+
#   scale_x_discrete(limits=c(c("46","25","55","62","28","39","41","42","32")),
#     labels=c("Public bus\n(n=20)","Intercity bus\n(n=4)","Express bus\n(n=5)","Employer\nshuttle/bus\n(n=19)","Other bus\n(n=8)","Light rail\n/subway\n(n=80)","Intercity rail\n(n=90)","Other rail\n(n=2)","Boat/ferry\n/water taxi\n(n=9)"))+
#   geom_text(aes(label=round(avgtime,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
#   labs(x="Direct Connection between TNCs and Transit Modes (n=237)", y="Average Duration\n (mins)") +
#   scale_fill_discrete(name = "Mode Category")+
#   # ggtitle("Composition of Exports to China ($)") + 
#   # scale_fill_manual(values=fill) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 12), 
#     axis.text.y=element_text(colour="black", size = 12),
#     axis.title.x=element_text(colour="black", size = 14),
#     axis.title.y=element_text(colour="black", size = 14),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="bottom", legend.direction="horizontal", 
#     legend.title =element_text(colour="black", size = 12),
#     legend.text = element_text(colour="black", size = 12),
#     # panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     # text=element_text(family="Times")) +
#       plot.title = element_text(size = 12,  face = "bold")) +
#   guides(fill = guide_legend(reverse=F))              
# 
# 
# ggsave("direct_TNC_transit_time.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
#   scale = 1,
#   width = 10,
#   height = 3,
#   # units = c("in", "cm", "mm"),
#   dpi = 300,
#   limitsize = TRUE
# )


```





---- Trip Length of TNC trips and linked trips ----

```{r,}

```



---- Trips and VMT by auto and TNC among TNC users and drivers ----

---- TNC Users ----

```{r, Occupancy-adjusted VMT)}
library("plyr")
# detach(package:plyr)
library("dplyr")

mpos4_trip = setDT(read.csv("HTS2018_Place_release_processed.csv",header=TRUE)) 
mpos4_trip<-mpos4_trip[mpos4_trip$tnc_user_new>=0,]

mpos4_trip$DriverPassen<-ifelse(mpos4_trip$driver==1,"D",
                            ifelse(mpos4_trip$driver==2,"P",
                                   ifelse(str_detect( mpos4_trip$mode_recode,"tnc")==T,"TNC",
                                          ifelse(str_detect(mpos4_trip$mode_recode,"tnc")==F & str_detect(mpos4_trip$mode_recode,"car")==F,"-1",
                                           "D"))))

mpos4_trip$VMT_modetype<-ifelse(mpos4_trip$mode_recode=="car","car",
                                 ifelse(mpos4_trip$mode_recode=="tnc","tnc",-1))
# table(mpos4_trip$VMT_modetype)

###### occupany-weighted VMT
mpos4_trip$num_travelers[mpos4_trip$num_travelers==0]<-1
## TNC driver doesn't count

mpos4_trip$avgTRPMILES<-ifelse(mpos4_trip$num_travelers>0,mpos4_trip$distance/mpos4_trip$num_travelers,-1)

# mpos4_trip$avgTRPMILES_dhm<-mpos4_trip$avgTRPMILES
# mpos4_trip$avgTRPMILES_dhm[mpos4_trip$DriverPassen == "TNC"] <- mpos4_trip$avgTRPMILES[mpos4_trip$DriverPassen == "TNC"]*8/5 

# VMT<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0 ] %>%
#   group_by(HOUSEID,PERSONID,TNCuser,WTPERFIN) %>%
#   summarise(split_VMT=sum(avgTRPMILES)) %>%
#   group_by(TNCuser)%>%
#   summarise(split_VMT=sum(split_VMT*WTPERFIN),sum_WTPERFIN=sum(WTPERFIN)) %>%
#   mutate(final_VMT=split_VMT/sum_WTPERFIN)
# avg_VMT<-sum(VMT$split_VMT)/sum(VMT$sum_WTPERFIN)

detach(package:plyr)
library("dplyr")

## Vehicle Ownership
mpos4_trip<-mpos4_trip %>%
  merge(mpos4_hh[,c("hh_id","num_trips_hh")],by=c("hh_id"),all.x=TRUE) %>%
  merge(mpos4_per[,c("person_id","license")],by=c("person_id"),all.x=TRUE) 

mpos4_trip$hhveh_driver<-ifelse(mpos4_trip$license==1 & mpos4_trip$num_trips_hh>0, 1,
                               ifelse(mpos4_trip$license==0 | mpos4_trip$num_trips_hh==0,0,-1))

# nrow(mpos4_trip[mpos4_trip$avgTRPMILES>500,])
##### VMT by TNCuser & Veh Ownership

sum_VMT<-mpos4_trip[(mpos4_trip$VMT_modetype %in% c("car","tnc")) & mpos4_trip$avgTRPMILES<=500 & mpos4_trip$tnc_user_new>0 & mpos4_trip$avgTRPMILES>0,]%>%
  mutate(VMT=avgTRPMILES*WEIGHT_TRIP) %>%
  group_by(person_id,tnc_user_new,hhveh_driver) %>%
  summarise(sum_VMT=sum(VMT)/WEIGHT_TRIP) 

mean(sum_VMT$VMT)
mean(mpos4_trip[(mpos4_trip$VMT_modetype %in% c("car","tnc")) & mpos4_trip$avgTRPMILES<=500 & mpos4_trip$tnc_user_new>0 & mpos4_trip$avgTRPMILES>0,]$avgTRPMILES)

sum_VMT<-mpos4_trip[(mpos4_trip$VMT_modetype %in% c("car","tnc")) & mpos4_trip$avgTRPMILES<=500 & mpos4_trip$tnc_user_new>0 & mpos4_trip$avgTRPMILES>0,]%>%
  mutate(VMT=avgTRPMILES*WEIGHT_TRIP) %>%
  group_by(person_id)%>%
  summarise(VMT=sum(avgTRPMILES)/sum(WEIGHT_TRIP))

sum_VMT<-mpos4_trip[(mpos4_trip$VMT_modetype %in% c("car","tnc")) & mpos4_trip$avgTRPMILES<=500 & mpos4_trip$tnc_user_new>0 & mpos4_trip$avgTRPMILES>0,]%>%
  mutate(VMT=avgTRPMILES*WEIGHT_TRIP) %>%
  group_by(person_id,tnc_user_new,hhveh_driver,VMT_modetype) %>%
  summarise(sum_VMT=sum(VMT)/sum(hh_weight_7day*multiday_factor_7)) 

sum_POP<-mpos4_trip[(mpos4_trip$VMT_modetype %in% c("car","tnc")) & mpos4_trip$avgTRPMILES<=500 & mpos4_trip$tnc_user_new>0 & mpos4_trip$avgTRPMILES>0,]%>%
  # distinct(person_id, .keep_all = TRUE)%>%
  group_by(tnc_user_new,hhveh_driver,VMT_modetype) %>%
  summarise(sum_POP=sum(hh_weight_7day*multiday_factor_7)) 

final<-merge(sum_VMT,sum_POP, by=c("tnc_user_new","hhveh_driver","VMT_modetype"))
final$avg_VMT<-sum_VMT$sum_VMT/sum_POP$sum_POP

mean(sum_VMT$sum_VMT)

%>%
  group_by(TNCuser,DriverPassen, veh) %>%
  summarise(total_VMT=sum(sum_VMT))
VMT<-mpos4_trip[(mpos4_trip$VMT_modetype %in% c("car","tnc")) & mpos4_trip$avgTRPMILES<=500 & mpos4_trip$tnc_user_new>0 & mpos4_trip$avgTRPMILES>0,]%>%
  mutate(VMT=avgTRPMILES*WEIGHT_TRIP) %>%
  group_by(person_id,tnc_user_new,hhveh_driver) %>%
  
  summarise(sum_VMT=sum(VMT)) %>%
  group_by(TNCuser,DriverPassen, veh) %>%
  summarise(total_VMT=sum(sum_VMT))



# Population by user type
pop_user<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0, ]%>%
  group_by(TNCuser,HOUSEID,PERSONID,WTPERFIN,veh) %>%
  summarise(pop=mean(WTPERFIN)) %>%
  group_by(TNCuser,veh) %>%
  summarise(pop_user=sum(pop))

finalVMT<-merge(pop_user, VMT3, by=c("TNCuser","veh"))
finalVMT$meanVMT=finalVMT$total_VMT/finalVMT$pop_user

totalVM<-finalVMT %>%
  group_by(TNCuser) %>%
  summarise(totalVM=sum(meanVMT))



###### Total average VMT for all population
VMT_total<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0 ,]%>%
  group_by(DriverPassen,HOUSEID,PERSONID,WTPERFIN,veh) %>%
  mutate(VMT=avgTRPMILES*WTPERFIN) %>%
  summarise(sum_VMT=sum(VMT))%>%
  group_by(DriverPassen,veh) %>%
  summarise(total_VMT=sum(sum_VMT))

#population by user type
pop_total<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0, ]%>%
  group_by(HOUSEID,PERSONID,WTPERFIN,veh,DriverPassen) %>%
  summarise(pop=mean(WTPERFIN))%>%
  group_by(DriverPassen,veh) %>%
  summarise(pop_user=sum(pop))

# pop_total<-sum(pop_total$pop)

finalVMT<-merge(pop_total, VMT_total, by=c("DriverPassen","veh"))
finalVMT$meanVMT=finalVMT$total_VMT/finalVMT$pop_user
all<-sum(VMT_total$meanVMT)



# ###### Overall VMT
# VMT_overall<-mpos4_trip[mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' ,] %>%
#   group_by(DriverPassen,HOUSEID,PERSONID,WTPERFIN) %>%
#   mutate(VMT=TRPMILES*WTPERFIN) %>%
#   summarise(sum_VMT=sum(VMT))%>%
#   group_by(DriverPassen) %>%
#   summarise(total_VMT=sum(sum_VMT))
# 
# #population by user type
# pop_total<-mpos4_trip[(mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1'),] %>%
#   group_by(HOUSEID,PERSONID,WTPERFIN) %>%
#   summarise(pop=mean(WTPERFIN))
# 
# pop_total<-sum(pop_total$pop)
# finalVMT<-merge(pop_user, VMT3, by="TNCuser")
# VMT_total$meanVMT=VMT_total$total_VMT/pop_total


VMT3<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0, ]%>%
  mutate(VMT=avgTRPMILES_dhm*WTPERFIN) %>%
  group_by(DriverPassen,HOUSEID,PERSONID,WTPERFIN,veh) %>%
  summarise(sum_VMT=sum(VMT))%>%
  group_by(DriverPassen, veh) %>%
  summarise(total_VMT=sum(sum_VMT))

# Population by user type
pop_user<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0, ]%>%
  group_by(HOUSEID,PERSONID,WTPERFIN,veh) %>%
  summarise(pop=mean(WTPERFIN)) %>%
  group_by(veh) %>%
  summarise(pop_user=sum(pop))

finalVMT<-merge(pop_user, VMT3, by=c("veh"))
finalVMT$meanVMT=finalVMT$total_VMT/finalVMT$pop_user

totalVM<-finalVMT %>%
  group_by(TNCuser) %>%
  summarise(totalVM=sum(meanVMT))

###### Overall VMT
VMT_overall<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0, ]%>%
  group_by(DriverPassen,HOUSEID,PERSONID,WTPERFIN,veh) %>%
  mutate(VMT=TRPMILES*WTPERFIN) %>%
  summarise(sum_VMT=sum(VMT))%>%
  group_by(DriverPassen,veh) %>%
  summarise(total_VMT=sum(sum_VMT))

#population by user type
pop_total<-mpos4_trip[(mpos4_trip$mode_recode=='mo' | mpos4_trip$mode_recode=='tnc') & mpos4_trip$TRPMILES>=0 & mpos4_trip$TRPMILES<=500 & mpos4_trip$TNCuser != '-1' & mpos4_trip$DriverPassen != 'Other'& mpos4_trip$avgTRPMILES>0, ] %>%
  group_by(veh) %>%
  summarise(pop=mean(WTPERFIN))

finalVMT<-merge(pop_total, VMT_overall, by="veh")
finalVMT$meanVMT=finalVMT$total_VMT/finalVMT$pop

```

```{r, Travel Behavior (Weighted, shared rides & VMTs)}
library("plyr")
detach(package:plyr)
library("dplyr")


# table(trip17$HH_ONTD) 
trip17$totPopInVeh<-as.numeric(trip17$HH_ONTD)+as.numeric(trip17$NONHHCNT) ## TNC driver doesn't count
trip17$totPopInVehCate<-ifelse(trip17$totPopInVeh==1,"sov",
                               ifelse(trip17$totPopInVeh>1,"hov","-1"))
# table(trip17$totPopInVehCate)

##### shared VMT & trip on personal vehicle -- look into driver 
VMT<-trip17[trip17$TRPTRANS=='mo' & trip17$TRPMILES>=0 & trip17$TRPMILES<=500 & trip17$TNCuser != '-1' & trip17$DriverPassen == 'D' & trip17$totPopInVehCate!="-1" ] %>%
  mutate(VMT=TRPMILES*WTPERFIN, trip=WTPERFIN) %>%
  group_by(totPopInVehCate) %>%
  summarise(sum_VMT=sum(VMT),sum_trip=sum(trip)) %>%
  mutate(perc_VMT = round((sum_VMT / sum(sum_VMT)*100),1), perc_trip = round((sum_trip / sum(sum_trip)*100),1))
# table(VMT3$totPopInVehCate)


##### shared VMT & trip on TNC 

shareTNC<-trip17[,c("HOUSEID","PERSONID","R_AGE","STRTTIME","ENDTIME","TRPTRANS","TRPMILES","DriverPassen","totPopInVeh","NONHHCNT","HH_ONTD", "WTPERFIN")][trip17$TRPTRANS=='tnc']
# table(shareTNC$totPopInVeh)
# assuming nonhousehold members don't exsit in the survey
shareTNC$share<-ifelse(shareTNC$totPopInVeh==1, "sov",
                       ifelse(shareTNC$HH_ONTD==1 & shareTNC$NONHHCNT>0, "sov+other","other")) 
# 
# shareTNC_family<-shareTNC[shareTNC$share=="other"]
# write.csv(shareTNC_family,"shareTNC_family.csv")
# 
# shareTNC_group<-shareTNC_family %>%
#   group_by(HOUSEID) %>%
#   summarise(count=n(), sumtrip=sum(as.numeric(HH_ONTD))/2)
# shareTNC_group$matched <-ifelse(shareTNC_group$count==shareTNC_group$sumtrip,1,0)
# 
# ##Family_matched
# shareTNC_match<-shareTNC_group[shareTNC_group$matched==1,] %>%
#   merge(shareTNC_family, all.x = TRUE, by="HOUSEID")
# ##Family_unmatched
# shareTNC_unmmatch<-read.csv(file="/Users/wuxiatian/Downloads/0_Research/0 CEE Thesis/shareTNC_unmatch.csv",header=TRUE)
# 
# ### Rbind all data
# shareTNC_family<-rbind(shareTNC_match, shareTNC_unmmatch[,names(shareTNC_match)])
shareTNC_family<-read.csv(file="/Users/wuxiatian/Downloads/0_Research/0 CEE Thesis/shareTNC_family.csv",header=TRUE)
shareTNC_unfamily<-shareTNC[shareTNC$share!="other"]
shareTNC_unfamily$TripCount<-1

shareTNC<-rbind(shareTNC_family[,names(shareTNC_unfamily)],shareTNC_unfamily)


##### Shared trip & VMT
shareTNC$avgTRPMILES<-ifelse(shareTNC$HH_ONTD>=0, shareTNC$TRPMILES/as.numeric(shareTNC$HH_ONTD),NULL)
shareTNC$totPopInVehCate<-ifelse(shareTNC$totPopInVeh==1,"sov",
                               ifelse(shareTNC$totPopInVeh>1,"hov","-1"))
VMTNC<-shareTNC[shareTNC$avgTRPMILES>=0 & shareTNC$TRPMILES<=500 & shareTNC$totPopInVehCate!="-1"] %>%
  mutate(VMT=avgTRPMILES*WTPERFIN) %>%
  group_by(totPopInVehCate) %>%
  summarise(sum_VMT=sum(VMT),sum_trip=sum(TripCount)) %>%
  mutate(perc_VMT = round((sum_VMT / sum(sum_VMT)*100),1), perc_trip = round((sum_trip / sum(sum_trip)*100),1))





```

# TNC Drivers 
## Original Trip Purpose
```{r}
###########################################################################
## Original Trip Purpose
###########################################################################

tnc_driver<-mpos4_per[share_work_drive_tnc==1,]
trip_tnc_driver<-mpos4_trip %>%
  merge(tnc_driver[,c("person_id")], by="person_id", all.y = T)

library("dplyr")

################### Link each O_MODE_D ####
trip_tnc_driver<-trip_tnc_driver %>%
  mutate(o_d_raw=paste0(o_purpose_imputed,sep = "_",d_purpose_imputed,collapse = NULL)) %>%
  mutate(o_mode_d_raw=paste0(o_purpose_imputed,sep = "_",mode_recode,sep = "_",d_purpose_imputed,collapse = NULL)) %>%
  mutate(o_mode_raw=paste0(o_purpose_imputed,sep = "_",mode_recode,sep = "_",collapse = NULL)) %>%
  mutate(mode_d_raw=paste0(mode_recode,sep = "_",d_purpose_imputed,sep = "_",collapse = NULL)) %>%
  # mutate(mode_d_raw=paste0(mode_recode,sep = "_",d_purpose_imputed,collapse = NULL)) %>% 
  mutate(mode_d_nextmode_raw= paste0(mode_d,sep = "_",lead(mode_recode),collapse = NULL)) %>% 
  mutate(priormode_o_mode_raw= paste0(lag(mode_recode),sep = "_",o_purpose_imputed,sep = "_",mode_recode,collapse = NULL))

```

## New Trip Chain
```{r, Create new daily mode choice chaining, with Original }
###########################################################################
## Trip Chain
###########################################################################

# # get last d
# last_d<-trip_tnc_driver %>%
#  arrange(region, hh_id, person_id, day_num,trip_num) %>%
#  group_by(person_id, day_num) %>%
#  summarise_all(last)%>%
#  mutate(last_d=1)
# 
# 
# ### get trip chain O_mode_D ###
# trip_tnc_driver<-trip_tnc_driver%>%
#   merge(last_d[,c("person_id","day_num","trip_num","last_d")],by =c("person_id","day_num","trip_num"), all.x = TRUE)
# trip_tnc_driver$last_d[is.na(trip_tnc_driver$last_d)] <- 0
# trip_tnc_driver$o_mode<-ifelse(trip_tnc_driver$last_d==1, trip_tnc_driver$o_mode_d,trip_tnc_driver$o_mode)
# 
# driver_trip_chain_o_m_d<-trip_tnc_driver%>%
#   group_by(person_id,day_num) %>%
#   summarise(o_mode_d=paste(o_mode,collapse = ""),numtrip = n()) %>%
#   merge(trip_tnc_driver[,c("region","person_id","day_num","trip_num","place_num","o_mode_d_raw")], by=c("person_id","day_num"),all.y = T)
# 
# write.csv(driver_trip_chain_o_m_d,file="MPOS4_TNCdriver_trip_chain_o_m_d.csv",row.names=FALSE, na="")

```

## Identify TNC driver trips
```{r, identify TNC driver trips }

library(stringr)

driver_trip_chain_o_m_d<-setDT(read.csv("MPOS4_TNCdriver_trip_chain_o_m_d.csv",header = T))

# length(unique(driver_trip_chain_o_m_d$person_id))
# summary(driver_trip_chain_o_m_d)
# driver_trip_chain_o_m_d<-na.omit(driver_trip_chain_o_m_d)
# length(unique(driver_trip_chain_o_m_d$person_id))


## number of occurance of Car in a trip chain
driver_trip_chain_o_m_d$numCar <- str_count(driver_trip_chain_o_m_d$o_mode_d, "car")

## number of occurance of TNC in a trip chain
driver_trip_chain_o_m_d$numTNC <- str_count(driver_trip_chain_o_m_d$o_mode_d, "tnc")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "tnc_s")

## number of TNC driving trips 
# work-related
driver_trip_chain_o_m_d$numWork <- str_count(driver_trip_chain_o_m_d$o_mode_d, "car_2_")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_10")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_11")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_12")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_14")
  
# escort
driver_trip_chain_o_m_d$numEscort<-
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_5_")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_42")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_43")+
  str_count(driver_trip_chain_o_m_d$o_mode_d, "car_44")

driver_trip_chain_o_m_d$numWorkEscort<-driver_trip_chain_o_m_d$numWork+driver_trip_chain_o_m_d$numEscort

## time gaps between trips
trip_tnc_driver<-trip_tnc_driver[, timediff := (depart_time_decimal - shift(arrive_time_decimal))*60, by = c("person_id", "day_num")]


trip_tnc_driver$timediff<-ifelse(trip_tnc_driver$timediff< 0, trip_tnc_driver$timediff+24*60, trip_tnc_driver$timediff)

driver_trip_chain_o_m_d$person_id<-as.character(driver_trip_chain_o_m_d$person_id)

final<- merge(trip_tnc_driver[,.(person_id, day_num,trip_num, depart_time_decimal,arrive_time_decimal,duration_imputed,timediff,distance)], driver_trip_chain_o_m_d, by = c("person_id", "day_num","trip_num"), all.x = T) %>%
  subset(numWorkEscort>0)


## 184 drivers with potential TNC 192 driving day, 6090 potential trips
length(unique(final$person_id))
length(unique((unlist(final[,.(person_id,day_num)]))))

## link with employment & SACOG finding
SACOG_finding<-setDT(read.csv("TNC_driving_trip_chain.csv",header = T))
SACOG_finding$place_num<-SACOG_finding$place_num-1
SACOG_finding$person_id<-as.character(SACOG_finding$person_id)

output<-final%>%
  merge(mpos4_per[,.(person_id,employment,job_type,num_jobs)],by="person_id",all.x = T)%>%
  merge(SACOG_finding[,.(person_id,day_num,place_num,TNCdrivingday,TNCdrivingtrip, TNCphase0,TNCphase1, TNCphase4,TNC_restinbetween,WorkHour)], by = c("person_id","day_num","place_num"), all.x=T) %>%
  arrange(desc(numWorkEscort))


# write.csv(output,"MPOS4_TNC_driving_trip_chain.csv", na= "",row.names = F)

# b<-mpos4_trip_driver_TNC[,.(person_id, day_num,o_mode_d.x,depart_time_decimal,arrive_time_decimal,duration_imputed,timediff,distance,o_mode_d.y,numWorkEscort)]%>%
#   arrange(desc(numWorkEscort))%>%
#   subset(timediff==0)
# 
# length(unique(b$person_id))
# length(unique((unlist(b[,.(person_id,day_num)]))))
# 
# numTNC_transit<-driver_trip_chain_o_m_d %>%
#   summarise(totalTNC_transit=round(sum(numTNC_transit*WEIGHT_TRIP),2))
# 
# 
# driver_trip_chain<-read.csv("TNC_driving_trip_chain.csv",header = T)
# driver_trip_chain$person_id<-as.character(driver_trip_chain$person_id)
# driver_trip_chain<-merge(driver_trip_chain,mpos4_per[,c("person_id","employment")])
# unique<-distinct(driver_trip_chain[,c("person_id","employment")])


```
## TNC driver employment
```{r, employment status}
library(ggplot2)

mpos4_per$employment<-dplyr::recode(mpos4_per$employment,  `8` = 3L,`9` = 3L)
mpos4_per$job_type<-dplyr::recode(mpos4_per$job_type,  `0` = 995L)

driver_employ<-driver_trip_chain_o_m_d %>%
  distinct(person_id) %>%
  merge(mpos4_per[,c("person_id","employment","job_type","num_jobs")], by ="person_id")
driver_employ$job_type<-dplyr::recode(driver_employ$job_type,  `-9998` = 995L)

# table(driver_employ$employment)

employ0<-driver_employ %>%
  group_by(employment) %>%
  summarise(n=n()) %>%
  mutate(perc=round(n/sum(nrow(driver_employ))*100,2))

employ<-driver_employ %>%
  group_by(employment,job_type) %>%
  summarise(n=n()) %>%
  mutate(perc=round(n/sum(nrow(driver_employ))*100,2))


tnc_driver_employment<-ggplot(employ, aes(x = as.factor(employment), y=perc,fill=as.factor(job_type)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 45)+

  scale_x_discrete(limits=c(c("1","2","3","6","7")),
    labels=c("Employed full-time\n(paid)(n=135|58%)","Employed part-time\n (paid)(n=21|9%)"," Self-employed\n(n=42|18%)","Not employed\n(n=33|14%)","Volunteer/intern\n(unpaid)(n=1|1%)"))+
  geom_text(aes(label=round(perc,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs( y="Percentage (%)") +
  scale_fill_discrete(name = "Job Type", labels = c("Only one work location (outside of home, may also telework)", "Work location regularly varies (different offices/jobsites)","Work at home ONLY (telework, self-employed)","Drive/travel for work (driver, sales)", "N/A"))+
  ggtitle("Employment status & job type of TNC drivers") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 11), 
    axis.text.y=element_text(colour="black", size = 14),
    axis.title.x=element_blank(),
    axis.title.y=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 11),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("tnc_driver_employment.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 4,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)



### number of jobs on average

driver_employ<-driver_trip_chain_o_m_d %>%
  distinct(person_id) %>%
  merge(mpos4_per[,c("person_id","employment","job_type","num_jobs")], by ="person_id")
driver_employ$num_jobs<-dplyr::recode(driver_employ$num_jobs,  `995` = 0L)
table(driver_employ$num_jobs)
employ0<-driver_employ[driver_employ$num_jobs>=0,] %>%
  group_by(num_jobs) %>%
  summarise(n=n()) %>%
  mutate(perc=n/sum(n))

employ<-driver_employ[driver_employ$num_jobs>=0,] %>%
  group_by(employment) %>%
  summarise(n=mean(num_jobs))


tnc_driver_numjob<-ggplot(employ, aes(x = as.factor(employment), y=n))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  ylim(0, 2)+

  scale_x_discrete(limits=c(c("1","2","3","6","7")),
    labels=c("Employed full-time\n(paid)(n=135|58%)","Employed part-time\n (paid)(n=21|9%)"," Self-employed\n(n=42|18%)","Not employed\n(n=33|14%)","Volunteer/intern\n(unpaid)(n=1|1%)"))+
  geom_text(aes(label=round(n,1)), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs( y="Number of jobs") +
  # scale_fill_discrete(name = "Job Type", labels = c("N/A","Only one work location (outside of home, may also telework)", "Work location regularly varies (different offices/jobsites)","Work at home ONLY (telework, self-employed)","Drive/travel for work (driver, sales)"))+
  ggtitle("Employment status & number of jobs of TNC drivers") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 11), 
    axis.text.y=element_text(colour="black", size = 14),
    axis.title.x=element_blank(),
    axis.title.y=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 11),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))
  
ggsave("tnc_driver_numjob.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 8,
  height = 2,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

```

```{r, calculate work hour }
library(ggplot2)
driver<-read.csv("MPOS4_TNC_driving_trip_chain.csv",colClasses = c('person_id'='character'),header = T)
driver[is.na(driver)] <- 0
work_hour<-driver %>%
  group_by(person_id,day_num, region) %>%
  summarise(hour=sum(WorkHour)) 

work_hour_avg<-work_hour%>%
  group_by(person_id,region) %>%
  summarise(avghour=mean(hour))

work_hour_avg$avghour[is.na(work_hour_avg$avghour)]<-0
work_hour_avg$weekhour<-work_hour_avg$avghour*7

# observed TNC driver
driver_observed<- work_hour_avg %>% subset(weekhour>0) %>% select(person_id) %>% distinct()
driver_observed_region<- work_hour_avg %>% subset(weekhour>0) %>% group_by(region) %>% summarise(n=n())
driver_observed_region<- work_hour_avg %>% subset(weekhour>0) %>% select(person_id,region) %>% distinct()%>% group_by(region) %>% summarise(n=n())

# observed TNC driving trips
work_trip<-driver %>%
  merge(driver_observed, by="person_id") %>%
  subset(TNCdrivingtrip==1) %>%
  group_by(region) %>%
  summarise(n=n()) 

# observed TNC driving day
work_day<-driver %>%
  merge(driver_observed, by="person_id")%>%
  subset(TNCdrivingtrip==1) %>%
  group_by(person_id,day_num, region) %>%
  summarise(n=n()) %>%
  mutate(count=1) %>%
  group_by(region) %>%
  summarise(n=n())

work_day<-driver %>%
  merge(driver_observed, by="person_id")%>%
  subset(TNCdrivingtrip==1) %>%
  group_by(person_id,day_num, region) %>%
  summarise(n=n()) %>%
  group_by(region) %>%
  summarise(n=n())

# unobserved TNC trips
# nrow(work_hour_avg[work_hour_avg$avghour==0,])/nrow(work_hour_avg)

# average working hour by region
work_hour_avg_region<-driver %>%
  merge(driver_observed, by="person_id") %>%
  subset(WorkHour>0) %>%
  group_by(region) %>%
  summarise(hour=mean(WorkHour)) 
# mean(work_hour_avg$avghour[work_hour_avg$avghour!=0])


# Deadheading 
# phase 0
phase0_duration_region<-driver %>%
  subset(TNCphase0==1) %>%
  group_by(region) %>%
  summarise(hour=mean(duration_imputed)) 

phase0_distance_region<-driver %>%
  subset(TNCphase0==1) %>%
  # group_by(region) %>%
  summarise(hour=mean(distance)) 

# mean(driver[driver$TNCphase0==1,]$duration_imputed)
# mean(driver[driver$TNCphase0==1,]$distance)

# phase 4
phase4_duration_region<-driver %>%
  subset(TNCphase4==1) %>%
  group_by(region) %>%
  summarise(hour=mean(duration_imputed)) 

phase4_distance_region<-driver %>%
  subset(TNCphase4==1) %>%
  group_by(region) %>%
  summarise(hour=mean(distance)) 
# mean(driver[driver$TNCphase4==1,]$duration_imputed)
# mean(driver[driver$TNCphase4==1,]$distance)

# phase 0 | 4
# mean(driver[driver$TNCphase4==1 | driver$TNCphase0==1,]$duration_imputed)
# mean(driver[driver$TNCphase4==1 | driver$TNCphase0==1,]$distance)


#### TNC driver work schedule ####
work_hour_avg$schedule<-ifelse(work_hour_avg$weekhour==0, "Unobserved",
  ifelse(work_hour_avg$weekhour<10, "Occasional",
                               ifelse(work_hour_avg$weekhour>=10 & work_hour_avg$weekhour<35, "Frequent",
                                      ifelse(work_hour_avg$weekhour>=35, "Frequent","-1"))))

work_hour_avg_all<-merge(work_hour_avg[,-c(2)],mpos4_per[share_work_drive_tnc==1,c("person_id","region")], by= c("person_id") ,all.y = T)

work_hour_avg_all$schedule[is.na(work_hour_avg_all$schedule)]<-"Unobserved"

driver_schedule_region<-work_hour_avg_all %>%
  group_by(region, schedule) %>%
  summarise(n=n())

driver_schedule_region$schedule <- factor(driver_schedule_region$schedule, levels=c("Unobserved","Occasional","Frequent"))

tnc_driver_schedule<-ggplot(driver_schedule_region, aes(x = region, y=n,fill=as.factor(schedule)))+ 
   geom_bar(stat="identity",colour="black", size=.2, alpha=1
             ,width=0.6, position = position_dodge(width=0.7)) +
  geom_text(aes(label=n), position = position_dodge(width = 0.7), vjust=-0.2) +
  labs( y="Number of drivers") +
  scale_x_discrete(limits=c(c("MTC/SFCTA","SACOG","SANDAG","SCAG")),
    labels=c("MTC/SFCTA\n(n=79)","SACOG\n(n=69)","SANDAG\n(n=44)","SCAG\n(n=42)" ))+
  scale_fill_manual(name = "TNC Work Schedule",labels = c("No TNC driving trips identified","Occasional (working hour is less than 10h/week)","Frequent (working hour is 10-35h/week)"), values = c("#a6bddb","#2b8cbe", "#1A476F")) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
    axis.text.x=element_text(colour="black", size = 11), 
    axis.text.y=element_text(colour="black", size = 14),
    axis.title.x=element_blank(),
    axis.title.y=element_text(colour="black", size = 14),
    legend.key=element_rect(fill="white", colour="white"),
    legend.position="bottom", legend.direction="vertical", 
    legend.title = element_blank(),
    legend.text = element_text(colour="black", size = 11),
    # panel.grid.major = element_line(colour = "#d3d3d3"), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    plot.title = element_text(size = 14, face = "bold")) +
  guides(fill = guide_legend(reverse=F))

ggsave("tnc_driver_schedule.png",path = "/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/Image_Output",
  scale = 1,
  width = 6,
  height = 5,
  # units = c("in", "cm", "mm"),
  dpi = 300,
  limitsize = TRUE
)

# ggplot(work_hour_avg, aes(x = avghour))+ 
#    geom_histogram(position="identity", alpha=0.5)+
#   geom_density()+
#   geom_vline(data=mu, aes(xintercept=vmtdiff, color=as.factor(income)),
#              linetype="dashed",size=0.4)+
#   # ylim(0, 150)+
#   # scale_fill_brewer()+
#   labs(x="Weekly VMT difference by income group (n=556) ", y="Density") +
#   scale_color_discrete(name = "Income level",labels= c("Low","Medium","High"))+
#   # ggtitle("Composition of Exports to China ($)") + 
#   # scale_fill_manual(values=fill) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 14), 
#     axis.text.y=element_text(colour="black", size = 14),
#     axis.title=element_text(colour="black", size = 16),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="right", legend.direction="vertical", 
#     legend.title =element_text(colour="black", size = 14),
#     legend.text = element_text(colour="black", size = 12),
#     # panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     # plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     # text=element_text(family="Times")) +
#         plot.title = element_text(size = 14, face = "bold")) +
#   guides(fill = guide_legend(reverse=F))



```






```{r,Daily Distribution--Kernel Density}
###########################################################################
##  Daily Distribution--Kernel Density
###########################################################################
### transfer DATE--TIME format ###
## year-month
# mpos4_trip$TDAYyear <-str_sub(mpos4_trip$TDAYDATE,1,4)
# mpos4_trip$TDAYmonth<- str_sub(mpos4_trip$TDAYDATE,-2,-1)
# mpos4_trip$TDAYym<-paste0 (mpos4_trip$TDAYyear,sep = "-", mpos4_trip$TDAYmonth,collapse = NULL)
# mpos4_trip$TDAYym_final<-as.yearmon(mpos4_trip$TDAYym,"%Y-%m")
## hour-min
trip01<-nhts01$data$trip
trip09<-nhts09$data$trip
mpos4_trip<-nhts17$data$trip


#### time format
# trip01$TIMEhhs <- substr(trip01$STRTTIME,1,nchar(trip01$STRTTIME)-2)
# trip01$TIMEmms<-str_sub(trip01$STRTTIME,-2,-1)
# trip01$TIMEhhmms<-paste0 (trip01$TIMEhhs,sep = ":", trip01$TIMEmms,collapse = NULL)
# 
# trip09$TIMEhhs <- substr(trip09$STRTTIME,1,nchar(trip09$STRTTIME)-2)
# trip09$TIMEmms<-str_sub(trip09$STRTTIME,-2,-1)
# trip09$TIMEhhmms<-paste0 (trip09$TIMEhhs,sep = ":", trip09$TIMEmms,collapse = NULL)
# 
# mpos4_trip$TIMEhhs <- substr(mpos4_trip$STRTTIME,1,nchar(mpos4_trip$STRTTIME)-2)
# mpos4_trip$TIMEmms<-str_sub(mpos4_trip$STRTTIME,-2,-1)
# mpos4_trip$TIMEhhmms<-paste0 (mpos4_trip$TIMEhhs,sep = ":", mpos4_trip$TIMEmms,collapse = NULL)

trip01$TIMEhhs <- substr(trip01$STRTTIME,1,nchar(trip01$STRTTIME)-2)
trip01$TIMEmms<-round_any(as.numeric(str_sub(trip01$STRTTIME,-2,-1)),30,f=ceiling)
table(trip01$TIMEmms)
trip01$TIMEhhmms<-paste0 (trip01$TIMEhhs,sep = ":", trip01$TIMEmms,collapse = NULL)

trip09$TIMEhhs <- substr(trip09$STRTTIME,1,nchar(trip09$STRTTIME)-2)
trip09$TIMEmms<-round_any(as.numeric(str_sub(trip09$STRTTIME,-2,-1)),30,f=ceiling)
trip09$TIMEhhmms<-paste0 (trip09$TIMEhhs,sep = ":", trip09$TIMEmms,collapse = NULL)

mpos4_trip$TIMEhhs <- substr(mpos4_trip$STRTTIME,1,nchar(mpos4_trip$STRTTIME)-2)
mpos4_trip$TIMEmms<-round_any(as.numeric(str_sub(mpos4_trip$STRTTIME,-2,-1)),30,f=ceiling)
mpos4_trip$TIMEhhmms<-paste0 (mpos4_trip$TIMEhhs,sep = ":", mpos4_trip$TIMEmms,collapse = NULL)
mpos4_trip$TIMEhhmms_final<- strptime(x = mpos4_trip$TIMEhhmms, format = "%H:%M")

Taxitrip01<-trip01%>%
  subset(TRPTRANS=="22") %>%
  merge(data.frame(nhts01$weights$person[,1:3]),by=c("HOUSEID","PERSONID")) 
 
Taxitrip09<-trip09%>%
  subset(TRPTRANS=="19") %>%
  merge(data.frame(nhts09$weights$person[,1:3]),by=c("HOUSEID","PERSONID"))

TNCtrip<-mpos4_trip %>%
  subset(TRPTRANS=="17") %>%
  merge(data.frame(nhts17_weights_person[,1:3]),by=c("HOUSEID","PERSONID"))

# Taxitrip01$TIMEhhs<-factor(as.numeric(Taxitrip01$TIMEhhs),levels=c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23"))
# Taxitrip09$TIMEhhs<-factor(as.numeric(Taxitrip09$TIMEhhs),levels=c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23"))
# TNCtrip$TIMEhhs<-factor(as.numeric(TNCtrip$TIMEhhs),levels=c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23"))


Taxitrip01_pop<-Taxitrip01 %>%
  filter(!is.na(Taxitrip01$TIMEhhmms)) %>%
  group_by(TIMEhhmms)%>%
  summarise(Frequency = sum(WEIGHT_HH)*365) %>%
  mutate(Percent = Frequency / sum(Frequency)) %>%
  mutate(Year='2001')
# sum(Taxitrip01_pop$Percent[c(8:10, 16:18)])  ## rush hour
 # 29.38771%

Taxitrip09_pop<-Taxitrip09 %>%
  filter(!is.na(Taxitrip09$TIMEhhmms)) %>%
  group_by(TIMEhhmms)%>%
  summarise(Frequency = sum(WEIGHT_HH)*365) %>%
  mutate(Percent = Frequency / sum(Frequency)) %>%
  mutate(Year='2009')
# sum(Taxitrip09_pop$Percent[c(8:10, 16:18)])  ## rush hour
# 27.41385%

TNCtrip_pop<-TNCtrip%>%
  filter(!is.na(TNCtrip$TIMEhhmms)) %>%
  group_by(TIMEhhmms)%>%
  summarise(Frequency = sum(WEIGHT_HH)*365) %>%
  mutate(Percent = Frequency / sum(Frequency)) %>%
  mutate(Year='2017')
# sum(TNCtrip_pop$Percent[c(8:10, 16:18)])
# define peak hour: 8-10 am & 16-18 pm
# 33.93% are concentrated in peak hour 

all<-rbind(Taxitrip01_pop,Taxitrip09_pop,TNCtrip_pop)
all<-all[all$TIMEhhmms!=":-9",]
all$time<- as.POSIXct(all$TIMEhhmms, format= "%H:%M")

## kernel density 
ggplot(all, aes(x=time))+
  geom_density(aes(y=..density..,fill=Year),alpha=0.5,stat="density",position="identity",col=NA)+
  scale_x_datetime(date_labels = "%H", breaks="1 hour")+
  labs(x="Time of the day")+
  labs(y="Density")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))


## bar chart
ggplot(data=all, aes(x=time, y=Frequency/1000000, fill=Year))+
  geom_density(stat = "identity",alpha = 0.5,col=NA)+
  labs(x="Time of the day")+
  labs(y="Annual Trips (million)")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))

ggplot(data=all, aes(x=time, y=Frequency/1000000, fill=Year))+
  geom_density(stat = "identity",position='dodge')+
  geom_line(aes(y=density))
  # scale_fill_grey(start=0.7, end=0)+
  labs(x="Time of the day")+
  labs(y="Annual Trips (million)")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))


```

```{r, TNC trip mileage}
###########################################################################
##  TNC trip mileage
###########################################################################

TNC_mile17<-nhts17$data$trip %>%
  subset(TRPTRANS=="17" & TRPMILES>0 ) %>%
  merge(data.frame(nhts17_weights_person[,1:3]),by=c("HOUSEID","PERSONID"))

######eleminating outliers
high17<-quantile(TNC_mile17$TRPMILES,0.75)+1.5*IQR(TNC_mile17$TRPMILES)
low17<-quantile(TNC_mile17$TRPMILES,0.75)-1.5*IQR(TNC_mile17$TRPMILES)
# 
TNC_mile17<-subset(TNC_mile17,TRPMILES< 100)

### Average Distance 
summary(TNC_mile01$TRPMILES)
summary(TNC_mile09$TRPMILES)
summary(TNC_mile17$TRPMILES)
boxplot(TNC_mile09$TRPMILES)


TNC_mile17$mile[(TNC_mile17$TRPMILES>0 & TNC_mile17$TRPMILES<=1 )] <- "0-1"
TNC_mile17$mile[(TNC_mile17$TRPMILES>1 & TNC_mile17$TRPMILES<=2 )] <- "1-2"
TNC_mile17$mile[(TNC_mile17$TRPMILES>2 & TNC_mile17$TRPMILES<=3 )] <- "2-3"
TNC_mile17$mile[(TNC_mile17$TRPMILES>3 & TNC_mile17$TRPMILES<=4 )] <- "3-4"
TNC_mile17$mile[(TNC_mile17$TRPMILES>4 & TNC_mile17$TRPMILES<=5 )] <- "4-5"
TNC_mile17$mile[(TNC_mile17$TRPMILES>5 & TNC_mile17$TRPMILES<=10)] <- "5-10"
TNC_mile17$mile[(TNC_mile17$TRPMILES>10 )] <- ">10"

TNC_mile17$year<-"2017"


all<-rbind(TNC_mile17,TNC_mile09,TNC_mile01, fill=TRUE)

mile_distribution<-all %>%
  group_by(mile, year)%>%
  summarise(count= sum(WEIGHT_HH))%>%
  mutate(Percent = count / sum(count))

mile_distribution1<-mile_distribution%>%
  group_by(year)%>%
  mutate(Percent = count / sum(count))
# mile_low<-quantile(TNCtrip$TRPMILES,0.25)-1.5*IQR(TNCtrip$TRPMILES)
# mile_high<-quantile(TNCtrip$TRPMILES,0.75)+1.5*IQR(TNCtrip$TRPMILES)

ggplot(data=mile_distribution1, aes(x=mile, y=count/1000000, fill=year))+
  geom_bar(stat = "identity",position='dodge')+
  scale_x_discrete(limits = c("0-1","1-2","2-3","3-4","5-10",">10"))+
  scale_fill_grey(start=0.7, end=0)+
  labs(x="Taxi/TNC Trip Distance(mile)")+
  labs(y="Weighted Frequency (million)")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))

ggplot(data=mile_distribution1, aes(x=mile, y=Percent, fill=year))+
  geom_bar(stat = "identity",position='dodge')+
  scale_y_continuous(labels = scales::percent)+
  scale_x_discrete(limits = c("0-1","1-2","2-3","3-4","5-10",">10"))+
  scale_fill_grey(start=0.7, end=0)+
  labs(x="Taxi/TNC Trip Distance(mile)")+
  labs(y="Weighted Percentage")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))

```






# Identify Supersharer 


```{r,Supersharer--combination of serveral shared mode in last month}
###########################################################################
## Supersharer--combination of serveral shared mode in last month
###########################################################################
share<-person17[,c("HOUSEID","PERSONID","CARSHARE","BIKESHARE","RIDESHARE")]
supersharer<-share%>%
  subset(CARSHARE>=1 & BIKESHARE>=1 & CARSHARE>=1 & RIDESHARE>=1 & BIKESHARE>=1) %>%
  mutate(sumshare=CARSHARE + BIKESHARE + RIDESHARE) %>%
  merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID"))


  
sum(supersharer$WEIGHT_HH)/301599169 #0.001228655

supersharer$frequency[( supersharer$sumshare>0 & supersharer$sumshare<=5)] <- "2-5/m"
supersharer$frequency[( supersharer$sumshare>5 & supersharer$sumshare<=7)] <- "6-7/m"
supersharer$frequency[(supersharer$sumshare> 7 & supersharer$sumshare<=14)] <- "1-2/w"
supersharer$frequency[(supersharer$sumshare> 14 & supersharer$sumshare<=21)] <- "2-3/w"
supersharer$frequency[(supersharer$sumshare> 21 & supersharer$sumshare<=28)] <- "3-4/w"
supersharer$frequency[(supersharer$sumshare> 28 & supersharer$sumshare<=35)] <- "4-5/w"
supersharer$frequency[supersharer$sumshare> 35 ] <- ">5/w"

frequency<-supersharer %>%
  group_by(frequency)%>%
  summarise(count= sum(WEIGHT_HH))
sum(frequency$count)

# sum(frequency_distribution$count)/ sum(frequency$count)
ggplot(data=frequency, aes(x=frequency, y=count/1000))+
  geom_bar(stat = "identity")+
  geom_text(aes(label=round(count/1000,2)), vjust=-0.5)+
  scale_x_discrete(limits = c("2-5/m","6-7/m","1-2/w","2-3/w","3-4/w","4-5/w",">5/w"))+
  labs(x=" Trip Frequency by Non-transit Shared Modes")+
  labs(y="Weighted Population (thousand)")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))


### distribution of types of shared modes +PT
share1<-person17[,c("HOUSEID","PERSONID","HH_CBSA","CARSHARE","BIKESHARE","RIDESHARE","PTUSED")]

supersharer1<-share1%>%
  subset(RIDESHARE>=0  & (CARSHARE>=0 |  BIKESHARE>=0 | PTUSED>=0)) %>%
  merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
  mutate(transit=PTUSED*WEIGHT_HH*12, carshare=CARSHARE*WEIGHT_HH*12, rideshare=RIDESHARE*WEIGHT_HH*12, bikeshare=BIKESHARE*WEIGHT_HH*12) 

# supersharer1<-share1%>%
#   subset(RIDESHARE>0  & HH_CBSA== 40900 & (CARSHARE>0 |  BIKESHARE>0 | PTUSED>0)) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop1=sum(supersharer1$WEIGHT_HH) # 81655.26/267225.6= 0.3055668
# 
# supersharer2<-share1%>%
#   subset(HH_CBSA== 40900 & (CARSHARE>0 |  BIKESHARE>0 | PTUSED>0)) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop2=sum(supersharer2$WEIGHT_HH) # 347551.5/2615136 =0.1329
# 
# 
# supersharer3<-share1%>%
#   subset(HH_CBSA== 40900) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop3=sum(supersharer3$WEIGHT_HH) #2615136
# 
# supersharer4<-share1%>%
#   subset(HH_CBSA== 40900 & RIDESHARE>0 ) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop4=sum(supersharer4$WEIGHT_HH) #267225.6


# supersharer1<-share1%>%
#   subset(RIDESHARE>0  & HH_CBSA== 40900 & (PTUSED>0)) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop1=sum(supersharer1$WEIGHT_HH) # 78857.34/267225.6= 0.2950965
# 
# supersharer2<-share1%>%
#   subset(HH_CBSA== 40900 & (PTUSED>0)) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop2=sum(supersharer2$WEIGHT_HH) # 327145.7/2615136 =0.125





# supersharer3<-share1%>%
#   subset(HH_CBSA== 40900) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop3=sum(supersharer3$WEIGHT_HH) #2615136
# 
# supersharer4<-share1%>%
#   subset(HH_CBSA== 40900 & RIDESHARE>0 ) %>%
#   merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
#   mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 
# 
# tncpop4=sum(supersharer4$WEIGHT_HH) #267225.6



supersharer1<-share1%>%
  subset(RIDESHARE>=4  & HH_CBSA== 40900 & (PTUSED>0)) %>%
  merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
  mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 

tncpop1=sum(supersharer1$WEIGHT_HH) # 40102.69 /92180.67= 0.4350445

supersharer2<-share1%>%
  subset(HH_CBSA== 40900 & (PTUSED>0)) %>%
  merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
  mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 

tncpop2=sum(supersharer2$WEIGHT_HH) # 327145.7/2615136 =0.125

supersharer3<-share1 %>%
  subset(HH_CBSA== 40900) %>%
  merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
  mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 

tncpop3=sum(supersharer3$WEIGHT_HH) #2615136

supersharer4<-share1%>%
  subset(HH_CBSA== 40900 & RIDESHARE>=4 ) %>%
  merge((as.data.frame(nhts17_weights_person[,1:3])),by=c("HOUSEID","PERSONID")) %>%
  mutate(transit=PTUSED*WEIGHT_HH, carshare=CARSHARE*WEIGHT_HH, rideshare=RIDESHARE*WEIGHT_HH, bikeshare=BIKESHARE*WEIGHT_HH) 

tncpop4=sum(supersharer4$WEIGHT_HH) #92180.67

colsum<-as.data.frame(colSums(supersharer1[,8:11]))
colsum$mode<-c("transit","carshare","rideshare","bikeshare")
colnames(colsum)<-c("count","mode")
colsum$perc<-colsum %>%
  mutate(perc = count / sum(count))

ggplot(data=colsum, aes(x=reorder(mode,-count), y=count*12/1000000000))+
  geom_bar(stat = "identity")+
  geom_text(aes(label=round(count*12/1000000000,2)), vjust=-0.5)+
  labs(x=" Trip Frequency by Shared Modes")+
  labs(y="Weighted Annual Trip in US (billion)")+
  theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))

# ggplot(data=colsum, aes(x=reorder(mode,-perc.perc), y=perc.perc))+
#   geom_bar(stat = "identity")+
#   # geom_text(aes(x =reorder(mode, -perc.perc), y = perc.perc, label = round(perc.perc*100,2)), position = position_dodge(width = 1),vjust = -0.5, size = 3)+
#   # scale_y_continuous(labels = scales::percent)+
#   labs(x=" Trip Frequency by Shared Modes")+
#   labs(y="Weighted Annual Trip in US")+
#   theme(text = element_text(family="Times", face="bold", size=15,vjust = 0.5))



```

# Mapping
## TNC trips
```{r}
#### Distinguish TNC pool/non-pool trips ####

tnc_trip<-mpos4_trip %>%
  filter(str_detect(mode_recode, "tnc") | is_tnc_trip_new==1) %>%
  mutate (pool=ifelse(str_detect(mode_recode, "tnc_s")| mode_uber== 1 | mode_lyft==1,1,0))

tnc_trip$o_bg_geo_id<-ifelse(tnc_trip$region=="SACOG",tnc_trip$BG10ID_O,tnc_trip$o_bg_geo_id)
tnc_trip$d_bg_geo_id<-ifelse(tnc_trip$region=="SACOG",tnc_trip$BG10ID_D,tnc_trip$d_bg_geo_id)

CA_bg_census<-setDT(read.csv("/Users/wuxiatian/Box/Clean Mile Standard/DataAnalysis/R_input/BE_Variables/CA_bg_census.csv",header=TRUE))


tnc_trip_o_bg<-tnc_trip %>% 
  group_by(region,o_bg_geo_id) %>%
  summarise(trip_count=sum(WEIGHT_TRIP)) 

tnc_trip_o_bg$o_bg_geo_id<-as.numeric(tnc_trip_o_bg$o_bg_geo_id)
tnc_trip_o_bg<-tnc_trip_o_bg %>% 
  merge(CA_bg_census,by.x="o_bg_geo_id",by.y = "GEOID", all.y = T)

# tnc_trip_o_bg$o_bg_geo_id<-paste0("0",as.numeric(tnc_trip_o_bg$o_bg_geo_id))

tnc_trip_d_bg<-tnc_trip %>% 
  group_by(region,d_bg_geo_id) %>%
  summarise(trip_count=sum(WEIGHT_TRIP)) 

tnc_trip_d_bg$d_bg_geo_id<-as.numeric(tnc_trip_d_bg$d_bg_geo_id)
tnc_trip_d_bg<-tnc_trip_d_bg %>% 
  merge(CA_bg_census,by.x="d_bg_geo_id",by.y = "GEOID", all.y = T)

# tnc_trip_d_bg$d_bg_geo_id<-paste0("0",as.numeric(tnc_trip_d_bg$o_bg_geo_id))



write.csv(tnc_trip_o_bg,"tnc_trip_o_bg.csv",row.names = F)
write.csv(tnc_trip_d_bg,"tnc_trip_d_bg.csv",row.names = F)




tnc_trip$BG10ID_O

tnc_trip$pool[is.na(tnc_trip$pool)]<-0
daily_tnc<- tnc_trip %>%
  group_by(pool)%>%
  summarize(daily_tnc=sum(WEIGHT_TRIP))
```

```{r}
tnc_m
```




```{r, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE, results=FALSE}

library(RColorBrewer)
# View a single RColorBrewer palette by specifying its name
display.brewer.pal(n = 3, name = 'Blues')
# Hexadecimal color specification 
brewer.pal(n = 3, name = "Blues")

```












# Socio-Demographics (copy w weights)
```{r}
# pop_7days<-merge(pop_7days, mpos4_per, by="person_id",all.x=T)
```

## TNC user groups
```{r}
## Based on self-reported monthly frequency
# table(pop_7days$tnc_freq)
# summary(pop_7days$tnc_freq)

pop_7days$tnc_user<-ifelse(pop_7days$tnc_freq==0 |pop_7days$tnc_freq>=8,0,
                           ifelse(pop_7days$tnc_freq==6 | pop_7days$tnc_freq==7,1,2))

# table(pop_7days$tnc_user)

table(pop_7days$made_tnc_trips)

```

## Population
```{r}
pop_7days<-merge(mpos4_per, wktrip_mode_purp,by="person_id",all.y = T)
num<-pop_7days %>%
  mutate(variable=1) %>%
  group_by(tnc_user,variable) %>%
  summarise(n=n(),Count=sum(WEIGHT_PER))%>%
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop")

num_pop<-pop_7days %>%
  mutate(variable=1) %>%
  group_by(variable) %>%
  summarise(n=n(),Count=sum(WEIGHT_PER))%>%
  mutate(Percent = Count/ sum(Count)*100,variable="tnc_pop",tnc_user=3)
num_total<-rbind(num, num_pop)
```

## Race
```{r}
# Race
pop_7days$ethnicity_recode<- ifelse(pop_7days$ethnicity_white==1, 1,
                          ifelse(pop_7days$ethnicity_af_am==1,2,
                                 ifelse(pop_7days$ethnicity_asian==1 | pop_7days$ethnicity_hapi==1, 3,
                          ifelse(pop_7days$ethnicity_hisp==1,4,
                                 ifelse (pop_7days$ethnicity_other==1 | pop_7days$ethnicity_multi==1 | pop_7days$ethnicity_aiak==1,5,-1)))))
pop_7days$ethnicity_recode<-ifelse(pop_7days$region %in% c("SANDAG","MTC/SFCTA","SCAG") & pop_7days$ethnicity_mideast==1, 3,pop_7days$ethnicity_recode)
pop_7days$ethnicity_recode<-ifelse(is.na(pop_7days$ethnicity_recode), -1,pop_7days$ethnicity_recode)


pop_7days$ethnicity_recode<-ifelse(pop_7days$ethnicity_recode==-1 & !is.na(pop_7days$raceeth_imputed),pop_7days$raceeth_imputed,
                                   ifelse(pop_7days$ethnicity_recode==5 & pop_7days$raceeth_imputed %between% c(1,4),pop_7days$raceeth_imputed,pop_7days$ethnicity_recode))
# pop_7days$ethnicity_recode<-ifelse(pop_7days$ethnicity_recode==-1,pop_7days$raceeth_imputed,pop_7days$ethnicity_recode)
a<-pop_7days[,c("ethnicity_recode","raceeth_imputed")]
table(pop_7days$ethnicity_recode)

ethnicity<-pop_7days %>%
  subset(ethnicity_recode>0)%>%
  group_by(tnc_user,ethnicity_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="ethnicity")
ethnicity_pop<-pop_7days %>%
  subset(ethnicity_recode>0)%>%
  group_by(ethnicity_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="ethnicity",tnc_user=3)
ethnicity_total<-rbind(ethnicity,ethnicity_pop)

```

## Age
```{r}
pop_7days$age_final<-ifelse(pop_7days$age<=3,1, #<18
                      ifelse(pop_7days$age>=4 & pop_7days$age<=5,2, # 18-34
                         ifelse(pop_7days$age>=6 &pop_7days$age<=7,3, # 35-54
                        ifelse(pop_7days$age>=8 & pop_7days$age<9,4, # 55-64
                        ifelse(pop_7days$age>=9,5, -1))))) # 65
age<-pop_7days %>%
  group_by(tnc_user,age_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100,variable="age")
age_pop<-pop_7days %>%
  group_by(age_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100,variable="age",tnc_user=3)
age_total<-rbind(age,age_pop)





```

## Gender
```{r}
gender<-pop_7days %>%
  subset(gender_final>0) %>%
  group_by(tnc_user,gender_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="gender")
gender_pop<-pop_7days %>%
  subset(gender_final>0) %>%
  group_by(gender_final) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="gender",tnc_user=3)
gender_total<-rbind(gender, gender_pop)
```
## Education
```{r}
# table(pop_7days$education)
pop_7days$education_recode<-ifelse(pop_7days$education %in% c(1,2),1,
               ifelse(pop_7days$education %in% c(3,4,5),2,
                      ifelse(pop_7days$education %in% c(6),3,
               ifelse( pop_7days$education %in% c(7),4,-1))))
               
education<-pop_7days %>%
  subset(education_recode>0) %>%
  group_by(tnc_user,education_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="education")
education_pop<-pop_7days %>%
  subset(education_recode>0) %>%
  group_by(education_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="education",tnc_user=3)
education_total<-rbind(education, education_pop)
```

## transit pass
## bike ownership
## single/multile housing 
## Home Ownership
```{r}
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","rent_own")],by="hh_id")
# table(pop_7days$rent_own)
# summary(pop_7days$rent_own)
pop_7days$houseown<-ifelse(pop_7days$rent_own==1,1,
                                 ifelse(pop_7days$rent_own==2 |pop_7days$rent_own==3 |pop_7days$rent_own==997,0,-1))
# table(pop_7days$rent_own_final)
```

## HH Income
```{r}
pop_7days$income_adjusted_category<-NULL
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","income_adjusted_category")],by="hh_id")
pop_7days$income_imputed<-dplyr::recode(pop_7days$income_imputed,  `3` = 4L,`7` = 6L,`8` = 6L)

income<-pop_7days %>%
  subset(income_imputed>0) %>%
  group_by(tnc_user,income_imputed,) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="income")
income_pop<-pop_7days %>%
  subset(income_imputed>0) %>%
  group_by(income_imputed,) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="income",tnc_user=3)
income_total<-rbind(income, income_pop)
```


## Student/Employment Status
```{r}

```
## Number of Commuter
num_workers+num_students
```{r}

summary(pop_7days$num)
pop_7days$num_commuter<-
```


## HH Vehicle/ num-commuter
```{r}
pop_7days<-merge(pop_7days,mpos4_hh[,c("hh_id","num_vehicles")],by="hh_id")
# summary(mpos4_hh$num_vehicles)
pop_7days$hhveh_recode<-ifelse(pop_7days$num_vehicles>=1| pop_7days$num_vehicles<995,1,0)

vehicle<-pop_7days %>%
  group_by(tnc_user,hhveh_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="vehicle")
vehicle_pop<-pop_7days %>%
  group_by(hhveh_recode) %>%
  summarise(n=n(),Count = sum(WEIGHT_PER)) %>%
  mutate(Percent = Count / sum(Count)*100, variable="vehicle",tnc_user=3)
vehicle_total<-rbind(vehicle, vehicle_pop)

# ggplot_veh<-ggplot(fre_perc_large, aes(x = reorder(mode, -perc), y=perc))+ 
#    geom_bar(stat="identity",colour="black", size=.2, alpha=1
#              ,width=0.6, position = position_dodge(width=0.7)) +
#   ylim(0, 80)+
#   scale_fill_brewer(palette="Greys")+
#   scale_x_discrete(limits=c(c("3","13","1","5","36","2","35","23","15","135","4")),
#     labels=c("Car\nOnly","Car+\nWalk","Walk\nOnly","Transit\nOnly","Car+\nOther","Bike\nOnly","Car+\nTransit","Car+\nBike","Transit+\nWalk","Car+\nTransit+\nWalk","TNC\nRelated"))+
#   geom_text(aes(label=Frequency), position = position_dodge(width = 0.7), vjust=-0.2,family = "Times") +
#   geom_text(aes(label=perc), position = position_dodge(width = 0.7), vjust=-1.5,family = "Times") +
#   labs(x="Panel 1: Modes in All Daily Trip Chain", y="Mode Share (%)") +
#   # ggtitle("Composition of Exports to China ($)") + 
#   # scale_fill_manual(values=fill) +
#   theme(panel.border = element_rect(colour = "black", fill=NA, size=.5), 
#     axis.text.x=element_text(colour="black", size = 14), 
#     axis.text.y=element_text(colour="black", size = 14),
#     axis.title=element_text(colour="black", size = 14),
#     legend.key=element_rect(fill="white", colour="white"),
#     legend.position="right", legend.direction="vertical", 
#     legend.title = element_blank(),
#     legend.text = element_text(colour="black", size = 14),
#     # panel.grid.major = element_line(colour = "#d3d3d3"), 
#     panel.grid.minor = element_blank(), 
#     panel.background = element_blank(),
#     plot.title = element_text(size = 14, family = "Times", face = "bold"), 
#     text=element_text(family="Times")) +
#   guides(fill = guide_legend(reverse=T))
# 

```

## Presence of children
```{r}

```


## Mode Share
```{r}
# mpos4_trip<-mpos4_trip1
# mpos4_trip$person_id<-as.numeric(mpos4_trip$person_id)
# mpos4_trip<-merge(mpos4_trip,pop_7days[,c("hh_id","person_id","tnc_user")],by=c("hh_id","person_id"))
mpos4_trip<-mpos4_trip[tnc_user>=0]
# mpos4_trip$tnc_user<-mpos4_trip$tnc_user.y
# mpos4_trip$tnc_user.x<-NULL
# mpos4_trip$tnc_user.y<-NULL


modeshare<-mpos4_trip %>%
  group_by(tnc_user,mode_recode) %>%
  summarise(n=n(),Frequency = sum(WEIGHT_TRIP)) %>%
  mutate(Percent = round(Frequency / sum(Frequency)*100,2))

modeshare<-modeshare %>%
    mutate (w=0,
            b=0,
            car=0,
            pt=0,
            # tnc_s=0,
            tnc=0,
            o=0)

for (i in (1:nrow(modeshare))){
  modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
  modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
  modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
  modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
  # modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
  modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
  modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
}

# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s

modeshare1<- melt(modeshare[,c(1,6:11)], id.vars=c("tnc_user")) %>%
  group_by(tnc_user,variable) %>%
  summarise(n=n(),Count=sum(value)) %>%
  mutate(Percent = round(Count / sum(Count)*100,2))
colnames(modeshare1)[2]<-"category"
modeshare1$variable<-"modeshare"

# # Total Trips
# 
# modeshare<-mpos4_trip %>%
#   group_by(mode_recode,tnc_user) %>%
#   mutate(count=1) %>%
#   summarise(Frequency=sum(count))
#   
#   
# 
# modeshare<-modeshare %>%
#     mutate (w=0,
#             b=0,
#             car=0,
#             pt=0,
#             tnc_s=0,
#             tnc=0,
#             o=0)
# 
# for (i in (1:nrow(modeshare))){
#   modeshare$w[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="w")*modeshare$Frequency[i]
#   modeshare$b[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="b")*modeshare$Frequency[i]
#   modeshare$car[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="r")*modeshare$Frequency[i]
#   modeshare$pt[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="p")*modeshare$Frequency[i]
#   modeshare$tnc_s[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="s")*modeshare$Frequency[i]
#   modeshare$tnc[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="n")*modeshare$Frequency[i]
#   modeshare$o[i]<- sum(unlist(strsplit(modeshare$mode_recode[i],""))=="o")*modeshare$Frequency[i]
# }
# 
# modeshare$tnc<-modeshare$tnc-modeshare$tnc_s
# 
# modeshare1<- melt(modeshare[,c(2,4:10)], id.vars=c("tnc_user")) %>%
#   group_by(variable,tnc_user) %>%
#   summarise(Count=sum(value)) %>%
#   mutate(Percent = round(Count / sum(Count)*100,2))
# 
# sum(modeshare[c(4:10)])
```

